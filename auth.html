<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>èª²ç¨‹æˆæ¬Šé©—è­‰ä¸­...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 50px; }
        .loading { font-size: 1.2em; color: #1a73e8; }
    </style>
</head>
<body>
    <div class="loading">
        <p>ğŸ”„ æ­£åœ¨æª¢æŸ¥æ‚¨çš„èª²ç¨‹æ¬Šé™ï¼Œè«‹ç¨å€™...</p>
        <p id="status-message">æ­£åœ¨é€£æ¥ Firebase æœå‹™...</p>
    </div>

    <script type="module">
        // 1. åŒ¯å…¥å¿…è¦çš„ Firebase å‡½å¼ (ä½¿ç”¨æ‚¨æŒ‡å®šçš„ 12.6.0 ç‰ˆæœ¬)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js"; 
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
        
        // **æ‚¨éœ€è¦é¡å¤–åŒ¯å…¥ Auth å’Œ Functions SDK**
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-functions.js";


        // 2. æ‚¨çš„ Firebase é…ç½® (å·²æ›´æ–°)
        const firebaseConfig = {
            apiKey: "AIzaSyBv2fciGdUD4CifE1fH3hnzzamPdrvjjN8",
            authDomain: "onlinelearning-b5cfc.firebaseapp.com",
            projectId: "onlinelearning-b5cfc",
            storageBucket: "onlinelearning-b5cfc.firebasestorage.app",
            messagingSenderId: "505254683984",
            appId: "1:505254683984:web:9653dfa4eef5489cedf855",
            measurementId: "G-P5LQ23Y31Q"
        };

        // 3. åˆå§‹åŒ– Firebase æœå‹™
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app); // åˆå§‹åŒ– Analytics
        const auth = getAuth(app);           // åˆå§‹åŒ– Authentication
        
        // åˆå§‹åŒ– Functions æœå‹™ (è«‹æ›¿æ›ç‚ºæ‚¨çš„ Cloud Function éƒ¨ç½²åœ°å€)
        // å‡è¨­æ‚¨éƒ¨ç½²åœ¨ 'asia-east1'ï¼Œå¦‚æœä¸æ˜¯ï¼Œè«‹ä¿®æ”¹ã€‚
        const functions = getFunctions(app, 'asia-east1'); 
        
        // ç¶å®šå¾Œç«¯ Cloud Function åç¨±
        const checkAuthFunction = httpsCallable(functions, 'checkPaymentAuthorization');

        // æ›´æ–°ç‹€æ…‹è¨Šæ¯
        document.getElementById('status-message').textContent = "æœå‹™å·²é€£ç·šï¼Œæª¢æŸ¥ç™»å…¥ç‹€æ…‹...";


        // 4. æˆæ¬Šæµç¨‹çš„æ ¸å¿ƒé‚è¼¯
        const urlParams = new URLSearchParams(window.location.search);
        const encodedTargetUrl = urlParams.get('url');

        if (!encodedTargetUrl) {
             document.getElementById('status-message').textContent = "éŒ¯èª¤ï¼šç¼ºå°‘ç›®æ¨™èª²ç¨‹é€£çµåƒæ•¸ã€‚";
             window.location.href = 'cart.html?error=invalid_link';
             return;
        }

        // ç›£è½ç”¨æˆ¶ç™»å…¥ç‹€æ…‹ï¼šFirebase Auth çš„æ¨™æº–æµç¨‹
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // å·²ç™»å…¥ï¼šåŸ·è¡Œ API é©—è­‰
                document.getElementById('status-message').textContent = `å·²ç™»å…¥ï¼š${user.email}ï¼Œæ­£åœ¨é©—è­‰èª²ç¨‹æ¬Šé™...`;
                await startAuthorizationFlow(user);
            } else {
                // æœªç™»å…¥ï¼šå¼•å°ç”¨æˆ¶ç™»å…¥
                document.getElementById('status-message').textContent = "åµæ¸¬åˆ°æ‚¨å°šæœªç™»å…¥ï¼Œè«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ã€‚";
                
                // åŸ·è¡Œ Google ç™»å…¥å½ˆçª—
                const provider = new GoogleAuthProvider();
                try {
                     await signInWithPopup(auth, provider);
                     // ç™»å…¥æˆåŠŸå¾Œï¼ŒonAuthStateChanged æœƒè‡ªå‹•å†æ¬¡è§¸ç™¼
                } catch (error) {
                     // è™•ç†ç”¨æˆ¶é—œé–‰å½ˆçª—æˆ–ç™»å…¥å¤±æ•—
                     console.error("ç™»å…¥å¤±æ•—:", error);
                     document.getElementById('status-message').textContent = "ç™»å…¥å¤±æ•—æˆ–å·²å–æ¶ˆï¼Œå°‡å°å›è³¼ç‰©è»Šã€‚";
                     
                     setTimeout(() => {
                         window.location.href = 'cart.html?error=login_failed';
                     }, 2000);
                }
            }
        });

        // å‘¼å« Cloud Function é€²è¡Œå¾Œç«¯é©—è­‰
        async function startAuthorizationFlow(user) {
            // ç”±æ–¼ç›®æ¨™ URL ä¾†è‡ªå‰ç«¯ï¼Œæˆ‘å€‘éœ€è¦å¾ URL ä¸­è§£ææˆ–å‡è¨­ courseId
            // é€™è£¡æ²¿ç”¨å‡è¨­ï¼šC1
            const courseId = 'C1'; 

            try {
                // å‘¼å«å¾Œç«¯ APIï¼ŒFirebase æœƒè‡ªå‹•å°‡ç•¶å‰ç™»å…¥ç”¨æˆ¶çš„ ID Token å‚³éçµ¦å¾Œç«¯ Function
                const result = await checkAuthFunction({ 
                    courseId: courseId,
                    targetUrl: encodedTargetUrl
                });

                const status = result.data.status;
                const redirectUrl = result.data.redirectUrl;

                document.getElementById('status-message').textContent = `é©—è­‰ç‹€æ…‹: ${status}ï¼Œæ­£åœ¨å°å‘...`;

                if (status === 'AUTHORIZED') {
                    document.getElementById('status-message').textContent = `âœ… æ¬Šé™é€šéï¼è·³è½‰è‡³èª²ç¨‹ï¼š${decodeURIComponent(redirectUrl)}`;
                    window.location.href = redirectUrl;
                } else {
                    document.getElementById('status-message').textContent = `âŒ æ¬Šé™ä¸è¶³ï¼Œè«‹å…ˆè³¼è²·èª²ç¨‹ã€‚`;
                    // å°å‘è³¼ç‰©è»Šé é¢ (ç”±å¾Œç«¯å›å‚³çš„è·¯å¾‘ï¼Œé€šå¸¸æ˜¯è³¼ç‰©è»Š)
                    setTimeout(() => {
                         window.location.href = redirectUrl;
                    }, 2000);
                }

            } catch (error) {
                // è™•ç†ç¶²è·¯é€£ç·šã€Function å…§éƒ¨éŒ¯èª¤ç­‰
                console.error("API å‘¼å«å¤±æ•—:", error);
                document.getElementById('status-message').textContent = "ç³»çµ±éŒ¯èª¤ï¼Œç„¡æ³•é©—è­‰æ¬Šé™ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚";
                setTimeout(() => {
                    window.location.href = 'cart.html?error=system_error';
                }, 3000);
            }
        }

    </script>
</body>
</html>