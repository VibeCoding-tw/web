<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>èª²ç¨‹æˆæ¬Šé©—è­‰ä¸­...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 50px; background-color: #f4f7f9; }
        .loading { font-size: 1.2em; color: #1a73e8; background-color: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); max-width: 400px; margin: 50px auto; }
        #status-message { margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="loading">
        <p>ğŸ”„ æ­£åœ¨æª¢æŸ¥æ‚¨çš„èª²ç¨‹æ¬Šé™ï¼Œè«‹ç¨å€™...</p>
        <p id="status-message">æ­£åœ¨é€£æ¥ Firebase æœå‹™...</p>
    </div>

    <script type="module">
        // 1. åŒ¯å…¥å¿…è¦çš„ Firebase å‡½å¼ (ä½¿ç”¨æ‚¨æŒ‡å®šçš„ 12.6.0 ç‰ˆæœ¬)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js"; 
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-functions.js";


        // 2. æ‚¨çš„ Firebase é…ç½®
        const firebaseConfig = {
          apiKey: "AIzaSyCO6Y6Pa7b7zbieJIErysaNF6-UqbT8KJw",
          authDomain: "e-learning-942f7.firebaseapp.com",
          projectId: "e-learning-942f7",
          storageBucket: "e-learning-942f7.firebasestorage.app",
          messagingSenderId: "878397058574",
          appId: "1:878397058574:web:28aaa07a291ee3baab165f"
        };

        // 3. åˆå§‹åŒ– Firebase æœå‹™
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);           
        
        // è«‹å°‡ 'asia-east1' æ›¿æ›ç‚ºæ‚¨çš„ Cloud Function éƒ¨ç½²åœ°å€
        const functions = getFunctions(app, 'asia-east1'); 
        const checkAuthFunction = httpsCallable(functions, 'checkPaymentAuthorization');

        // å®šç¾©è³¼ç‰©è»Šè·¯å¾‘ (åŒä¸€å±¤ç›®éŒ„)
        const CART_URL = 'cart.html'; 

        // æ›´æ–°ç‹€æ…‹è¨Šæ¯
        const statusMessageElement = document.getElementById('status-message');
        statusMessageElement.textContent = "æœå‹™å·²é€£ç·šï¼Œæª¢æŸ¥ç™»å…¥ç‹€æ…‹...";


        // 4. æˆæ¬Šæµç¨‹çš„æ ¸å¿ƒé‚è¼¯
        const urlParams = new URLSearchParams(window.location.search);
        
        // ç²å–èª²ç¨‹ ID (å‡è¨­èª²ç¨‹é é¢ç¾åœ¨å‚³éäº†é€™å€‹åƒæ•¸ï¼Œä¾‹å¦‚: auth.html?url=...&id=C2_L1)
        // ğŸš¨ é€™æ˜¯é‚è¼¯å„ªåŒ–é»ï¼Œæ‚¨éœ€è¦ç¢ºä¿æ‰€æœ‰èª²ç¨‹é é¢çš„è·³è½‰é€£çµéƒ½åŠ ä¸Š &id=CourseID
        const courseId = urlParams.get('id') || 'C_DEFAULT'; 
        const encodedTargetUrl = urlParams.get('url');

        // æª¢æŸ¥ç›®æ¨™ URL åƒæ•¸æ˜¯å¦å­˜åœ¨
        if (!encodedTargetUrl) {
             statusMessageElement.textContent = "éŒ¯èª¤ï¼šç¼ºå°‘ç›®æ¨™èª²ç¨‹é€£çµåƒæ•¸ã€‚";
             // ä¿®æ­£é» 1: å°å‘åŒä¸€å±¤ç›®éŒ„çš„ cart.html
             window.location.href = `${CART_URL}?error=invalid_link`;
        } else {
            // å¦‚æœ URL åƒæ•¸æ­£ç¢ºï¼Œé–‹å§‹ç›£è½ç™»å…¥ç‹€æ…‹
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // å·²ç™»å…¥ï¼šåŸ·è¡Œ API é©—è­‰
                    statusMessageElement.textContent = `å·²ç™»å…¥ï¼š${user.email}ï¼Œæ­£åœ¨é©—è­‰èª²ç¨‹æ¬Šé™...`;
                    await startAuthorizationFlow(user, courseId, encodedTargetUrl);
                } else {
                    // æœªç™»å…¥ï¼šå¼•å°ç”¨æˆ¶ç™»å…¥
                    statusMessageElement.textContent = "åµæ¸¬åˆ°æ‚¨å°šæœªç™»å…¥ï¼Œè«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ã€‚";
                    
                    const provider = new GoogleAuthProvider();
                    try {
                        await signInWithPopup(auth, provider);
                        // ç™»å…¥æˆåŠŸå¾Œï¼ŒonAuthStateChanged æœƒè‡ªå‹•å†æ¬¡è§¸ç™¼
                    } catch (error) {
                        console.error("ç™»å…¥å¤±æ•—:", error);
                        statusMessageElement.textContent = "ç™»å…¥å¤±æ•—æˆ–å·²å–æ¶ˆï¼Œå°‡å°å›è³¼ç‰©è»Šã€‚";
                        
                        setTimeout(() => {
                            // ä¿®æ­£é» 2: å°å‘åŒä¸€å±¤ç›®éŒ„çš„ cart.html
                            window.location.href = `${CART_URL}?error=login_failed`;
                        }, 2000);
                    }
                }
            });
        }
        
        // å‘¼å« Cloud Function é€²è¡Œå¾Œç«¯é©—è­‰ (åœ¨å‡½å¼å…§éƒ¨ï¼Œreturn èªå¥æ˜¯åˆæ³•çš„)
        async function startAuthorizationFlow(user, courseId, encodedTargetUrl) {
            
            try {
                // å‘¼å«å¾Œç«¯ APIï¼Œå‚³å…¥å¯¦éš›çš„ courseId
                const result = await checkAuthFunction({ 
                    courseId: courseId,
                    targetUrl: encodedTargetUrl
                });

                const status = result.data.status;
                const redirectUrl = result.data.redirectUrl; // æ‡‰æ˜¯å·²è§£ç¢¼çš„æœ€çµ‚ URL æˆ– cart.html

                statusMessageElement.textContent = `é©—è­‰ç‹€æ…‹: ${status}ï¼Œæ­£åœ¨å°å‘...`;

                if (status === 'AUTHORIZED') {
                    statusMessageElement.textContent = `âœ… æ¬Šé™é€šéï¼è·³è½‰è‡³èª²ç¨‹...`;
                    window.location.href = redirectUrl; // å°å‘èª²ç¨‹é€£çµ
                } else {
                    statusMessageElement.textContent = `âŒ æ¬Šé™ä¸è¶³ï¼Œè«‹å…ˆè³¼è²·èª²ç¨‹ã€‚`;
                    
                    // ä¿®æ­£é» 3: ç¢ºä¿é€™è£¡å°å‘çš„æ˜¯ Cloud Function å›å‚³çš„è·¯å¾‘ï¼ˆé æœŸæ˜¯ cart.htmlï¼‰
                    setTimeout(() => {
                         window.location.href = redirectUrl;
                    }, 2000);
                }

            } catch (error) {
                console.error("API å‘¼å«å¤±æ•—:", error);
                statusMessageElement.textContent = "ç³»çµ±éŒ¯èª¤ï¼Œç„¡æ³•é©—è­‰æ¬Šé™ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚";
                setTimeout(() => {
                    // ä¿®æ­£é» 4: å°å‘åŒä¸€å±¤ç›®éŒ„çš„ cart.html
                    window.location.href = `${CART_URL}?error=system_error`;
                }, 3000);
            }
        }
    </script>
</body>
</html>