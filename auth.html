<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>èª²ç¨‹æˆæ¬Šé©—è­‰ä¸­...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 50px; background-color: #f4f7f9; }
        .loading { font-size: 1.2em; color: #1a73e8; background-color: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); max-width: 400px; margin: 50px auto; }
        #status-message { margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="loading">
        <p>ğŸ”„ æ­£åœ¨æª¢æŸ¥æ‚¨çš„èª²ç¨‹æ¬Šé™ï¼Œè«‹ç¨å€™...</p>
        <p id="status-message">æ­£åœ¨é€£æ¥ Firebase æœå‹™...</p>
    </div>

    <script type="module">
        // 1. åŒ¯å…¥å¿…è¦çš„ Firebase å‡½å¼
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js"; 
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-functions.js";


        // 2. æ‚¨çš„ Firebase é…ç½®
        const firebaseConfig = {
          apiKey: "AIzaSyCO6Y6Pa7b7zbieJIErysaNF6-UqbT8KJw",
          authDomain: "e-learning-942f7.firebaseapp.com",
          projectId: "e-learning-942f7",
          storageBucket: "e-learning-942f7.firebasestorage.app",
          messagingSenderId: "878397058574",
          appId: "1:878397058574:web:28aaa07a291ee3baab165f"
        };
        
        // 3. éœæ…‹é…ç½®
        const CART_URL = 'cart.html'; 

        // 4. åˆå§‹åŒ– Firebase æœå‹™
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);           
        const functions = getFunctions(app, 'asia-east1'); 
        const checkAuthFunction = httpsCallable(functions, 'checkPaymentAuthorization');

        // æ›´æ–°ç‹€æ…‹è¨Šæ¯
        const statusMessageElement = document.getElementById('status-message');
        statusMessageElement.textContent = "æœå‹™å·²é€£ç·šï¼Œæª¢æŸ¥ç™»å…¥ç‹€æ…‹...";


        // 5. æˆæ¬Šæµç¨‹çš„æ ¸å¿ƒé‚è¼¯
        const urlParams = new URLSearchParams(window.location.search);
        
        // ç²å–èª²ç¨‹ IDã€ç›®æ¨™ URL
        const courseId = urlParams.get('id'); 
        const encodedTargetUrl = urlParams.get('url');
        const targetUrl = encodedTargetUrl ? decodeURIComponent(encodedTargetUrl) : null;
        
        // ğŸ’¥ ä¿®æ­£ï¼šç²å–èª²ç¨‹åƒ¹æ ¼ï¼Œä¸¦åˆ¤æ–·æ˜¯å¦ç‚ºå…è²» (åƒ¹æ ¼ç‚º '0')
        const coursePrice = urlParams.get('price');
        const isFreeCourse = coursePrice === '0'; 


        // æª¢æŸ¥æ ¸å¿ƒåƒæ•¸æ˜¯å¦å­˜åœ¨ (coursePrice éºå¤±æ™‚ä¸è¦–ç‚ºéŒ¯èª¤ï¼Œå› ç‚ºå®ƒå¯ä»¥èµ° CF æª¢æŸ¥ï¼Œä½† courseId å’Œ url å¿…é ˆæœ‰)
        if (!encodedTargetUrl || !courseId) {
             statusMessageElement.textContent = "éŒ¯èª¤ï¼šç¼ºå°‘ç›®æ¨™èª²ç¨‹é€£çµæˆ–èª²ç¨‹ ID åƒæ•¸ã€‚";
             setTimeout(() => {
                 window.location.href = `${CART_URL}?error=invalid_link`;
             }, 2000);
        } else {
            // å¦‚æœ URL åƒæ•¸æ­£ç¢ºï¼Œé–‹å§‹ç›£è½ç™»å…¥ç‹€æ…‹
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    // å·²ç™»å…¥ï¼šåŸ·è¡Œæˆæ¬Šé©—è­‰æˆ–ç›´æ¥è·³è½‰
                    statusMessageElement.textContent = `å·²ç™»å…¥ï¼š${user.email}ï¼Œæ­£åœ¨é©—è­‰èª²ç¨‹æ¬Šé™...`;
                    await startAuthorizationFlow(user, courseId, encodedTargetUrl, targetUrl, isFreeCourse);
                } else {
                    // æœªç™»å…¥ï¼šå¼•å°ç”¨æˆ¶ç™»å…¥
                    statusMessageElement.textContent = "åµæ¸¬åˆ°æ‚¨å°šæœªç™»å…¥ï¼Œæ­£åœ¨å¼•å°ç™»å…¥...";
                    
                    const provider = new GoogleAuthProvider();
                    try {
                        // å˜—è©¦ç™»å…¥ (æˆåŠŸå¾Œæœƒé‡æ–°è§¸ç™¼ onAuthStateChanged)
                        await signInWithPopup(auth, provider);
                    } catch (error) {
                        // ç™»å…¥å¤±æ•—æˆ–å·²å–æ¶ˆ
                        console.error("ç™»å…¥å¤±æ•—:", error);
                        statusMessageElement.textContent = "ç™»å…¥å¤±æ•—æˆ–å·²å–æ¶ˆï¼Œå°‡å°å›è³¼ç‰©è»Šã€‚";
                        
                        setTimeout(() => {
                            window.location.href = `${CART_URL}?error=login_failed`;
                        }, 2000);
                    }
                }
            });
        }
        
        // å‘¼å« Cloud Function é€²è¡Œå¾Œç«¯é©—è­‰ (æˆ–è·³é)
        async function startAuthorizationFlow(user, courseId, encodedTargetUrl, targetUrl, isFreeCourse) {
            
            // ğŸ’¥ ä¿®æ­£ 1ï¼šå¦‚æœåƒ¹æ ¼æ˜ç¢ºç‚º '0' (ä¾†è‡ª basic.html)ï¼Œç›´æ¥å°å‘
            if (isFreeCourse) { 
                statusMessageElement.textContent = `ğŸ‰ ç›´æ¥è·³è½‰è‡³å…è²»èª²ç¨‹...`;
                setTimeout(() => {
                    window.location.href = targetUrl; 
                    //window.open(targetUrl, '_blank');
                }, 1000);
                return; 
            }

            // --- æ”¶è²»èª²ç¨‹ (åƒ¹æ ¼ > 0 æˆ– price åƒæ•¸éºå¤±) æ‰æœƒèµ°åˆ°é€™è£¡ ---
            try {
                // å‘¼å«å¾Œç«¯ APIï¼Œå‚³å…¥å¯¦éš›çš„ courseId
                const result = await checkAuthFunction({ 
                    courseId: courseId,
                    targetUrl: encodedTargetUrl // å‚³é encoded URL çµ¦ CF
                });

                const status = result.data.status;
                const redirectUrl = result.data.redirectUrl; 

                statusMessageElement.textContent = `é©—è­‰ç‹€æ…‹: ${status}ï¼Œæ­£åœ¨å°å‘...`;

                if (status === 'AUTHORIZED') {
                    statusMessageElement.textContent = `âœ… æ¬Šé™é€šéï¼è·³è½‰è‡³èª²ç¨‹...`;
                    setTimeout(() => {
                        //window.location.href = redirectUrl; // å°å‘èª²ç¨‹é€£çµ
                        window.open(targetUrl, '_blank');
                    }, 1000);
                } else {
                    statusMessageElement.textContent = `âŒ æ¬Šé™ä¸è¶³ï¼Œè«‹å…ˆè³¼è²·èª²ç¨‹ã€‚`;
                    
                    setTimeout(() => {
                         // å°å‘ Cloud Function å›å‚³çš„è·¯å¾‘ (é æœŸæ˜¯ cart.html)
                         window.location.href = redirectUrl;
                    }, 2000);
                }

            } catch (error) {
                // API å‘¼å«å¤±æ•—ï¼Œå°å‘è³¼ç‰©è»Š
                console.error("æ”¶è²»èª²ç¨‹ API å‘¼å«å¤±æ•—:", error);
                statusMessageElement.textContent = "ç³»çµ±éŒ¯èª¤ï¼Œç„¡æ³•é©—è­‰æ¬Šé™ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚";
                setTimeout(() => {
                    window.location.href = `${CART_URL}?error=system_error`;
                }, 3000);
            }
        }
    </script>
</body>
</html>