<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>èª²ç¨‹æˆæ¬Šé©—è­‰ä¸­...</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 50px; }
        .loading { font-size: 1.2em; color: #1a73e8; }
    </style>
</head>
<body>
    <div class="loading">
        <p>ğŸ”„ æ­£åœ¨æª¢æŸ¥æ‚¨çš„èª²ç¨‹æ¬Šé™ï¼Œè«‹ç¨å€™...</p>
        <p id="status-message">æ­£åœ¨é€£æ¥ Firebase æœå‹™...</p>
    </div>

    <script type="module">
        // 1. åŒ¯å…¥å¿…è¦çš„ Firebase å‡½å¼
        // åŸºç¤ï¼šinitializeApp
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js"; 
        
        // é©—è­‰ï¼šgetAuth
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
        
        // Functionsï¼šgetFunctions, httpsCallable (ç”¨æ–¼å‘¼å«å¾Œç«¯ API)
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-functions.js";


        // 2. æ‚¨çš„ Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyDeNFLKlqayaJk8C0hwV4514tCy02iRUiE",
            authDomain: "coffee-spark-ai-barista-184bd.firebaseapp.com",
            projectId: "coffee-spark-ai-barista-184bd",
            storageBucket: "coffee-spark-ai-barista-184bd.firebasestorage.app",
            messagingSenderId: "980857404578",
            appId: "1:980857404578:web:b4ce557fdf9ab1bca76bfb"
        };

        // 3. åˆå§‹åŒ– Firebase æœå‹™
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const functions = getFunctions(app, 'asia-east1'); // **è«‹å°‡åœ°å€æ›¿æ›ç‚ºæ‚¨çš„ Cloud Function éƒ¨ç½²åœ°å€**
        const checkAuthFunction = httpsCallable(functions, 'checkPaymentAuthorization');

        // æ›´æ–°ç‹€æ…‹è¨Šæ¯
        document.getElementById('status-message').textContent = "æœå‹™å·²é€£ç·šï¼Œæª¢æŸ¥ç™»å…¥ç‹€æ…‹...";


        // 4. æˆæ¬Šæµç¨‹çš„æ ¸å¿ƒé‚è¼¯ (è«‹åƒè€ƒä¸Šä¸€å€‹å›è¦†çš„é‚è¼¯)
        const urlParams = new URLSearchParams(window.location.search);
        const encodedTargetUrl = urlParams.get('url');

        if (!encodedTargetUrl) {
             document.getElementById('status-message').textContent = "éŒ¯èª¤ï¼šç¼ºå°‘ç›®æ¨™èª²ç¨‹é€£çµåƒæ•¸ã€‚";
             window.location.href = '../dynamic_shopping_cart.html?error=invalid_link';
             return;
        }

        // ç›£è½ç”¨æˆ¶ç™»å…¥ç‹€æ…‹
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // å·²ç™»å…¥ï¼šåŸ·è¡Œ API é©—è­‰
                document.getElementById('status-message').textContent = `å·²ç™»å…¥ï¼š${user.email}ï¼Œæ­£åœ¨é©—è­‰èª²ç¨‹æ¬Šé™...`;
                await startAuthorizationFlow(user);
            } else {
                // æœªç™»å…¥ï¼šå¼·åˆ¶ç”¨æˆ¶ç™»å…¥
                document.getElementById('status-message').textContent = "åµæ¸¬åˆ°æ‚¨å°šæœªç™»å…¥ï¼Œè«‹ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ã€‚";
                
                // åŸ·è¡Œ Google ç™»å…¥å½ˆçª—
                const provider = new GoogleAuthProvider();
                try {
                     await signInWithPopup(auth, provider);
                     // ç™»å…¥æˆåŠŸå¾Œï¼ŒonAuthStateChanged æœƒå†æ¬¡è§¸ç™¼ï¼Œé€²å…¥ä¸Šé¢çš„ if (user) å€å¡Š
                } catch (error) {
                     console.error("ç™»å…¥å¤±æ•—:", error);
                     document.getElementById('status-message').textContent = "ç™»å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æˆæ¬Šç‹€æ…‹ã€‚";
                     // ç™»å…¥å¤±æ•—å°å›è³¼ç‰©è»Š
                     setTimeout(() => {
                         window.location.href = '../dynamic_shopping_cart.html?error=login_failed';
                     }, 2000);
                }
            }
        });

        // å‘¼å« Cloud Function é€²è¡Œå¾Œç«¯é©—è­‰
        async function startAuthorizationFlow(user) {
            // é€™è£¡å‡è¨­æ‰€æœ‰èª²ç¨‹éƒ½ä½¿ç”¨ ID: C1 (æ‚¨éœ€è¦æ ¹æ“šå¯¦éš›æƒ…æ³ä¿®æ”¹)
            const courseId = 'C1'; 

            try {
                const result = await checkAuthFunction({ 
                    courseId: courseId,
                    targetUrl: encodedTargetUrl
                });

                const status = result.data.status;
                const redirectUrl = result.data.redirectUrl;

                document.getElementById('status-message').textContent = `é©—è­‰æˆåŠŸï¼Œæ­£åœ¨å°å‘èª²ç¨‹...`;

                if (status === 'AUTHORIZED') {
                    document.getElementById('status-message').textContent = `âœ… æ¬Šé™é€šéï¼Œå³å°‡è·³è½‰ã€‚`;
                    window.location.href = redirectUrl;
                } else {
                    document.getElementById('status-message').textContent = `âŒ æ¬Šé™ä¸è¶³ï¼Œè«‹å…ˆè³¼è²·èª²ç¨‹ã€‚`;
                    // å°å‘è³¼ç‰©è»Šé é¢
                    setTimeout(() => {
                         window.location.href = redirectUrl;
                    }, 2000);
                }

            } catch (error) {
                console.error("API å‘¼å«å¤±æ•—:", error);
                document.getElementById('status-message').textContent = "ç³»çµ±éŒ¯èª¤ï¼Œç„¡æ³•é©—è­‰æ¬Šé™ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚";
                setTimeout(() => {
                    window.location.href = '../dynamic_shopping_cart.html?error=system_error';
                }, 3000);
            }
        }

    </script>
</body>
</html>