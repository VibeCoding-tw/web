<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>BLE èªéŸ³æ§åˆ¶ (STT)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ç¢ºä¿å…¨è¢å¹•é«˜åº¦å’ŒæŸ”è»Ÿçš„èƒŒæ™¯è‰² */
    body { 
        background-color: #1f2937; 
        color: #f9fafb; 
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        display: flex; 
        justify-content: center; 
        align-items: center; 
        min-height: 100vh; 
        margin: 0; 
        padding: 1rem;
    }
    .container-wrap { 
        max-width: 400px; 
        width: 100%; 
        padding: 30px; 
        background-color: #2d3748; /* ç¨æ·ºçš„æ·±è‰²å¡ç‰‡èƒŒæ™¯ */
        border-radius: 1.5rem;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    /* é ‚éƒ¨æ§åˆ¶åˆ— */
    .top{width:100%;display:flex;gap:12px;align-items:center; max-width: 520px; margin-bottom: 30px;}
    
    /* åŸºæœ¬æŒ‰éˆ•æ¨£å¼ */
    .base-button{
        padding:12px 16px;
        border-radius:14px;
        border:none;
        font-weight:700;
        box-shadow: 4px 4px 8px #1a202c, -4px -4px 8px #3b4555; 
        transition: all 0.2s ease-in-out;
        cursor: pointer;
    }
    .base-button:active {
        box-shadow: inset 3px 3px 6px #1a202c, inset -3px -3px 6px #3b4555;
        transform: translateY(1px);
    }
    
    /* é€£ç·šæŒ‰éˆ• */
    #btnConnect{
        flex: 1;
        background:#4f46e5;
        color:white;
    }
    #btnConnect:hover { background: #3730a3; }
    
    /* éº¥å…‹é¢¨æŒ‰éˆ• - è—ç‰™é€£ç·šæˆåŠŸå¾Œæ‰å•Ÿç”¨ */
    #btnMic {
        background: #f59e0b; /* ç¥ç€è‰² */
        color: #1f2937;
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 2rem;
        box-shadow: 6px 6px 12px #1a202c, -6px -6px 12px #3b4555;
        transition: all 0.2s ease-in-out;
    }

    #btnMic.listening {
        background: #ef4444; /* ç´…è‰² */
        color: white;
        animation: pulse 1.5s infinite;
        box-shadow: 0 0 15px #ef4444, 0 0 25px rgba(239, 68, 68, 0.7);
    }
    
    #btnMic:disabled {
        background: #6b7280;
        cursor: not-allowed;
        box-shadow: none;
        animation: none;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    #status{flex:1;text-align:center;font-weight:700;color:#f9fafb; padding: 12px; background: #374151; border-radius: 14px; box-shadow: inset 3px 3px 6px #1a202c, inset -3px -3px 6px #3b4555;}

    /* ç‹€æ…‹æ–‡å­— */
    #currentCommand{ 
        font-weight: 800; 
        font-size: 2.25rem; /* å¤§å­—é«”é¡¯ç¤ºç•¶å‰æŒ‡ä»¤ */
        margin-top: 20px;
        min-height: 4rem;
    }
    .info{font-size:14px;color:#9ca3af; margin-top: 20px; line-height: 1.5;}
  </style>
</head>
<body class="p-4">
    <div class="container-wrap">
        
        <h1 class="text-3xl font-extrabold text-center text-indigo-400 mb-8">BLE èªéŸ³æ§åˆ¶</h1>

        <div class="top">
            <button id="btnConnect" class="base-button">é€£ç·š BLE</button>
            <div id="status">æœªé€£ç·š</div>
        </div>
        
        <!-- éº¥å…‹é¢¨æŒ‰éˆ• -->
        <button id="btnMic" class="base-button" disabled aria-label="Start Speech Recognition">
            <!-- Font Awesome éº¥å…‹é¢¨åœ–ç¤º (ä½¿ç”¨ SVG æ›¿ä»£) -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512" fill="currentColor" width="32" height="32">
                <path d="M192 0C140.2 0 96 44.2 96 96v224c0 51.8 44.2 96 96 96s96-44.2 96-96V96c0-51.8-44.2-96-96-96zm128 224h-32c0 83.2-68.8 152-152 152S32 307.2 32 224H0c0 98.4 80 179.2 176 192V480h-64v32h192v-32h-64V416c96-12.8 176-93.6 176-192h-32z"/>
            </svg>
        </button>

        <!-- ç•¶å‰èªéŸ³æŒ‡ä»¤ -->
        <p class="text-xl mt-6">ç•¶å‰æŒ‡ä»¤:</p>
        <p id="currentCommand" class="text-green-400">è«‹é€£ç·š</p>

        <!-- é¦¬é”æ•¸å€¼é¡¯ç¤º -->
        <div class="text-center space-y-2 mt-4">
            <p class="text-base text-gray-400">
                Payload: T (é€Ÿåº¦) = <span id="val_t" class="font-mono text-lg text-yellow-300">0</span>, 
                S (è½‰å‘) = <span id="val_s" class="font-mono text-lg text-yellow-300">0</span>
            </p>
        </div>
        
        <div class="info text-center">
            <p>å¯ç”¨çš„èªéŸ³æŒ‡ä»¤ï¼š**å‰é€²**, **å¾Œé€€**, **å·¦è½‰**, **å³è½‰**, **åœæ­¢**ã€‚</p>
            <p>è«‹å…ˆé€£ç·š BLEï¼Œç„¶å¾ŒæŒ‰éº¥å…‹é¢¨æŒ‰éˆ•é–‹å§‹èªªè©±ã€‚ç‚ºç¢ºä¿å®‰å…¨ï¼Œè‹¥ç„¡æ–°æŒ‡ä»¤ï¼Œé¦¬é”å°‡åœ¨ 1 ç§’å¾Œè‡ªå‹•åœæ­¢ã€‚</p>
        </div>

    </div>

<script>
// --- BLE & Control Configuration ---
// è«‹ç¢ºä¿é€™äº› UUID èˆ‡æ‚¨çš„ ESP32 Arduino ç¨‹å¼ç¢¼ä¸­å®šç¾©çš„ UUID ä¸€è‡´
const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-000000000000'; 
const CHARACTERISTIC_UUID = '4fafc201-1fb5-459e-8fcc-000000000000'; 
const DEVICE_ID_KEY = 'ble_voice_control_device_id'; 
const MAX_CONTROL_VALUE = 255; 
const SEND_INTERVAL_MS = 60;
const STOP_TIMEOUT_MS = 1000; // 1ç§’å¾Œè‡ªå‹•åœæ­¢ (ç”¨æ–¼å®‰å…¨)

// --- DOM Elements ---
const statusEl = document.getElementById('status'); // BLE é€£ç·šç‹€æ…‹
const currentCommandEl = document.getElementById('currentCommand'); // ç•¶å‰èªéŸ³æŒ‡ä»¤
const valTEl = document.getElementById('val_t'); // T (Throttle)
const valSEl = document.getElementById('val_s'); // S (Steer)
const btnConnect = document.getElementById('btnConnect');
const btnMic = document.getElementById('btnMic');

// --- Control Command Mapping ---
const COMMAND_MAP = {
    // T, S å€¼
    "å‰é€²": { t: 200, s: 0 },
    "å‰é€²ä¸€é»": { t: 100, s: 0 },
    "å¾Œé€€": { t: -200, s: 0 },
    "å¾Œé€€ä¸€é»": { t: -100, s: 0 },
    "å·¦è½‰": { t: 0, s: -150 },
    "å³è½‰": { t: 0, s: 150 },
    "åœæ­¢": { t: 0, s: 0 },
    "åœ": { t: 0, s: 0 } // å®¹è¨±ç°¡ç¨±
};

// --- State Variables ---
let device = null;
let characteristic = null;
let sendingInterval = null;
let stopTimer = null; // å®‰å…¨åœæ­¢è¨ˆæ™‚å™¨
let isListening = false;
let lastPayload = { t: 0, s: 0 }; // å„²å­˜ä¸Šæ¬¡ç™¼é€çš„æ•´æ•¸ T, S å€¼


// --- Speech Recognition Setup ---
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition;

if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = 'zh-TW'; // è¨­å®šç‚ºå°ç£ä¸­æ–‡
    recognition.interimResults = false; // åªè¿”å›æœ€çµ‚çµæœ
    recognition.continuous = false; // æ¯æ¬¡åªè½ä¸€å€‹æŒ‡ä»¤

    recognition.onstart = () => {
        isListening = true;
        btnMic.classList.add('listening');
        currentCommandEl.textContent = 'ğŸ‘‚ è†è½ä¸­... è«‹èªªæŒ‡ä»¤';
        currentCommandEl.className = 'text-xl mt-6 text-yellow-400 font-extrabold';
    };

    recognition.onresult = (event) => {
        // å–å¾—è¾¨è­˜çµæœ
        const transcript = event.results[0][0].transcript.trim();
        processCommand(transcript);
    };

    recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        if (event.error !== 'no-speech') { // é¿å…é »ç¹é¡¯ç¤º no-speech éŒ¯èª¤
             currentCommandEl.textContent = `âŒ è¾¨è­˜éŒ¯èª¤: ${event.error}`;
             currentCommandEl.className = 'text-xl mt-6 text-red-400 font-extrabold';
        }
        
        // éŒ¯èª¤ç™¼ç”Ÿå¾Œè‡ªå‹•é‡æ–°å•Ÿå‹•ï¼Œä»¥ä¾¿æŒçºŒæ¥æ”¶æŒ‡ä»¤
        if (isListening && device && device.gatt.connected) {
            setTimeout(() => {
                recognition.start();
            }, 500);
        }
    };

    recognition.onend = () => {
        btnMic.classList.remove('listening');
        
        // ç¢ºä¿åœ¨æ”¶åˆ°æŒ‡ä»¤å¾Œï¼Œè‹¥æ²’æœ‰æ–°çš„æŒ‡ä»¤ï¼ŒSTT æœƒè‡ªå‹•é‡æ–°å•Ÿå‹•
        if (isListening && device && device.gatt.connected) {
             // åªæœ‰åœ¨ä¸æ˜¯ä¸»å‹•åœæ­¢çš„æƒ…æ³ä¸‹æ‰é‡å•Ÿ
             if (currentCommandEl.textContent !== 'å·²åœæ­¢è†è½' && currentCommandEl.textContent.indexOf('éŒ¯èª¤') === -1) {
                  recognition.start();
             }
        } else {
             isListening = false;
             // å¦‚æœ BLE æ–·ç·šï¼Œå‰‡ä¿æŒåœæ­¢ç‹€æ…‹
             if (!device || !device.gatt.connected) {
                  currentCommandEl.textContent = 'è«‹é€£ç·š';
                  currentCommandEl.className = 'text-xl mt-6 text-green-400 font-extrabold';
             }
        }
    };

    btnMic.onclick = () => {
        if (!device || !device.gatt.connected) {
            currentCommandEl.textContent = 'è«‹å…ˆé€£ç·šè‡³ BLE è£ç½®';
            currentCommandEl.className = 'text-xl mt-6 text-red-400 font-extrabold';
            return;
        }

        if (isListening) {
             // ä¸»å‹•åœæ­¢
             recognition.stop(); 
             isListening = false;
             currentCommandEl.textContent = 'å·²åœæ­¢è†è½';
             currentCommandEl.className = 'text-xl mt-6 text-indigo-400 font-extrabold';
             // åœæ­¢é¦¬é”
             stopMotors();
        } else {
             // é–‹å§‹è†è½
             recognition.start();
        }
    };

} else {
    // ç€è¦½å™¨ä¸æ”¯æ´ SpeechRecognition çš„ fallback
    window.onload = () => {
        btnMic.disabled = true;
        currentCommandEl.textContent = 'âŒ ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜';
        currentCommandEl.className = 'text-xl mt-6 text-red-400 font-extrabold';
    };
}


/**
 * @brief è™•ç†è¾¨è­˜åˆ°çš„èªéŸ³æŒ‡ä»¤ï¼Œä¸¦æ›´æ–°é¦¬é”æ•¸å€¼ã€‚
 * @param {string} command èªéŸ³è¾¨è­˜çµæœ
 */
function processCommand(command) {
    const matchedCommand = Object.keys(COMMAND_MAP).find(key => command.includes(key));
    
    // æ¸…é™¤å®‰å…¨åœæ­¢è¨ˆæ™‚å™¨
    if (stopTimer) clearTimeout(stopTimer);

    if (matchedCommand) {
        const payload = COMMAND_MAP[matchedCommand];
        lastPayload.t = payload.t;
        lastPayload.s = payload.s;
        
        // æ›´æ–° UI
        currentCommandEl.textContent = `âœ… åŸ·è¡ŒæŒ‡ä»¤: ${matchedCommand}`;
        currentCommandEl.className = 'text-xl mt-6 text-green-400 font-extrabold';
        updateUI();

        // ç«‹å³åŸ·è¡Œåœæ­¢å‹•ä½œï¼Œæˆ–åœ¨å»¶é²å¾Œè‡ªå‹•åœæ­¢
        if (matchedCommand === 'åœæ­¢' || matchedCommand === 'åœ') {
            stopMotors();
        } else {
            // å®‰å…¨æ©Ÿåˆ¶ï¼šå¦‚æœ 1 ç§’å…§æ²’æœ‰æ–°æŒ‡ä»¤ï¼Œè‡ªå‹•åœæ­¢
            stopTimer = setTimeout(stopMotors, STOP_TIMEOUT_MS);
        }
        
    } else {
        currentCommandEl.textContent = `ğŸ¤” ç„¡æ³•è¾¨è­˜æŒ‡ä»¤: "${command}"`;
        currentCommandEl.className = 'text-xl mt-6 text-yellow-400 font-extrabold';
        // æ”¶åˆ°ç„¡æ³•è¾¨è­˜çš„æŒ‡ä»¤å¾Œï¼Œå»¶é²åœæ­¢ (é˜²æ­¢é¦¬é”ç©ºè½‰)
        stopTimer = setTimeout(stopMotors, STOP_TIMEOUT_MS);
    }
}

/**
 * åœæ­¢é¦¬é”ä¸¦æ¸…é™¤æ‰€æœ‰è¨ˆæ™‚å™¨
 */
function stopMotors() {
    lastPayload.t = 0;
    lastPayload.s = 0;
    
    // æ¸…é™¤æ‰€æœ‰è¨ˆæ™‚å™¨
    if (stopTimer) clearTimeout(stopTimer);
    stopTimer = null;
    
    // æ›´æ–° UI ç‚ºéœæ­¢
    currentCommandEl.textContent = 'ğŸ˜´ éœæ­¢ (è‡ªå‹•åœæ­¢)';
    currentCommandEl.className = 'text-xl mt-6 text-indigo-400 font-extrabold';
    updateUI();
    
    // ç«‹å³ç™¼é€ä¸€æ¬¡åœæ­¢å‘½ä»¤
    sendControl(); 
}

/**
 * æ›´æ–° T/S æ•¸å€¼é¡¯ç¤º
 */
function updateUI() {
    valTEl.textContent = lastPayload.t;
    valSEl.textContent = lastPayload.s;
}

// --- BLE Connection Logic ---

/**
 * è™•ç† BLE æ–·ç·š
 */
function onDisconnect() {
    statusEl.textContent = 'âŒ å·²æ–·ç·š';
    btnConnect.textContent = 'é€£ç·š BLE'; 
    btnMic.disabled = true; // æ–·ç·šå¾Œç¦ç”¨éº¥å…‹é¢¨
    
    if (sendingInterval) clearInterval(sendingInterval);
    sendingInterval = null;
    
    if (isListening && recognition) recognition.stop();
    isListening = false;
    
    stopMotors(); // æ–·ç·šæ™‚åœæ­¢é¦¬é”
    if (device) device.removeEventListener('gattserverdisconnected', onDisconnect);
    device = null;
    characteristic = null;
    
    currentCommandEl.textContent = 'è«‹é€£ç·š';
    currentCommandEl.className = 'text-xl mt-6 text-green-400 font-extrabold';
}

/**
 * å–å¾—è£ç½®ç‰©ä»¶ (é€éæƒææˆ–å¿«é€Ÿé‡é€£)
 */
async function acquireDevice() {
    const storedDeviceId = localStorage.getItem(DEVICE_ID_KEY);

    if (storedDeviceId) {
        statusEl.textContent = 'å˜—è©¦ä½¿ç”¨ ID å¿«é€Ÿé€£ç·š...';
        try {
            const devices = await navigator.bluetooth.getDevices();
            const knownDevice = devices.find(d => d.id === storedDeviceId);

            if (knownDevice) {
                 statusEl.textContent = `å·²æ‰¾åˆ°å„²å­˜çš„è£ç½®: ${knownDevice.name}`;
                 return knownDevice;
            }
        } catch (e) {
            console.warn("Could not retrieve known device:", e);
        }
    }
    
    statusEl.textContent = 'æƒæä¸­ (éæ¿¾: esp32)...';
    const newDevice = await navigator.bluetooth.requestDevice({
        filters:[{ namePrefix: 'esp32' }],
        optionalServices: [SERVICE_UUID] 
    });
    
    localStorage.setItem(DEVICE_ID_KEY, newDevice.id);
    return newDevice;
}


async function connectBLE(){
    if (!navigator.bluetooth) {
        statusEl.textContent = 'âŒ ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothã€‚';
        return;
    }
    
    // è™•ç†å·²é€£ç·šç‹€æ…‹ä¸‹çš„æŒ‰éˆ•é»æ“Š (æ–·é–‹é€£ç·š)
    if (device && device.gatt.connected) {
        statusEl.textContent = 'ä¸­æ–·é€£ç·šä¸­...';
        device.gatt.disconnect();
        return;
    }

    try{
        if (!device) {
             device = await acquireDevice();
        } 
        
        if (!device) throw new Error("è£ç½®æœªé€£ç·šæˆ–æœªæ‰¾åˆ°ã€‚");

        statusEl.textContent = `é€£ç·šåˆ° ${device.name}...`;

        device.removeEventListener('gattserverdisconnected', onDisconnect);
        device.addEventListener('gattserverdisconnected', onDisconnect);

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID); 
        
        statusEl.textContent = 'âœ… å·²é€£ç·š: ' + device.name;
        btnConnect.textContent = 'æ–·é–‹'; 
        btnMic.disabled = false; // é€£ç·šæˆåŠŸå¾Œå•Ÿç”¨éº¥å…‹é¢¨æŒ‰éˆ•
        currentCommandEl.textContent = 'è«‹æŒ‰éº¥å…‹é¢¨é–‹å§‹èªªè©±';
        currentCommandEl.className = 'text-xl mt-6 text-indigo-400 font-extrabold';

        // é–‹å§‹å®šæœŸå‚³é€
        if (!sendingInterval) {
             sendingInterval = setInterval(sendControl, SEND_INTERVAL_MS); 
        }

    }catch(err){
        console.error('BLE é€£ç·šå¤±æ•—:', err);
        statusEl.textContent = `âŒ é€£ç·šå¤±æ•— (${err.message.slice(0, 30)}...)`;
        btnConnect.textContent = 'é€£ç·š BLE';
        btnMic.disabled = true;
        
        if (device && (!device.gatt || !device.gatt.connected)) {
            device = null;
            localStorage.removeItem(DEVICE_ID_KEY);
        }
    }
}


/**
 * å®šæœŸå‘ BLE è£ç½®å‚³é€æ§åˆ¶æŒ‡ä»¤
 * Payload æ ¼å¼ï¼šæ•´æ•¸ "T,S" å­—ä¸² (ä¾‹å¦‚: "200,0")
 */
async function sendControl(){
  if(!characteristic || !device || !device.gatt.connected) {
    if (sendingInterval) clearInterval(sendingInterval);
    sendingInterval = null;
    return;
  }
  
  const t_int = lastPayload.t;
  const s_int = lastPayload.s;
  
  const payload = `${t_int},${s_int}`;
  
  try{
    await characteristic.writeValue(new TextEncoder().encode(payload));
  }catch(err){
    console.warn('send failed (å¯èƒ½å·²æ–·ç·š):', err.message);
    // å¦‚æœå¯«å…¥å¤±æ•—ï¼Œå¼·åˆ¶æ–·é–‹é€£ç·šä»¥æ›´æ–°ç‹€æ…‹
    if (device && device.gatt.connected) {
         device.gatt.disconnect();
    }
  }
}

// --- Initialization ---

btnConnect.addEventListener('click', connectBLE);
stopMotors(); // ç¢ºä¿åˆå§‹ç‹€æ…‹ç‚ºéœæ­¢
</script>
</body>
</html>