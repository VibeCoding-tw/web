<!doctype html>
<html lang="zh-Hant">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
Â  <title>BLE èªéŸ³æ§åˆ¶ (Mobile)</title>
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <style>
Â  Â  /* ç¢ºä¿å…¨è¢å¹•é«˜åº¦å’ŒæŸ”è»Ÿçš„èƒŒæ™¯è‰² */
Â  Â  body {Â 
Â  Â  Â  Â  background-color: #1f2937;Â 
Â  Â  Â  Â  color: #f9fafb;Â 
Â  Â  Â  Â  font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  min-height: 100vh;Â 
Â  Â  Â  Â  margin: 0;Â 
Â  Â  Â  Â  padding: 1rem;
Â  Â  }
Â  Â  .container-wrap {Â 
Â  Â  Â  Â  max-width: 400px;Â 
Â  Â  Â  Â  width: 100%;Â 
Â  Â  Â  Â  padding: 20px;Â 
Â  Â  Â  Â  background-color: #1f2937; /* èˆ‡ body èƒŒæ™¯ä¸€è‡´ */
Â  Â  Â  Â  border-radius: 1rem;
Â  Â  Â  Â  box-shadow: 10px 10px 20px #171d26, -10px -10px 20px #273142;
Â  Â  }
Â  Â Â 
Â  Â  /* é ‚éƒ¨æ§åˆ¶åˆ— */
Â  Â  .top{width:100%;display:flex;gap:8px;align-items:center; max-width: 520px; margin-bottom: 20px;}
Â  Â  button{padding:10px 14px;border-radius:12px;border:none;background:#4f46e5;color:white;font-weight:700;box-shadow: 3px 3px 6px #1a202c, -3px -3px 6px #273142; transition: all 0.15s ease-in-out; white-space: nowrap;}
Â  Â  button:hover { background: #3730a3; box-shadow: 5px 5px 10px #1a202c, -5px -5px 10px #273142;}

Â  Â  #status{flex:1;text-align:center;font-weight:700;color:#f9fafb; padding: 10px; background: #2d3748; border-radius: 12px; box-shadow: inset 3px 3px 6px #1a202c, inset -3px -3px 6px #273142;}

Â  Â  /* ç‹€æ…‹æ–‡å­— */
Â  Â  #main-status { font-weight: 700; text-shadow: 0 0 5px rgba(79, 70, 229, 0.5); }
Â  Â  .info{font-size:14px;color:#9ca3af; margin-top: 20px;}

Â  Â  /* æ–°å¢èªéŸ³æ§åˆ¶æŒ‰éˆ•æ¨£å¼ */
Â  Â  #btnSpeech {
Â  Â  Â  Â  background-color: #ef4444; /* ç´…è‰² */
Â  Â  Â  Â  color: white;
Â  Â  Â  Â  font-size: 1.25rem;
Â  Â  Â  Â  padding: 1.5rem;
Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  height: 150px;
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  margin-top: 20px;
Â  Â  Â  Â  box-shadow: 5px 5px 10px #1a202c, -5px -5px 10px #273142;
Â  Â  Â  Â  animation: pulse 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
Â  Â  }
Â  Â  #btnSpeech.listening {
Â  Â  Â  Â  background-color: #10b981; /* ç¶ è‰² */
Â  Â  Â  Â  box-shadow: 0 0 10px #10b981, 0 0 20px #10b981;
Â  Â  Â  Â  animation: none;
Â  Â  }
Â  Â  @keyframes pulse {
Â  Â  Â  Â  0%, 100% { opacity: 1; }
Â  Â  Â  Â  50% { opacity: .5; }
Â  Â  }

Â  Â  #speech-result {
Â  Â  Â  Â  min-height: 2.5rem;
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  background: #2d3748;
Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  margin-top: 15px;
Â  Â  Â  Â  font-style: italic;
Â  Â  }
Â  </style>
</head>
<body class="p-4">
Â  Â  <div class="container-wrap">
Â  Â  Â  Â Â 
Â  Â  Â  Â  <h1 class="text-3xl font-extrabold text-center text-indigo-400 mb-6">ğŸ™ï¸ BLE èªéŸ³æ§åˆ¶</h1>

Â  Â  Â  Â  <div class="top">
Â  Â  Â  Â  Â  Â  <button id="btnConnect" class="flex-grow">é€£ç·š BLE</button>
Â  Â  Â  Â  Â  Â  <div id="status">æœªé€£ç·š</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <button id="btnSpeech">
Â  Â  Â  Â  Â  Â  é»æ“Šé–‹å§‹èªéŸ³æ§åˆ¶
Â  Â  Â  Â  </button>

Â  Â  Â  Â  Â  Â  Â  Â  <div id="speech-result" class="text-center text-gray-400">
Â  Â  Â  Â  Â  Â  èªªå‡º: å‰é€² | å¾Œé€€ | å·¦è½‰ | å³è½‰ | åœæ­¢
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="text-center space-y-2 mt-4">
Â  Â  Â  Â  Â  Â  <p class="text-xl">ç›®å‰å‘½ä»¤: <span id="main-status" class="text-green-400">éœæ­¢</span></p>
Â  Â  Â  Â  Â  Â  <p class="text-xs text-gray-500">
Â  Â  Â  Â  Â  Â  Â  Â  T (é€Ÿåº¦): <span id="val_t">0</span> | S (è½‰å‘): <span id="val_s">0</span>
Â  Â  Â  Â  Â  Â  </p>
Â  Â  Â  Â  </div>
Â  Â  Â  Â Â 
Â  Â  Â  Â  <div class="info text-center">
Â  Â  Â  Â  Â  Â  Payload æ ¼å¼ï¼šT ($-255$ åˆ° $255$), S ($-255$ åˆ° $255$), ä»¥å­—ä¸² "T,S" å‚³è¼¸ã€‚
Â  Â  Â  Â  </div>

Â  Â  </div>

<script>
// --- BLE & Control Configuration ---
const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-000000000000';Â 
const CHARACTERISTIC_UUID = '4fafc201-1fb5-459e-8fcc-000000000000';Â 
const DEVICE_ID_KEY = 'ble_joystick_device_id';Â 
const MAX_CONTROL_VALUE = 255;Â 

// èªéŸ³å‘½ä»¤å°æ‡‰çš„é¦¬é”æ§åˆ¶å€¼ (T, S)
const COMMANDS = {
Â  Â  "å‰é€²": {t: MAX_CONTROL_VALUE, s: 0, status: "å‰é€²ä¸­", color: "text-green-400"},
Â  Â  "å¾Œé€€": {t: -MAX_CONTROL_VALUE, s: 0, status: "å¾Œé€€ä¸­", color: "text-orange-400"},
Â  Â  "å·¦è½‰": {t: 0, s: -MAX_CONTROL_VALUE, status: "å·¦è½‰ä¸­", color: "text-blue-400"},
Â  Â  "å³è½‰": {t: 0, s: MAX_CONTROL_VALUE, status: "å³è½‰ä¸­", color: "text-blue-400"},
Â  Â  "åœæ­¢": {t: 0, s: 0, status: "éœæ­¢", color: "text-red-400"},
Â  Â  "åœ": {t: 0, s: 0, status: "éœæ­¢", color: "text-red-400"}, // å¢åŠ ã€Œåœã€ä½œç‚ºåˆ¥å
};
const COMMAND_KEYWORDS = Object.keys(COMMANDS);


// --- DOM Elements ---
const statusEl = document.getElementById('status'); // BLE é€£ç·šç‹€æ…‹
const mainStatusEl = document.getElementById('main-status'); // ç›®å‰å‘½ä»¤ç‹€æ…‹
const valTEl = document.getElementById('val_t'); // T (Throttle)
const valSEl = document.getElementById('val_s'); // S (Steer)
const btnConnect = document.getElementById('btnConnect');
const btnSpeech = document.getElementById('btnSpeech'); // èªéŸ³æ§åˆ¶æŒ‰éˆ•
const speechResultEl = document.getElementById('speech-result');


// --- State Variables ---
let device = null;
let characteristic = null;
let lastPayload = {t: 0, s: 0}; // å„²å­˜ä¸Šæ¬¡ç™¼é€çš„ T, S å€¼


// --- Helper Functions ---

/**
Â * æ›´æ–°é¦¬é”æ•¸å€¼ä¸¦ç™¼é€å‘½ä»¤
Â * @param {number} t é€Ÿåº¦å€¼ (-255 åˆ° 255)
Â * @param {number} s è½‰å‘å€¼ (-255 åˆ° 255)
Â * @param {string} statusText é¡¯ç¤ºåœ¨ UI ä¸Šçš„å‘½ä»¤ç‹€æ…‹
Â * @param {string} statusColor ç‹€æ…‹æ–‡å­—é¡è‰²
Â */
async function updateMotorValues(t, s, statusText, statusColor) {
Â  Â  lastPayload.t = t;
Â  Â  lastPayload.s = s;

Â  Â  // æ›´æ–° UI é¡¯ç¤º
Â  Â  valTEl.textContent = t;Â 
Â  Â  valSEl.textContent = s;Â 
Â  Â  mainStatusEl.textContent = statusText;
Â  Â  mainStatusEl.className = `font-bold ${statusColor}`;

Â  Â  // ç«‹å³ç™¼é€æ§åˆ¶å‘½ä»¤
Â  Â  await sendControl();
}

/**
Â * è™•ç†èªéŸ³è¾¨è­˜çš„çµæœ
Â */
function processSpeechResult(transcript) {
Â  Â  speechResultEl.textContent = `è¾¨è­˜çµæœ: ${transcript}`;

Â  Â  // æª¢æŸ¥æ˜¯å¦åŒ…å«ä»»ä½•å‘½ä»¤é—œéµå­—
Â  Â  for (const keyword of COMMAND_KEYWORDS) {
Â  Â  Â  Â  if (transcript.includes(keyword)) {
Â  Â  Â  Â  Â  Â  const command = COMMANDS[keyword];
Â  Â  Â  Â  Â  Â  updateMotorValues(command.t, command.s, command.status, command.color);
Â  Â  Â  Â  Â  Â  speechResultEl.textContent = `âœ… å‘½ä»¤åŸ·è¡Œ: ${keyword}`;
Â  Â  Â  Â  Â  Â  return; // æ‰¾åˆ°ç¬¬ä¸€å€‹å‘½ä»¤å°±åŸ·è¡Œä¸¦è¿”å›
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // å¦‚æœæ²’æœ‰åŒ¹é…çš„å‘½ä»¤
Â  Â  speechResultEl.textContent = `âŒ ç„¡æ•ˆå‘½ä»¤: ${transcript} (è«‹é‡è©¦)`;
Â  Â  updateMotorValues(0, 0, "éœæ­¢", "text-red-400"); // ç„¡æ•ˆå‘½ä»¤æ™‚åœæ­¢é¦¬é”
}


// --- Web Speech API (Speech Recognition) ---

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;
let isListening = false;


function startSpeechRecognition() {
Â  Â  if (!SpeechRecognition) {
Â  Â  Â  Â  alert("âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Speech API (èªéŸ³è¾¨è­˜)ã€‚è«‹ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨ã€‚");
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  if (!device || !device.gatt.connected) {
Â  Â  Â  Â  statusEl.textContent = 'è«‹å…ˆé€£ç·š BLE è£ç½®ã€‚';
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  if (isListening) {
Â  Â  Â  Â  recognition.stop(); // å¦‚æœæ­£åœ¨è½ï¼Œå‰‡åœæ­¢
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  if (!recognition) {
Â  Â  Â  Â  recognition = new SpeechRecognition();
Â  Â  Â  Â  recognition.continuous = false; // åªè½ä¸€å€‹æŒ‡ä»¤
Â  Â  Â  Â  recognition.lang = 'zh-Hant'; // è¨­å®šç‚ºç¹é«”ä¸­æ–‡

Â  Â  Â  Â  recognition.onstart = () => {
Â  Â  Â  Â  Â  Â  isListening = true;
Â  Â  Â  Â  Â  Â  btnSpeech.textContent = "è«‹èªªè©±... (é»æ“Šåœæ­¢)";
Â  Â  Â  Â  Â  Â  btnSpeech.classList.add('listening');
Â  Â  Â  Â  Â  Â  speechResultEl.textContent = "ğŸ‘‚ æ­£åœ¨è†è½...";
Â  Â  Â  Â  };

Â  Â  Â  Â  recognition.onresult = (event) => {
Â  Â  Â  Â  Â  Â  // å–å¾—è¾¨è­˜çµæœä¸­æœ€é«˜çš„ä¿¡è³´åº¦æ–‡å­—
Â  Â  Â  Â  Â  Â  const transcript = event.results[0][0].transcript;
Â  Â  Â  Â  Â  Â  processSpeechResult(transcript);
Â  Â  Â  Â  };

Â  Â  Â  Â  recognition.onerror = (event) => {
Â  Â  Â  Â  Â  Â  console.error('Speech recognition error:', event.error);
Â  Â  Â  Â  Â  Â  speechResultEl.textContent = `âŒ èªéŸ³éŒ¯èª¤: ${event.error}`;
Â  Â  Â  Â  Â  Â  stopListeningUI();
Â  Â  Â  Â  };

Â  Â  Â  Â  recognition.onend = () => {
Â  Â  Â  Â  Â  Â  stopListeningUI();
Â  Â  Â  Â  };
Â  Â  }
Â  Â Â 
Â  Â  function stopListeningUI() {
Â  Â  Â  Â  isListening = false;
Â  Â  Â  Â  btnSpeech.textContent = "é»æ“Šé–‹å§‹èªéŸ³æ§åˆ¶";
Â  Â  Â  Â  btnSpeech.classList.remove('listening');
Â  Â  }

Â  Â  recognition.start();
}

btnSpeech.addEventListener('click', startSpeechRecognition);


// --- BLE Connection Logic (Modified to be simplified) ---

function onDisconnect() {
Â  Â  statusEl.textContent = 'âŒ å·²æ–·ç·š';
Â  Â  btnConnect.textContent = 'é€£ç·š BLE';
Â  Â  updateMotorValues(0, 0, "éœæ­¢", "text-red-400"); // æ–·ç·šæ™‚åœæ­¢é¦¬é”
Â  Â  if (device) device.removeEventListener('gattserverdisconnected', onDisconnect);
Â  Â  device = null;
Â  Â  characteristic = null;
}

async function acquireDevice() {
Â  Â  // å˜—è©¦å¿«é€Ÿé‡é€£æˆ–æƒæ
Â  Â  statusEl.textContent = 'æƒæä¸­...';
Â  Â  const newDevice = await navigator.bluetooth.requestDevice({
Â  Â  Â  Â  filters:[{ namePrefix: 'esp32' }],
Â  Â  Â  Â  optionalServices: [SERVICE_UUID]Â 
Â  Â  });
Â  Â Â 
Â  Â  localStorage.setItem(DEVICE_ID_KEY, newDevice.id);
Â  Â  return newDevice;
}


async function connectBLE(){
Â  Â  if (!navigator.bluetooth) {
Â  Â  Â  Â  statusEl.textContent = 'âŒ ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothã€‚';
Â  Â  Â  Â  return;
Â  Â  }
Â  Â Â 
Â  Â  // è™•ç†å·²é€£ç·šç‹€æ…‹ä¸‹çš„æŒ‰éˆ•é»æ“Š (æ–·é–‹é€£ç·š)
Â  Â  if (device && device.gatt && device.gatt.connected) {
Â  Â  Â  Â  statusEl.textContent = 'ä¸­æ–·é€£ç·šä¸­...';
Â  Â  Â  Â  device.gatt.disconnect();
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  try{
Â  Â  Â  Â  device = await acquireDevice();
Â  Â  Â  Â  if (!device) throw new Error("è£ç½®æœªé€£ç·šæˆ–æœªæ‰¾åˆ°ã€‚");

Â  Â  Â  Â  statusEl.textContent = `é€£ç·šåˆ° ${device.name}...`;

Â  Â  Â  Â  device.removeEventListener('gattserverdisconnected', onDisconnect);
Â  Â  Â  Â  device.addEventListener('gattserverdisconnected', onDisconnect);

Â  Â  Â  Â  const server = await device.gatt.connect();
Â  Â  Â  Â  const service = await server.getPrimaryService(SERVICE_UUID);
Â  Â  Â  Â  characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  statusEl.textContent = 'âœ… å·²é€£ç·š: ' + device.name;
Â  Â  Â  Â  btnConnect.textContent = 'æ–·é–‹';Â 

Â  Â  }catch(err){
Â  Â  Â  Â  console.error('BLE é€£ç·šå¤±æ•—:', err);
Â  Â  Â  Â  statusEl.textContent = `âŒ é€£ç·šå¤±æ•— (${err.message.slice(0, 30)}...)`;
Â  Â  Â  Â  btnConnect.textContent = 'é€£ç·š BLE';
Â  Â  Â  Â  if (device && (!device.gatt || !device.gatt.connected)) {
Â  Â  Â  Â  Â  Â  device = null;
Â  Â  Â  Â  Â  Â  localStorage.removeItem(DEVICE_ID_KEY);
Â  Â  Â  Â  }
Â  Â  }
}


/**
Â * å‘ ESP32 å‚³é€æ§åˆ¶æŒ‡ä»¤
Â * Payload æ ¼å¼ï¼šæ•´æ•¸ "T,S" å­—ä¸²
Â */
async function sendControl(){
Â  if(!characteristic || !device || !device.gatt.connected) {
Â  Â  statusEl.textContent = 'æœªé€£ç·šæˆ–å·²æ–·ç·šï¼Œç„¡æ³•å‚³é€å‘½ä»¤ã€‚';
Â  Â  return;
Â  }
Â Â 
Â  const t_int = lastPayload.t;
Â  const s_int = lastPayload.s;
Â Â 
Â  // å»ºç«‹ payload æ ¼å¼: T,S (ä¾‹å¦‚: "200,0")
Â  const payload = `${t_int},${s_int}`;
Â Â 
Â  try{
Â  Â  await characteristic.writeValue(new TextEncoder().encode(payload));
Â  }catch(err){
Â  Â  console.warn('send failed (å¯èƒ½å·²æ–·ç·š):', err.message);
Â  Â  // å¦‚æœå‚³é€å¤±æ•—ï¼Œè§¸ç™¼æ–·ç·šè™•ç†
Â  Â  if (device && device.gatt && !device.gatt.connected) {
Â  Â  Â  Â  onDisconnect();
Â  Â  }
Â  }
}

// --- Initialization ---

btnConnect.addEventListener('click', connectBLE);
updateMotorValues(0, 0, "éœæ­¢", "text-red-400"); // ç¢ºä¿åˆå§‹ç‹€æ…‹ç‚ºéœæ­¢
</script>
</body>
</html>