<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>ğŸ™ï¸ BLE èªéŸ³æ§åˆ¶</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
/* ç¢ºä¿å…¨è¢å¹•é«˜åº¦å’ŒæŸ”è»Ÿçš„èƒŒæ™¯è‰² */
body {
    background-color: #1f2937;
    color: #f9fafb;
    font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    margin: 0;
    padding: 1rem;
}
.container-wrap {
    max-width: 400px;
    width: 100%;
    padding: 30px;
    background-color: #2d3748; /* ç¨æ·ºçš„æ·±è‰²å¡ç‰‡èƒŒæ™¯ */
    border-radius: 1.5rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    display: flex;
    flex-direction: column;
    align-items: center;
}
/* é ‚éƒ¨æ§åˆ¶åˆ— */
.top{width:100%;display:flex;gap:12px;align-items:center; max-width: 520px; margin-bottom: 30px;}
.top button { flex-grow: 1; }

/* åŸºæœ¬æŒ‰éˆ•æ¨£å¼ */
button{
    padding:12px 16px;
    border-radius:14px;
    border:none;
    font-weight:700;
    background:#4f46e5;
    color:white;
    box-shadow: 4px 4px 8px #1a202c, -4px -4px 8px #3b4555; 
    transition: all 0.2s ease-in-out;
    cursor: pointer;
    white-space: nowrap;
}
button:hover { background: #3730a3; }
button:active {
    box-shadow: inset 3px 3px 6px #1a202c, inset -3px -3px 6px #3b4555;
    transform: translateY(1px);
}

#status{flex:1;text-align:center;font-weight:700;color:#f9fafb; padding: 12px; background: #374151; border-radius: 14px; box-shadow: inset 3px 3px 6px #1a202c, inset -3px -3px 6px #3b4555;}

/* æ–°å¢èªéŸ³æ§åˆ¶æŒ‰éˆ•æ¨£å¼ */
#btnSpeech {
    background-color: #ef4444; /* ç´…è‰²ï¼šæœªé€£ç·šæˆ–æœªé–‹å§‹ */
    color: white;
    font-size: 1.25rem;
    padding: 1.5rem;
    width: 100%;
    height: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 20px;
    box-shadow: 5px 5px 10px #1a202c, -5px -5px 10px #273142;
    animation: pulse 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
}
#btnSpeech:disabled {
    background-color: #4b5563; /* ç°è‰²ï¼šç¦ç”¨ç‹€æ…‹ */
    cursor: not-allowed;
    box-shadow: none;
    animation: none;
}
#btnSpeech.listening {
    background-color: #10b981; /* ç¶ è‰²ï¼šè†è½ä¸­ */
    box-shadow: 0 0 10px #10b981, 0 0 20px #10b981;
    animation: none;
}
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: .7; }
}

#speech-result {
    min-height: 2.5rem;
    padding: 10px;
    background: #2d3748;
    border-radius: 8px;
    margin-top: 15px;
    font-style: italic;
    font-size: 0.9rem;
}

/* ä¸»è¦ç‹€æ…‹æ–‡å­— */
#main-status { 
    font-weight: 800; 
    font-size: 1.5rem; /* å¤§å­—é«”é¡¯ç¤ºç•¶å‰å‘½ä»¤ç‹€æ…‹ */
}
.val-display {
    font-size: 1rem;
    color: #9ca3af; 
    margin-top: 10px;
}
.val-display span {
    font-family: 'Courier New', monospace;
    font-weight: bold;
    color: #fcd34d; /* ç¥ç€è‰² */
}
</style>
</head>
<body class="p-4">
<div class="container-wrap">
    
    <h1 class="text-3xl font-extrabold text-center text-indigo-400 mb-8">ğŸ™ï¸ BLE èªéŸ³æ§åˆ¶</h1>

    <div class="top">
        <button id="btnConnect">é€£ç·š BLE</button>
        <div id="status">æœªé€£ç·š</div>
    </div>

    <button id="btnSpeech" disabled>
        é€£ç·šå¾Œï¼Œé»æ“Šé–‹å§‹èªéŸ³æ§åˆ¶
    </button>

    <div id="speech-result" class="text-center text-gray-400">
        ğŸ“¢ å¯ç”¨çš„æŒ‡ä»¤: å‰é€² | å¾Œé€€ | å·¦è½‰ | å³è½‰ | åœæ­¢
    </div>

    <div class="text-center space-y-2 mt-6">
        <p class="text-xl">ç›®å‰å‘½ä»¤: <span id="main-status" class="text-red-400">éœæ­¢</span></p>
        
        <div class="val-display">
            T (é€Ÿåº¦): <span id="val_t">0</span> | S (è½‰å‘): <span id="val_s">0</span>
        </div>
    </div>
</div>

<script>
// --- BLE & Control Configuration ---
const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-000000000000';Â 
const CHARACTERISTIC_UUID = '4fafc201-1fb5-459e-8fcc-000000000000';Â 
const DEVICE_ID_KEY = 'ble_joystick_device_id';Â 
const MAX_CONTROL_VALUE = 255;Â 
const SEND_INTERVAL_MS = 60; // å®šæœŸç™¼é€å‘½ä»¤çš„æ™‚é–“é–“éš” (60ms)
const STOP_TIMEOUT_MS = 1000; // èªéŸ³æŒ‡ä»¤å¾Œï¼Œè‡ªå‹•åœæ­¢çš„æ™‚é–“ (1000ms = 1ç§’)

// èªéŸ³å‘½ä»¤å°æ‡‰çš„é¦¬é”æ§åˆ¶å€¼ (T, S)
const COMMANDS = {
    "å‰é€²": {t: 200, s: 0, status: "å‰é€²ä¸­", color: "text-green-400"},
    "å¾Œé€€": {t: -200, s: 0, status: "å¾Œé€€ä¸­", color: "text-orange-400"},
    "å·¦è½‰": {t: 0, s: -150, status: "å·¦è½‰ä¸­", color: "text-blue-400"},
    "å³è½‰": {t: 0, s: 150, status: "å³è½‰ä¸­", color: "text-blue-400"},
    "åœæ­¢": {t: 0, s: 0, status: "éœæ­¢", color: "text-red-400"},
    "åœ": {t: 0, s: 0, status: "éœæ­¢", color: "text-red-400"}, 
};
const COMMAND_KEYWORDS = Object.keys(COMMANDS);


// --- DOM Elements ---
const statusEl = document.getElementById('status'); // BLE é€£ç·šç‹€æ…‹
const mainStatusEl = document.getElementById('main-status'); // ç›®å‰å‘½ä»¤ç‹€æ…‹
const valTEl = document.getElementById('val_t'); // T (Throttle)
const valSEl = document.getElementById('val_s'); // S (Steer)
const btnConnect = document.getElementById('btnConnect');
const btnSpeech = document.getElementById('btnSpeech'); // èªéŸ³æ§åˆ¶æŒ‰éˆ•
const speechResultEl = document.getElementById('speech-result');


// --- State Variables ---
let device = null;
let characteristic = null;
let lastPayload = {t: 0, s: 0}; // å„²å­˜ä¸Šæ¬¡ç™¼é€çš„ T, S å€¼
let sendingInterval = null; // å®šæœŸç™¼é€çš„è¨ˆæ™‚å™¨
let stopTimer = null; // å®‰å…¨åœæ­¢è¨ˆæ™‚å™¨
let isListening = false;


// --- Helper Functions ---

/**
* @brief åƒ…æ›´æ–°é¦¬é”æ§åˆ¶çš„ç‹€æ…‹è®Šæ•¸å’Œ UIã€‚å¯¦éš›ç™¼é€ç”± interval è™•ç†ã€‚
* @param {number} t é€Ÿåº¦å€¼ (-255 åˆ° 255)
* @param {number} s è½‰å‘å€¼ (-255 åˆ° 255)
* @param {string} statusText é¡¯ç¤ºåœ¨ UI ä¸Šçš„å‘½ä»¤ç‹€æ…‹
* @param {string} statusColor ç‹€æ…‹æ–‡å­—é¡è‰²
*/
function setControlState(t, s, statusText, statusColor) {
    lastPayload.t = t;
    lastPayload.s = s;

    // æ›´æ–° UI é¡¯ç¤º
    valTEl.textContent = t;Â 
    valSEl.textContent = s;Â 
    mainStatusEl.textContent = statusText;
    mainStatusEl.className = `${statusColor}`;
}

/**
 * åœæ­¢é¦¬é”ä¸¦æ¸…é™¤å®‰å…¨åœæ­¢è¨ˆæ™‚å™¨
 */
function stopMotors() {
    if (stopTimer) {
        clearTimeout(stopTimer);
        stopTimer = null;
    }
    // ç«‹å³å°‡æ§åˆ¶ç‹€æ…‹è¨­ç‚ºåœæ­¢
    setControlState(0, 0, "éœæ­¢", "text-red-400");
}

/**
* è™•ç†èªéŸ³è¾¨è­˜çš„çµæœ
*/
function processSpeechResult(transcript) {
    speechResultEl.textContent = `è¾¨è­˜çµæœ: ${transcript}`;
    
    // æ¸…é™¤å®‰å…¨åœæ­¢è¨ˆæ™‚å™¨ï¼Œå› ç‚ºæ”¶åˆ°äº†æ–°æŒ‡ä»¤
    if (stopTimer) clearTimeout(stopTimer);

    // æª¢æŸ¥æ˜¯å¦åŒ…å«ä»»ä½•å‘½ä»¤é—œéµå­—
    for (const keyword of COMMAND_KEYWORDS) {
        if (transcript.includes(keyword)) {
            const command = COMMANDS[keyword];
            setControlState(command.t, command.s, command.status, command.color);
            speechResultEl.textContent = `âœ… å‘½ä»¤åŸ·è¡Œ: ${keyword}`;
            
            // å¦‚æœä¸æ˜¯åœæ­¢å‘½ä»¤ï¼Œå‰‡è¨­å®šå®‰å…¨è¶…æ™‚
            if (command.t !== 0 || command.s !== 0) {
                 stopTimer = setTimeout(stopMotors, STOP_TIMEOUT_MS);
            }
            return; // æ‰¾åˆ°ç¬¬ä¸€å€‹å‘½ä»¤å°±åŸ·è¡Œä¸¦è¿”å›
        }
    }

    // å¦‚æœæ²’æœ‰åŒ¹é…çš„å‘½ä»¤
    speechResultEl.textContent = `âŒ ç„¡æ•ˆå‘½ä»¤: ${transcript} (å°‡åœ¨ 1 ç§’å¾Œè‡ªå‹•åœæ­¢)`;
    // ç„¡æ•ˆå‘½ä»¤æ™‚ä¹Ÿè¨­å®šå®‰å…¨åœæ­¢è¨ˆæ™‚å™¨
    stopTimer = setTimeout(stopMotors, STOP_TIMEOUT_MS);
}


// --- Web Speech API (Speech Recognition) ---

const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
let recognition = null;


function startSpeechRecognition() {
    if (!SpeechRecognition) {
        speechResultEl.textContent = "âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Speech API (èªéŸ³è¾¨è­˜)ã€‚è«‹ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨ã€‚";
        return;
    }
    Â  Â Â 
    if (!device || !device.gatt.connected) {
        statusEl.textContent = 'è«‹å…ˆé€£ç·š BLE è£ç½®ã€‚';
        return;
    }

    if (!recognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false; // æ¯æ¬¡åªè½ä¸€å€‹æŒ‡ä»¤
        recognition.lang = 'zh-Hant'; // è¨­å®šç‚ºç¹é«”ä¸­æ–‡
        recognition.interimResults = false; 
    }
    
    if (isListening) {
        recognition.stop(); // å¦‚æœæ­£åœ¨è½ï¼Œå‰‡åœæ­¢
        return;
    }

    recognition.onstart = () => {
        isListening = true;
        btnSpeech.textContent = "æ­£åœ¨è†è½... è«‹èªªæŒ‡ä»¤ (é»æ“Šåœæ­¢)";
        btnSpeech.classList.add('listening');
        speechResultEl.textContent = "ğŸ‘‚ æ­£åœ¨è†è½...";
    };

    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        processSpeechResult(transcript);
    };

    recognition.onerror = (event) => {
        console.error('Speech recognition error:', event.error);
        speechResultEl.textContent = `âŒ èªéŸ³éŒ¯èª¤: ${event.error}`;
        stopListeningUI();
    };

    recognition.onend = () => {
        stopListeningUI();
    };
    
    try {
        recognition.start();
    } catch (e) {
        // æ•æ‰å¦‚æœ recognition å·²ç¶“åœ¨é‹è¡Œä¸­å†æ¬¡å‘¼å« start çš„éŒ¯èª¤
        console.warn('Recognition start failed:', e.message);
    }
}

function stopListeningUI() {
    isListening = false;
    btnSpeech.textContent = "é»æ“Šé–‹å§‹èªéŸ³æ§åˆ¶";
    btnSpeech.classList.remove('listening');
    // å¦‚æœæ˜¯è‡ªç„¶çµæŸï¼Œä¸å½±éŸ¿ç•¶å‰é¦¬é”ç‹€æ…‹ï¼Œåªæ¸…é™¤ UI ç‹€æ…‹
}

btnSpeech.addEventListener('click', startSpeechRecognition);


// --- BLE Connection Logic ---

function onDisconnect() {
    statusEl.textContent = 'âŒ å·²æ–·ç·š';
    btnConnect.textContent = 'é€£ç·š BLE';
    btnSpeech.disabled = true; // æ–·ç·šå¾Œç¦ç”¨èªéŸ³æŒ‰éˆ•
    
    // åœæ­¢æ‰€æœ‰æ§åˆ¶èˆ‡è¨ˆæ™‚å™¨
    stopMotors(); 
    if (sendingInterval) clearInterval(sendingInterval);
    sendingInterval = null;
    
    if (device) device.removeEventListener('gattserverdisconnected', onDisconnect);
    device = null;
    characteristic = null;
}

async function acquireDevice() {
    statusEl.textContent = 'æƒæä¸­ (éæ¿¾: esp32)...';
    const newDevice = await navigator.bluetooth.requestDevice({
        filters:[{ namePrefix: 'esp32' }],
        optionalServices: [SERVICE_UUID]Â 
    });
    Â  Â Â 
    localStorage.setItem(DEVICE_ID_KEY, newDevice.id);
    return newDevice;
}


async function connectBLE(){
    if (!navigator.bluetooth) {
        statusEl.textContent = 'âŒ ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothã€‚';
        return;
    }
    Â  Â Â 
    // è™•ç†å·²é€£ç·šç‹€æ…‹ä¸‹çš„æŒ‰éˆ•é»æ“Š (æ–·é–‹é€£ç·š)
    if (device && device.gatt && device.gatt.connected) {
        statusEl.textContent = 'ä¸­æ–·é€£ç·šä¸­...';
        device.gatt.disconnect();
        return;
    }

    try{
        device = await acquireDevice();
        if (!device) throw new Error("è£ç½®æœªé€£ç·šæˆ–æœªæ‰¾åˆ°ã€‚");

        statusEl.textContent = `é€£ç·šåˆ° ${device.name}...`;

        device.removeEventListener('gattserverdisconnected', onDisconnect);
        device.addEventListener('gattserverdisconnected', onDisconnect);

        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);Â 
        Â  Â  Â  Â Â 
        statusEl.textContent = 'âœ… å·²é€£ç·š: ' + device.name;
        btnConnect.textContent = 'æ–·é–‹';Â 
        btnSpeech.disabled = false; // é€£ç·šæˆåŠŸå¾Œå•Ÿç”¨èªéŸ³æŒ‰éˆ•
        
        // **ä¿®æ­£é» 1: é–‹å§‹å®šæœŸç™¼é€å‘½ä»¤**
        if (!sendingInterval) {
            sendingInterval = setInterval(sendControl, SEND_INTERVAL_MS);
        }

    }catch(err){
        console.error('BLE é€£ç·šå¤±æ•—:', err);
        statusEl.textContent = `âŒ é€£ç·šå¤±æ•— (${err.message.slice(0, 30)}...)`;
        btnConnect.textContent = 'é€£ç·š BLE';
        btnSpeech.disabled = true;
        if (device && (!device.gatt || !device.gatt.connected)) {
            device = null;
            localStorage.removeItem(DEVICE_ID_KEY);
        }
    }
}


/**
* @brief å®šæœŸå‘ ESP32 å‚³é€æ§åˆ¶æŒ‡ä»¤ (T,S)
*/
async function sendControl(){
    if(!characteristic || !device || !device.gatt.connected) {
        if (sendingInterval) clearInterval(sendingInterval);
        sendingInterval = null;
        return;
    }
    Â  Â Â 
    const t_int = lastPayload.t;
    const s_int = lastPayload.s;
    Â  Â Â 
    // å»ºç«‹ payload æ ¼å¼: T,S (ä¾‹å¦‚: "200,0")
    const payload = `${t_int},${s_int}`;
    Â  Â Â 
    try{
        await characteristic.writeValue(new TextEncoder().encode(payload));
    }catch(err){
        console.warn('send failed (å¯èƒ½å·²æ–·ç·š):', err.message);
        // å¦‚æœå‚³é€å¤±æ•—ï¼Œè§¸ç™¼æ–·ç·šè™•ç†
        if (device && device.gatt && !device.gatt.connected) {
            onDisconnect();
        }
    }
}

// --- Initialization ---

btnConnect.addEventListener('click', connectBLE);
setControlState(0, 0, "éœæ­¢", "text-red-400"); // ç¢ºä¿åˆå§‹ç‹€æ…‹ç‚ºéœæ­¢
</script>
</body>
</html>