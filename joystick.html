<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>BLE 搖桿控制 (Mobile)</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans TC';-webkit-touch-callout:none;-webkit-user-select:none;}
    .app{display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:12px;gap:12px}
    .top{width:100%;display:flex;gap:8px;align-items:center}
    button{padding:10px 14px;border-radius:10px;border:0;background:#222;color:white;font-weight:600}
    #status{flex:1;text-align:center}
    .joystick-wrap{width:90vw;max-width:520px;height:66vh;display:flex;align-items:center;justify-content:center}
    .pad{width:84vw;max-width:420px;height:84vw;max-height:420px;border-radius:999px;background:linear-gradient(180deg,#f3f3f3,#e6e6e6);position:relative;touch-action:none;}
    .stick{position:absolute;width:30%;height:30%;max-width:150px;max-height:150px;border-radius:999px;background:rgba(40,40,40,0.85);transform:translate(-50%,-50%);left:50%;top:50%;display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
    .info{font-size:14px;color:#444}
  </style>
</head>
<body>
  <div class="app">
    <div class="top">
      <button id="btnConnect">連線 BLE</button>
      <div id="status">未連線</div>
    </div>

    <div class="joystick-wrap">
      <div class="pad" id="pad">
        <div class="stick" id="stick">0,0</div>
      </div>
    </div>

    <div class="info">說明：上/下推控制前/後（throttle），左右推控制轉向（steer）。每 60 ms 傳一次指令。</div>
  </div>

<script>
// UUIDs - 與 ESP32 端需一致
const SERVICE_UUID = '12345678-1234-5678-1234-56789abcdef0';
const CHARACTERISTIC_UUID = 'abcdef01-1234-5678-1234-56789abcdef0';

let device = null;
let characteristic = null;
let sendingInterval = null;
let lastPayload = {t:0,s:0};

const pad = document.getElementById('pad');
const stick = document.getElementById('stick');
const status = document.getElementById('status');
const btnConnect = document.getElementById('btnConnect');

let rect, centerX, centerY, maxRadius;

function resize() {
  rect = pad.getBoundingClientRect();
  centerX = rect.left + rect.width/2;
  centerY = rect.top + rect.height/2;
  maxRadius = rect.width/2 * 0.85; // limit
}
window.addEventListener('resize', resize);
resize();

let pointerActive = false;
let curX = 0, curY = 0;

function clamp(v,min,max){return Math.max(min,Math.min(max,v));}

function pointerToTS(px,py){
  const dx = px - centerX;
  const dy = centerY - py; // y positive up
  const dist = Math.sqrt(dx*dx+dy*dy);
  const r = clamp(dist / maxRadius, 0, 1);
  const nx = dx / (maxRadius); // -1..1
  const ny = dy / (maxRadius); // -1..1
  // throttle = ny, steer = nx
  const throttle = clamp(ny, -1, 1);
  const steer = clamp(nx, -1, 1);
  return {t:throttle, s:steer, r};
}

function updateStick(px,py){
  const dx = px - centerX;
  const dy = py - centerY;
  const dist = Math.sqrt(dx*dx+dy*dy);
  const angle = Math.atan2(dy,dx);
  const limited = Math.min(dist, maxRadius);
  const x = centerX + Math.cos(angle)*limited;
  const y = centerY + Math.sin(angle)*limited;
  stick.style.left = (x - rect.left) + 'px';
  stick.style.top = (y - rect.top) + 'px';
}

function resetStick(){
  stick.style.left = '50%';
  stick.style.top = '50%';
  stick.textContent = '0,0';
}

// Touch / Pointer handling
pad.addEventListener('pointerdown', (e)=>{
  pointerActive = true;
  pad.setPointerCapture(e.pointerId);
  resize();
  const t = pointerToTS(e.clientX, e.clientY);
  lastPayload.t = t.t; lastPayload.s = t.s;
  updateStick(e.clientX, e.clientY);
  stick.textContent = (t.t.toFixed(2))+','+(t.s.toFixed(2));
});
pad.addEventListener('pointermove', (e)=>{
  if(!pointerActive) return;
  const t = pointerToTS(e.clientX, e.clientY);
  lastPayload.t = t.t; lastPayload.s = t.s;
  updateStick(e.clientX, e.clientY);
  stick.textContent = (t.t.toFixed(2))+','+(t.s.toFixed(2));
});
pad.addEventListener('pointerup', (e)=>{
  pointerActive = false;
  pad.releasePointerCapture(e.pointerId);
  lastPayload.t = 0; lastPayload.s = 0; // center on release
  resetStick();
});

// BLE
async function connectBLE(){
  try{
    status.textContent = '掃描中...';
    device = await navigator.bluetooth.requestDevice({
      filters:[{services:[SERVICE_UUID]}],
      optionalServices: [SERVICE_UUID]
    });
    status.textContent = '連線中...';
    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
    status.textContent = '已連線: ' + device.name;

    // 開始定期傳送
    if(sendingInterval) clearInterval(sendingInterval);
    sendingInterval = setInterval(sendControl, 60); // 每 60 ms

    device.addEventListener('gattserverdisconnected', ()=>{
      status.textContent = '已斷線';
      clearInterval(sendingInterval);
      sendingInterval = null;
    });
  }catch(err){
    console.error(err);
    status.textContent = '連線失敗';
  }
}

async function sendControl(){
  if(!characteristic) return;
  // payload 格式: t:<float>,s:<float> 例如 t:0.50,s:-0.20
  const t = Number(lastPayload.t).toFixed(3);
  const s = Number(lastPayload.s).toFixed(3);
  const payload = `t:${t},s:${s}`;
  try{
    await characteristic.writeValue(new TextEncoder().encode(payload));
  }catch(err){
    console.warn('send failed',err);
  }
}

btnConnect.addEventListener('click', ()=>{
  if(!navigator.bluetooth){
    alert('此瀏覽器不支援 Web Bluetooth。請使用 Chrome for Android 或有支援 Web Bluetooth 的瀏覽器。');
    return;
  }
  connectBLE();
});

// 初始 reset
resetStick();
</script>
</body>
</html>
