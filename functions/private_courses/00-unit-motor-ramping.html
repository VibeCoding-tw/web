<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¦¬é” Ramping çµ„æ…‹è¨­å®š | Vibe Coding</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .step-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .input-group label {
            @apply text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1 block;
        }

        .input-group input {
            @apply w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-purple-500 focus:border-purple-500 outline-none transition font-mono text-sm;
        }
    </style>
</head>

<body class="text-gray-800 pb-20">

    <!-- Hero Section -->
    <header class="bg-gradient-to-r from-purple-800 to-indigo-900 text-white py-12">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-3xl md:text-4xl font-bold mb-4">âš™ï¸ é¦¬é” Ramping çµ„æ…‹è¨­å®š</h1>
            <p class="text-purple-200 max-w-2xl mx-auto">
                èª¿æ ¡é¦¬é”å‡ºåŠ›æ›²ç·šï¼Œè§£æ±ºæŠ–å‹•èˆ‡åæ‡‰é²éˆå•é¡Œã€‚é€é BLE ç›´æ¥èˆ‡ ESP32 çš„çµæ§‹é«” (Struct) é€²è¡ŒäºŒé€²ä½é€šè¨Šã€‚
            </p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-5xl">

        <!-- BLE Connection Panel -->
        <div class="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden mb-12">
            <div
                class="p-6 bg-slate-50 border-b border-slate-200 flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-purple-600">
                        <i class="fa-brands fa-bluetooth text-xl"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-bold text-slate-800">è£ç½®é€£ç·š</h2>
                        <p class="text-xs text-slate-500">Service UUID: <span class="font-mono">4fafc201...</span></p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <span id="statusBadge"
                        class="px-3 py-1 bg-slate-200 text-slate-600 rounded-full text-sm font-medium flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-slate-400"></span> æœªé€£ç·š
                    </span>
                    <button id="connectBtn"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-5 py-2 rounded-lg font-medium shadow-md transition flex items-center gap-2">
                        <i class="fa-solid fa-link"></i> é€£ç·š BLE
                    </button>
                </div>
            </div>

            <div class="p-6 md:p-8 grid md:grid-cols-2 gap-8 opacity-50 pointer-events-none transition-all duration-300"
                id="mainPanel">
                <!-- Throttle Config -->
                <div>
                    <h3 class="flex items-center gap-2 text-indigo-600 font-bold mb-4">
                        <i class="fa-solid fa-gauge-high"></i> Throttle (æ²¹é–€/ç›´ç·š)
                    </h3>
                    <div class="space-y-4">
                        <div class="input-group">
                            <label>PWM Effective Limit (0-255)</label>
                            <input type="number" id="pwmEffectiveLimitT" min="0" max="255">
                            <p class="text-[10px] text-slate-400 mt-1">PWM æœ€å¤§è¼¸å‡ºé™åˆ¶</p>
                        </div>
                        <div class="input-group">
                            <label>Ramp Accel Step</label>
                            <input type="number" id="rampAccelStepT" min="1" max="100">
                            <p class="text-[10px] text-slate-400 mt-1">æ¯ 10ms å¢åŠ çš„ PWM æ•¸å€¼ (åŠ é€Ÿåº¦)</p>
                        </div>
                        <div class="input-group">
                            <label>PWM Start Kick</label>
                            <input type="number" id="pwmStartKickT" min="0" max="255">
                            <p class="text-[10px] text-slate-400 mt-1">èµ·æ­¥æœ€å° PWM (å…‹æœéœæ‘©æ“¦åŠ›)</p>
                        </div>
                    </div>
                </div>

                <!-- Steering Config -->
                <div class="md:border-l md:border-slate-100 md:pl-8">
                    <h3 class="flex items-center gap-2 text-emerald-600 font-bold mb-4">
                        <i class="fa-solid fa-arrows-left-right"></i> Steering (è½‰å‘/å·®é€Ÿ)
                    </h3>
                    <div class="space-y-4">
                        <div class="input-group">
                            <label>PWM Effective Limit (0-255)</label>
                            <input type="number" id="pwmEffectiveLimitS" min="0" max="255">
                        </div>
                        <div class="input-group">
                            <label>Ramp Accel Step</label>
                            <input type="number" id="rampAccelStepS" min="1" max="100">
                        </div>
                        <div class="input-group">
                            <label>PWM Start Kick</label>
                            <input type="number" id="pwmStartKickS" min="0" max="255">
                        </div>
                    </div>
                </div>

                <!-- Common & Actions -->
                <div class="md:col-span-2 pt-6 border-t border-slate-100 flex flex-col items-center gap-4">
                    <div class="w-full max-w-xs">
                        <label
                            class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1 text-center">Control
                            Timeout (ms)</label>
                        <input type="number" id="controlTimeoutMs"
                            class="w-full text-center px-3 py-2 border rounded-md" min="100" max="5000">
                    </div>

                    <button id="saveBtn"
                        class="w-full md:w-auto px-8 py-3 bg-slate-800 hover:bg-slate-900 text-white rounded-xl font-bold shadow-lg transition flex items-center justify-center gap-2">
                        <i class="fa-regular fa-floppy-disk"></i> å‚³é€è¨­å®šè‡³è£ç½® (Binary 28 Bytes)
                    </button>
                    <p id="msgLabel" class="text-sm text-slate-400 min-h-[20px]"></p>
                </div>
            </div>
        </div>

        <!-- Instructional Content -->
        <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-2">
            Ramping åŸç†ç¤ºæ„
        </h2>

        <div class="grid md:grid-cols-2 gap-8 mb-16">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <h3 class="font-bold text-lg mb-4 text-slate-700">ç‚ºä»€éº¼éœ€è¦ Rampingï¼Ÿ</h3>
                <p class="text-slate-600 text-sm leading-relaxed mb-4">
                    ç•¶æ‚¨åœ¨æ“æ§ç„¡äººè»Šæ™‚ï¼Œè‹¥ç›´æ¥å°‡ PWM å¾ 0 ç¬é–“æ‹‰åˆ° 255ï¼Œæœƒç™¼ç”Ÿä»¥ä¸‹å•é¡Œï¼š
                </p>
                <ul class="list-disc list-inside text-sm text-slate-600 space-y-2">
                    <li><strong>é›»æµçªæ³¢</strong>ï¼šç¬é–“å¤§é›»æµå¯èƒ½å°è‡´ ESP32 é‡å•Ÿã€‚</li>
                    <li><strong>æ©Ÿæ¢°æ‡‰åŠ›</strong>ï¼šé½’è¼ªç®±æ‰¿å—ç¬é–“æ’æ“Šï¼Œå®¹æ˜“æå£ã€‚</li>
                    <li><strong>æ‰“æ»‘å¤±æ§</strong>ï¼šè¼ªèƒå¤±å»æŠ“åœ°åŠ›ï¼Œå°è‡´è»Šè¼›æ‰“è½‰ã€‚</li>
                </ul>
                <div class="mt-4 p-4 bg-purple-50 rounded-lg text-xs text-purple-700">
                    <strong>rampAccelStep</strong> å°±åƒæ˜¯ã€Œè™›æ“¬å½ˆç°§ã€ï¼Œæ•¸å€¼è¶Šå°ï¼Œå½ˆç°§è¶Šè»Ÿï¼ˆåŠ é€Ÿè¶Šå¹³æ»‘ï¼‰ï¼›æ•¸å€¼è¶Šå¤§ï¼Œåæ‡‰è¶Šç›´æ¥ã€‚
                </div>
            </div>
            <!-- Placeholder for Visual -->
            <div class="bg-indigo-50 rounded-xl p-8 flex items-center justify-center border border-indigo-100">
                <div class="text-center">
                    <i class="fa-solid fa-chart-line text-4xl text-indigo-300 mb-2"></i>
                    <p class="text-indigo-400 text-sm">PWM Ramping Curve Visualization</p>
                    <div class="mt-4 h-24 flex items-end gap-1 justify-center opacity-50">
                        <div class="w-4 bg-indigo-400 h-1/6 rounded-t"></div>
                        <div class="w-4 bg-indigo-400 h-2/6 rounded-t"></div>
                        <div class="w-4 bg-indigo-400 h-3/6 rounded-t"></div>
                        <div class="w-4 bg-indigo-400 h-4/6 rounded-t"></div>
                        <div class="w-4 bg-indigo-400 h-5/6 rounded-t"></div>
                        <div class="w-4 bg-indigo-400 h-full rounded-t"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Developer Section -->
        <section class="mb-16">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">ğŸ› ï¸ æŠ€è¡“é–‹ç™¼ç´°ç¯€ (For Developer)</h2>

            <div class="bg-slate-900 rounded-xl overflow-hidden text-slate-300 font-mono text-sm shadow-xl">
                <div class="bg-slate-800 px-6 py-3 border-b border-slate-700 flex justify-between items-center">
                    <span class="font-bold text-white">C++ Struct Definition</span>
                    <span class="text-xs px-2 py-1 bg-slate-700 rounded">Total: 28 Bytes</span>
                </div>
                <div class="p-6 overflow-x-auto">
                    <pre class="whitespace-pre"><span class="text-pink-400">struct</span> <span class="text-yellow-300">MotorConfig_t</span> {
  <span class="text-blue-400">uint32_t</span> controlTimeoutMs;   <span class="text-slate-500">// Offset 0  (4 bytes)</span>
  <span class="text-blue-400">int32_t</span>  pwmEffectiveLimitT; <span class="text-slate-500">// Offset 4  (4 bytes)</span>
  <span class="text-blue-400">int32_t</span>  rampAccelStepT;     <span class="text-slate-500">// Offset 8  (4 bytes)</span>
  <span class="text-blue-400">int32_t</span>  pwmStartKickT;      <span class="text-slate-500">// Offset 12 (4 bytes)</span>
  <span class="text-blue-400">int32_t</span>  pwmEffectiveLimitS; <span class="text-slate-500">// Offset 16 (4 bytes)</span>
  <span class="text-blue-400">int32_t</span>  rampAccelStepS;     <span class="text-slate-500">// Offset 20 (4 bytes)</span>
  <span class="text-blue-400">int32_t</span>  pwmStartKickS;      <span class="text-slate-500">// Offset 24 (4 bytes)</span>
};</pre>
                </div>
                <div class="bg-indigo-900/30 p-4 border-t border-indigo-900/50">
                    <h4 class="text-indigo-300 font-bold mb-2 text-xs uppercase">ç‚ºä»€éº¼ä½¿ç”¨äºŒé€²ä½å‚³è¼¸ï¼Ÿ</h4>
                    <p class="mb-2">1. <strong>æ¥µè‡´æ•ˆèƒ½</strong>ï¼š28 Bytes vs JSON å­—ä¸² (~150 Bytes)ã€‚</p>
                    <p>2. <strong>é›¶è§£æé–‹éŠ·</strong>ï¼šåµŒå…¥å¼ç«¯åªéœ€ <code>memcpy</code>ï¼Œç„¡éœ€ JSON Parserã€‚</p>
                </div>
            </div>
        </section>

        <!-- Troubleshooting -->
        <section class="bg-amber-50 border border-amber-200 rounded-xl p-6 mb-16">
            <h2 class="text-lg font-bold text-amber-800 mb-4 flex items-center gap-2">
                <i class="fa-solid fa-triangle-exclamation"></i> éŒ¯èª¤æ’æŸ¥
            </h2>
            <div class="grid md:grid-cols-3 gap-6 text-sm text-amber-900/80">
                <div>
                    <strong class="block text-amber-900 mb-1">âŒ ç„¡æ³•æƒæåˆ°è£ç½®</strong>
                    <p>è«‹é‡æ–°æ’æ‹” ESP32 é›»æºï¼Œä¸¦ç¢ºèªè—ç‰™æ¬Šé™å·²é–‹å•Ÿã€‚</p>
                </div>
                <div>
                    <strong class="block text-amber-900 mb-1">âš ï¸ æ•¸æ“šé•·åº¦éŒ¯èª¤</strong>
                    <p>è‹¥è®€å–æ™‚ç™¼ç”Ÿ Errorï¼Œä»£è¡¨ç¶²é ç«¯å®šç¾©çš„ 28 Bytes èˆ‡éŸŒé«”ç«¯ä¸ä¸€è‡´ï¼Œè«‹æª¢æŸ¥ Struct å°é½Šã€‚</p>
                </div>
                <div>
                    <strong class="block text-amber-900 mb-1">âŒ å¯«å…¥å¾Œæ²’åæ‡‰</strong>
                    <p>è«‹ç¢ºèªæ•¸å€¼æ˜¯å¦ç‚ºæ•´æ•¸ (Integer)ã€‚DataView å°å‹åˆ¥éå¸¸æ•æ„Ÿã€‚</p>
                </div>
            </div>
        </section>

        <!-- Homework -->
        <h2 class="text-2xl font-bold text-slate-800 text-center mb-8">ğŸ› ï¸ èª²å¾Œç·´ç¿’èˆ‡æŒ‘æˆ°</h2>
        <div class="grid md:grid-cols-3 gap-6 mb-12">
            <!-- HW 2-1 -->
            <div onclick="openSubmissionModal('motor-ramping-task-1', 'ä½œæ¥­ 2-1: UI å®¹éŒ¯æ©Ÿåˆ¶')"
                class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 cursor-pointer relative group hover:shadow-lg transition-all">
                <div
                    class="w-12 h-12 bg-blue-100/50 rounded-full flex items-center justify-center text-blue-600 text-xl font-bold mb-4">
                    2-1</div>
                <h3 class="font-bold text-lg mb-2">UI å®¹éŒ¯æ©Ÿåˆ¶</h3>
                <p class="text-sm text-slate-600 mb-4">é˜²æ­¢ä½¿ç”¨è€…è¼¸å…¥æ¥µç«¯æ•¸å€¼å°è‡´é¦¬é”ç‡’æ¯€ã€‚</p>
                <ul class="text-sm text-slate-500 list-disc list-inside mb-4">
                    <li>ç‚ºæ¯å€‹ Input åŠ å…¥ min/max å±¬æ€§ã€‚</li>
                    <li>JS å¯¦ä½œï¼šè¼¸å…¥ç´…æ¡†è­¦å‘Šã€‚</li>
                    <li>ç©ºå€¼ä¿è­·ï¼šç¦æ­¢å‚³é€ã€‚</li>
                </ul>
                <!-- Hover Overlay -->
                <div
                    class="absolute inset-0 bg-blue-500/5 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-xl">
                    <span
                        class="bg-white text-blue-600 px-4 py-2 rounded-full font-bold shadow-lg transform translate-y-2 group-hover:translate-y-0 transition-transform">
                        ğŸ“¤ é»æ“Šç¹³äº¤ä½œæ¥­
                    </span>
                </div>
            </div>

            <!-- HW 2-2 -->
            <div onclick="openSubmissionModal('motor-ramping-task-2', 'ä½œæ¥­ 2-2: äºŒé€²ä½é€†å‘å·¥ç¨‹')"
                class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 cursor-pointer relative group hover:shadow-lg transition-all">
                <div
                    class="w-12 h-12 bg-purple-100/50 rounded-full flex items-center justify-center text-purple-600 text-xl font-bold mb-4">
                    2-2</div>
                <h3 class="font-bold text-lg mb-2">äºŒé€²ä½é€†å‘å·¥ç¨‹</h3>
                <p class="text-sm text-slate-600 mb-4">å¯¦é©— DataView èˆ‡ Little-Endianã€‚</p>
                <ul class="text-sm text-slate-500 list-disc list-inside mb-4">
                    <li>æ‰‹å‹•å»ºç«‹ ArrayBuffer æ¸¬è©¦è§£æã€‚</li>
                    <li>å°‡ LittleEndian æ”¹ç‚º false è§€å¯Ÿè®ŠåŒ–ã€‚</li>
                    <li>æ€è€ƒ Alignment å•é¡Œã€‚</li>
                </ul>
                <!-- Hover Overlay -->
                <div
                    class="absolute inset-0 bg-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-xl">
                    <span
                        class="bg-white text-purple-600 px-4 py-2 rounded-full font-bold shadow-lg transform translate-y-2 group-hover:translate-y-0 transition-transform">
                        ğŸ“¤ é»æ“Šç¹³äº¤ä½œæ¥­
                    </span>
                </div>
            </div>

            <!-- HW 2-3 -->
            <div onclick="openSubmissionModal('motor-ramping-task-3', 'ä½œæ¥­ 2-3: æ–·é›»ä¿è­·é©—è­‰')"
                class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 cursor-pointer relative group hover:shadow-lg transition-all">
                <div
                    class="w-12 h-12 bg-emerald-100/50 rounded-full flex items-center justify-center text-emerald-600 text-xl font-bold mb-4">
                    2-3</div>
                <h3 class="font-bold text-lg mb-2">æ–·é›»ä¿è­·é©—è­‰</h3>
                <p class="text-sm text-slate-600 mb-4">æ¸¬è©¦ç³»çµ±ç©©å®šæ€§ã€‚</p>
                <ul class="text-sm text-slate-500 list-disc list-inside mb-4">
                    <li>å¿ƒè·³åŒ…ï¼š500ms è¶…æ™‚è‡ªå‹•åœè»Šã€‚</li>
                    <li>æ–·é›»å¾Œåƒæ•¸æ˜¯å¦å¾ EEPROM å›å¾©ï¼Ÿ</li>
                    <li>æ‰‹æ„Ÿèª¿æ ¡ï¼šæ¥µé™æ“é§•æ¸¬è©¦ã€‚</li>
                </ul>
                <!-- Hover Overlay -->
                <div
                    class="absolute inset-0 bg-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-xl">
                    <span
                        class="bg-white text-emerald-600 px-4 py-2 rounded-full font-bold shadow-lg transform translate-y-2 group-hover:translate-y-0 transition-transform">
                        ğŸ“¤ é»æ“Šç¹³äº¤ä½œæ¥­
                    </span>
                </div>
            </div>
        </div>

    </main>

    <!-- Logic Script -->
    <script src="/js/course-shared.js"></script>
    <script>
        // DOM Elements
        const connectBtn = document.getElementById('connectBtn');
        const statusBadge = document.getElementById('statusBadge');
        const mainPanel = document.getElementById('mainPanel');
        const saveBtn = document.getElementById('saveBtn');
        const msgLabel = document.getElementById('msgLabel');

        // Inputs
        const inputIds = [
            'controlTimeoutMs',
            'pwmEffectiveLimitT', 'rampAccelStepT', 'pwmStartKickT',
            'pwmEffectiveLimitS', 'rampAccelStepS', 'pwmStartKickS'
        ];

        const inputs = {};
        inputIds.forEach(id => inputs[id] = document.getElementById(id));

        // BLE Constants
        const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c0ffee00dead';
        const CHAR_CONFIG_UUID = '4fafc203-1fb5-459e-8fcc-c0ffee02dead';

        let bleDevice;
        let configChar;

        // --- Connection Logic ---
        connectBtn.addEventListener('click', async () => {
            try {
                // 1. Request Device
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'esp32' }],
                    optionalServices: [SERVICE_UUID]
                });

                updateStatus('connecting');

                // 2. Connect GATT
                const server = await bleDevice.gatt.connect();
                const service = await server.getPrimaryService(SERVICE_UUID);
                configChar = await service.getCharacteristic(CHAR_CONFIG_UUID);

                // 3. Read Initial Config
                await readConfig(configChar);

                // 4. Update UI
                updateStatus('connected');
                mainPanel.classList.remove('opacity-50', 'pointer-events-none');

                // Handle Disconnect
                bleDevice.addEventListener('gattserverdisconnected', onDisconnect);

            } catch (err) {
                console.error(err);
                alert('é€£ç·šå¤±æ•—: ' + err.message);
                updateStatus('disconnected');
            }
        });

        // --- Read Configuration (Binary Unpacking) ---
        async function readConfig(characteristic) {
            console.log('Reading config...');
            const value = await characteristic.readValue(); // DataView

            if (value.byteLength !== 28) {
                alert(`âš ï¸ è­¦å‘Š: è£ç½®å›å‚³é•·åº¦ (${value.byteLength}) èˆ‡é æœŸ (28) ä¸ç¬¦ï¼`);
            }

            // Little-Endian Unpacking
            // Offset 0: controlTimeoutMs (Uint32)
            inputs.controlTimeoutMs.value = value.getUint32(0, true);

            // Offset 4: pwmEffectiveLimitT (Int32)
            inputs.pwmEffectiveLimitT.value = value.getInt32(4, true);
            // Offset 8: rampAccelStepT
            inputs.rampAccelStepT.value = value.getInt32(8, true);
            // Offset 12: pwmStartKickT
            inputs.pwmStartKickT.value = value.getInt32(12, true);

            // Offset 16: pwmEffectiveLimitS
            inputs.pwmEffectiveLimitS.value = value.getInt32(16, true);
            // Offset 20: rampAccelStepS
            inputs.rampAccelStepS.value = value.getInt32(20, true);
            // Offset 24: pwmStartKickS
            inputs.pwmStartKickS.value = value.getInt32(24, true);

            msgLabel.textContent = "âœ… å·²å¾è£ç½®è®€å–æœ€æ–°è¨­å®š";
            msgLabel.className = "text-green-600 font-bold text-sm mt-2";
        }

        // --- Save Configuration (Binary Packing) ---
        saveBtn.addEventListener('click', async () => {
            if (!configChar) return;

            // Validation (Basic)
            for (const id of inputIds) {
                if (!inputs[id].value) {
                    alert('âŒ æ‰€æœ‰æ¬„ä½çš†å¿…å¡«ï¼');
                    return;
                }
            }

            try {
                const buffer = new ArrayBuffer(28);
                const view = new DataView(buffer);

                // Pack Data (Little-Endian)
                view.setUint32(0, parseInt(inputs.controlTimeoutMs.value), true);

                view.setInt32(4, parseInt(inputs.pwmEffectiveLimitT.value), true);
                view.setInt32(8, parseInt(inputs.rampAccelStepT.value), true);
                view.setInt32(12, parseInt(inputs.pwmStartKickT.value), true);

                view.setInt32(16, parseInt(inputs.pwmEffectiveLimitS.value), true);
                view.setInt32(20, parseInt(inputs.rampAccelStepS.value), true);
                view.setInt32(24, parseInt(inputs.pwmStartKickS.value), true);

                console.log('Sending bytes:', buffer);

                await configChar.writeValue(buffer);

                msgLabel.textContent = "âœ… è¨­å®šå·²æˆåŠŸå‚³é€! (28 Bytes)";
                msgLabel.className = "text-green-600 font-bold text-sm mt-2";

                // Flash success visual
                saveBtn.classList.add('bg-green-600');
                setTimeout(() => saveBtn.classList.remove('bg-green-600'), 1000);

            } catch (err) {
                console.error(err);
                alert('å¯«å…¥å¤±æ•—: ' + err.message);
            }
        });

        // --- Helpers ---
        function updateStatus(state) {
            const badgeSpan = statusBadge.querySelector('span');
            if (state === 'connected') {
                statusBadge.className = 'px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium flex items-center gap-2';
                badgeSpan.className = 'w-2 h-2 rounded-full bg-green-500';
                statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500"></span> ${bleDevice.name} å·²é€£ç·š`;
                connectBtn.classList.add('hidden');
            } else if (state === 'connecting') {
                badgeSpan.className = 'w-2 h-2 rounded-full bg-amber-500 animate-pulse';
                statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full bg-amber-500 animate-pulse"></span> é€£ç·šä¸­...`;
            } else {
                statusBadge.className = 'px-3 py-1 bg-slate-200 text-slate-600 rounded-full text-sm font-medium flex items-center gap-2';
                connectBtn.classList.remove('hidden');
                statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full bg-slate-400"></span> æœªé€£ç·š`;
                mainPanel.classList.add('opacity-50', 'pointer-events-none');
            }
        }

        function onDisconnect() {
            updateStatus('disconnected');
            alert('è£ç½®å·²æ–·ç·š');
        }
    </script>
    <section id="assignment-guide" class="hidden">
        <h2>ä½œæ¥­æŒ‡å¼• (Assignment Guide)</h2>
        <div class="space-y-6">
            <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="font-bold text-blue-800">1. GitHub Classroom è¨­å®š</h3>
                <p class="text-sm">è«‹å°‡å°æ‡‰çš„ Repository (ä¾‹å¦‚ï¼š<code>esp32-motor-ramping-lab</code>) è¨­å®šè‡³èª²ç¨‹å„€è¡¨æ¿ï¼Œç·´ç¿’é€é BLE
                    å‹•æ…‹èª¿æ ¡é¦¬é”çš„åŠ é€Ÿæ›²ç·šèˆ‡éœæ‘©æ“¦å…‹æœåƒæ•¸ã€‚</p>
            </div>

            <div class="bg-indigo-50 p-4 rounded-lg">
                <h3 class="font-bold text-indigo-800">2. ç¿»è½‰èª²å ‚ç­–ç•¥</h3>
                <ul class="list-disc list-inside text-sm">
                    <li>èª²å‰é ç¿’ï¼šè§€çœ‹ 5 åˆ†é˜é—œæ–¼é¦¬é”ã€Œè»Ÿå•Ÿå‹•ã€èˆ‡ã€Œè»Ÿåœæ­¢ã€å°æ©Ÿæ¢°é›¶ä»¶ä¿è­·ä½œç”¨çš„å‹•æ…‹æ¼”ç¤ºã€‚</li>
                    <li>èª²ä¸­å¯¦ä½œï¼šå¯¦ä½œäºŒé€²ä½çµæ§‹é«”æ˜ å°„ (Binary Struct Mapping)ï¼Œä¸¦èª¿æ•´ Accel Step ä»¥å°‹æ‰¾é¦¬é”åœ¨ä¸åŒè² è¼‰ä¸‹çš„æœ€ä½³ç·šæ€§éŸ¿æ‡‰ã€‚</li>
                </ul>
            </div>

            <div class="bg-white p-4 border border-gray-200 rounded-lg">
                <h3 class="font-bold mb-2">3. å–®å…ƒä»»å‹™ (Unit Tasks)</h3>
                <table class="w-full text-sm">
                    <thead class="bg-gray-100 text-left">
                        <tr>
                            <th class="p-2">ä»»å‹™èªªæ˜</th>
                            <th class="p-2">å»ºè­°æ™‚é–“</th>
                            <th class="p-2">é…åˆ†</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="border-b">
                            <td class="p-2">ã€ä½œæ¥­ 2-1ã€‘å¯¦ä½œ C++ çµæ§‹é«” (Struct) èˆ‡ BLE çš„äºŒé€²ä½æ˜ å°„</td>
                            <td class="p-2">60 min</td>
                            <td class="p-2">40 pts</td>
                        </tr>
                        <tr class="border-b">
                            <td class="p-2">ã€ä½œæ¥­ 2-2ã€‘èª¿æ ¡ `Start Kick` æ•¸å€¼ä»¥å…‹æœéœæ‘©æ“¦åŠ›</td>
                            <td class="p-2">30 min</td>
                            <td class="p-2">30 pts</td>
                        </tr>
                        <tr class="border-b">
                            <td class="p-2">ã€ä½œæ¥­ 2-3ã€‘æ¸¬è©¦ä¸åŒ `Accel Step` ä¸‹çš„èµ·æ­¥æµæš¢åº¦</td>
                            <td class="p-2">45 min</td>
                            <td class="p-2">30 pts</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <section id="instructor-guide" class="hidden">
        <h2>GitHub Classroom è©³ç´°æ“ä½œæŒ‡å—</h2>
        <div class="classroom-guide">
            <p><strong>ç¬¬ä¸€æ­¥ï¼šæº–å‚™ç¯„æœ¬å€‰åº« (Template Repo)</strong></p>
            <ol>
                <li>æä¾›å®Œæ•´çš„ BLE æ¡†æ¶ä½†ç©ºå‡º <code>loop()</code> ä¸­çš„æ¼¸é€²æ¼”ç®—é‚è¼¯ï¼Œå‹¾é¸ <strong>"Template repository"</strong>ã€‚</li>
            </ol>

            <p style="margin-top: 1rem;"><strong>ç¬¬äºŒæ­¥ï¼šå»ºç«‹ Classroom ä½œæ¥­</strong></p>
            <ol>
                <li>å»ºç«‹ä½œæ¥­ä¸¦é€£çµç¯„æœ¬ã€‚é¼“å‹µå­¸ç”Ÿä½¿ç”¨ <strong>PlatformIO</strong> é€²è¡Œç·¨è­¯ï¼Œä¸¦åˆ©ç”¨æœ¬å–®å…ƒç¶²é ä»‹é¢å‹•æ…‹èª¿åƒã€‚</li>
            </ol>

            <p style="margin-top: 1rem;"><strong>ç¬¬ä¸‰æ­¥ï¼šå­¸ç”Ÿç«¯æ“ä½œ (Flipped Workflow)</strong></p>
            <ol>
                <li>å­¸ç”Ÿé ˜å–ä½œæ¥­ï¼Œå¯¦ä½œç·šæ€§æ’å€¼æˆ–ç°¡å–®çš„ <code>currentPWM += step</code> é‚è¼¯ã€‚</li>
                <li>æœ¬åœ°é–‹ç™¼å¾Œ <strong>Push ä»£ç¢¼</strong>ã€‚</li>
            </ol>

            <p style="margin-top: 1rem;"><strong>ç¬¬å››æ­¥ï¼šæ•™å¸«å›é¥‹ (Review)</strong></p>
            <ol>
                <li>é€²å…¥ Feedback PRï¼Œé‡é»æª¢æŸ¥å­¸ç”Ÿæ˜¯å¦è™•ç†äº†ã€Œæµ®é»æ•¸é‹ç®—ã€åœ¨åµŒå…¥å¼ç«¯çš„æ•ˆèƒ½é–‹éŠ·èˆ‡æ•´æ•¸æº¢å‡ºå•é¡Œã€‚</li>
            </ol>
        </div>

        <h2>åœ¨ GitHub Classroom çš„å¯¦æˆ°éƒ¨ç½²å»ºè­°</h2>
        <p>æ­¤å–®å…ƒå¼•å°å­¸ç”Ÿç†è§£é¦¬é” Ramping (æ¼¸é€²åŠ é€Ÿ) çš„ç‰©ç†æ„ç¾©ï¼Œä¸¦å¯¦ä½œäºŒé€²ä½çµæ§‹é«” (Binary Struct) çš„é€šè¨Šå”è­°ï¼Œå»ºè­°ç¯„æœ¬å€‰åº«è¨­ç½®å¦‚ä¸‹ï¼š</p>

        <h3>A. ç¯„æœ¬å€‰åº« (Template Repo) çµæ§‹</h3>
        <pre><code>.
â”œâ”€â”€ src/main.cpp      # (é‡é») åŒ…å«é¦¬é”æ§åˆ¶çµæ§‹é«”èˆ‡ Ramping ç‹€æ…‹æ©Ÿ
â”œâ”€â”€ include/config.h  # å›ºå®šåƒæ•¸é…ç½®
â””â”€â”€ README.md        # å¯¦é©—ç´€éŒ„ï¼šæ¢è¨ä¸åŒ Accel Step ä¸‹çš„åŠ é€ŸéŸ¿æ‡‰</code></pre>

        <h3>B. åƒè€ƒç¯„ä¾‹ä»£ç¢¼ (Reference Example Code)</h3>
        <p><strong>main.cpp (äºŒé€²ä½çµæ§‹é«”å®šç¾©èˆ‡æ¥æ”¶)</strong></p>
        <pre><code>// 1. å¼·åˆ¶ 1-byte å°é½Šï¼Œç¢ºä¿èˆ‡ JS DataView ä¸€è‡´
#pragma pack(push, 1)
struct MotorConfig_t {
  uint32_t controlTimeoutMs;
  int32_t  pwmEffectiveLimitT;
  int32_t  rampAccelStepT;
  // ... å…¶ä»–æ¬„ä½ (å…± 28 Bytes)
};
#pragma pack(pop)

// 2. BLE å›å‘¼å‡½æ•¸ä¸­ç›´æ¥æ˜ å°„
void onWrite(BLECharacteristic* pChar) {
  std::string value = pChar->getValue();
  if (value.length() == sizeof(MotorConfig_t)) {
    MotorConfig_t incoming;
    memcpy(&incoming, value.data(), sizeof(MotorConfig_t));
    // å¥—ç”¨è¨­å®šåˆ°å…¨åŸŸè®Šæ•¸...
  }
}</code></pre>

        <p><strong>Motor Control Logic (Ramping ç‹€æ…‹æ©Ÿ)</strong></p>
        <pre><code>void applyRamping() {
  if (targetPWM > currentPWM) {
    currentPWM = min(targetPWM, currentPWM + rampAccelStepT);
  } else if (targetPWM < currentPWM) {
    currentPWM = max(targetPWM, currentPWM - rampAccelStepT);
  }
  ledcWrite(CHANNEL, currentPWM);
}</code></pre>

        <h3>C. è‡ªå‹•è©•åˆ† (Autograding) çš„è¨­è¨ˆ</h3>
        <ul>
            <li><strong>çµæ§‹æª¢æŸ¥ï¼š</strong> æª¢æŸ¥ <code>main.cpp</code> æ˜¯å¦åŒ…å« <code>#pragma pack(1)</code> æˆ–æ­£ç¢ºçš„åç§»é‡è¨ˆç®—ã€‚</li>
            <li><strong>é£½å’Œé‚è¼¯ï¼š</strong> é©—è­‰ä»£ç¢¼ä¸­æ˜¯å¦åŒ…å«äº†æ­£ç¢ºçš„ <code>constrain(pwm, 0, limit)</code> é£½å’Œè™•ç†ã€‚</li>
        </ul>

        <h2>ç¿»è½‰æ•™å®¤çš„å¯¦æ–½ç­–ç•¥</h2>
        <table border="1" style="width:100%; border-collapse: collapse; margin-top: 1rem;">
            <thead>
                <tr style="background-color: #f8fafc;">
                    <th style="padding: 12px; border: 1px solid #e2e8f0; text-align: left;">éšæ®µ</th>
                    <th style="padding: 12px; border: 1px solid #e2e8f0; text-align: left;">å­¸ç”Ÿè¡Œå‹• (Git Workflow)</th>
                    <th style="padding: 12px; border: 1px solid #e2e8f0; text-align: left;">æ•™å¸«/å¹³å°è§’è‰²</th>
                </tr>
            </thead>
            <tbody style="color: #4b5563;">
                <tr>
                    <td style="padding: 12px; border: 1px solid #e2e8f0;"><strong>èª²å‰ (é ç¿’)</strong></td>
                    <td style="padding: 12px; border: 1px solid #e2e8f0;">ç ”è®€ã€Œè»Ÿå•Ÿå‹•ã€èˆ‡ã€Œç¬é–“å¤§é›»æµå°é‹°é›»æ± å£“é™ã€çš„é—œè¯ã€‚</td>
                    <td style="padding: 12px; border: 1px solid #e2e8f0;"><strong>Dashboardï¼š</strong>ç¢ºèªå­¸ç”Ÿå·²é«”é©—éé¦¬é”èµ·æ­¥çš„åŠ‡çƒˆéœ‡å‹•ã€‚
                    </td>
                </tr>
                <tr>
                    <td style="padding: 12px; border: 1px solid #e2e8f0;"><strong>èª²ä¸­ (å¯¦ä½œ)</strong></td>
                    <td style="padding: 12px; border: 1px solid #e2e8f0;">å¯¦ä½œäºŒé€²ä½çµæ§‹é«”æ˜ å°„ (2-1)ï¼Œä¸¦é€éç¶²é ä»‹é¢å°‹æ‰¾æœ€ä½³ Ramping Stepã€‚
                    </td>
                    <td style="padding: 12px; border: 1px solid #e2e8f0;"><strong>åŠ©æ•™è§’è‰²ï¼š</strong>å”åŠ©è§£æ±º Memory Alignment
                        å°è‡´çš„æ•¸å€¼è§£æä½ç§»ã€‚</td>
                </tr>
                <tr>
                    <td style="padding: 12px; border: 1px solid #e2e8f0;"><strong>èª²å¾Œ (ç²¾é€²)</strong></td>
                    <td style="padding: 12px; border: 1px solid #e2e8f0;">å°‡ä¸åŒé¦¬é”å‹è™Ÿçš„åƒæ•¸å°è£æˆ Profile ä¸¦ Commit è‡³ GitHubã€‚</td>
                    <td style="padding: 12px; border: 1px solid #e2e8f0;"><strong>Feedback PRï¼š</strong>æ ¸ç™¼æœ€çµ‚è©•é‡èˆ‡æ¼”ç®—æ³•å„ªåŒ–å»ºè­°ã€‚
                    </td>
                </tr>
            </tbody>
        </table>
    </section>
</body>

</html>