<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WiFi çµ„æ…‹è¨­å®š - BLE å‚³è¼¸æ“ä½œæŒ‡å— | Vibe Coding</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        /* Custom UI Enhancements */
        .step-card {
            transition: all 0.3s ease;
        }

        .step-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>

<body class="text-gray-800">

    <!-- Hero Section -->
    <header class="bg-gradient-to-r from-slate-800 to-slate-900 text-white py-12">
        <div class="container mx-auto px-4 text-center">
            <h1 class="text-3xl md:text-4xl font-bold mb-4">ğŸ“± WiFi çµ„æ…‹è¨­å®š - BLE å‚³è¼¸æ“ä½œæŒ‡å—</h1>
            <p class="text-slate-300 max-w-2xl mx-auto">
                é€é Web Bluetooth æŠ€è¡“ï¼Œç›´æ¥å¾ç€è¦½å™¨å°‡ WiFi å¸³å¯†å‚³é€è‡³ ESP32 é–‹ç™¼æ¿ã€‚
            </p>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-4xl">

        <!-- Connection Panel -->
        <div class="bg-white rounded-2xl shadow-lg p-6 md:p-8 mb-8 border border-slate-100">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
                    <i class="fa-brands fa-bluetooth text-blue-500"></i>
                    è£ç½®é€£ç·š
                </h2>
                <div id="connectionStatus"
                    class="mt-2 md:mt-0 px-4 py-1.5 bg-slate-100 text-slate-500 rounded-full text-sm font-medium flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-slate-400"></span>
                    æœªé€£ç·š
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <!-- Step 1: Prep -->
                <div class="space-y-4">
                    <h3 class="font-bold text-lg text-slate-700">ç¬¬ä¸€æ­¥ï¼šäº‹å‰æº–å‚™</h3>
                    <ul class="space-y-2 text-sm text-slate-600">
                        <li class="flex items-start gap-2">
                            <i class="fa-brands fa-chrome mt-1 text-green-500"></i>
                            <span>ä½¿ç”¨ Chrome, Edge æˆ– Bluefy (iOS)</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fa-solid fa-power-off mt-1 text-red-500"></i>
                            <span>ç¢ºèª ESP32 å·²é–‹å•Ÿä¸¦å»£æ’­ "esp32..."</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <i class="fa-solid fa-location-dot mt-1 text-blue-500"></i>
                            <span>é–‹å•Ÿç³»çµ±è—ç‰™èˆ‡å®šä½æ¬Šé™</span>
                        </li>
                    </ul>

                    <button id="connectBtn"
                        class="w-full mt-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium shadow-md hover:shadow-lg transition flex justify-center items-center gap-2">
                        <i class="fa-solid fa-bolt"></i>
                        é€£ç·š BLE è£ç½®
                    </button>
                </div>

                <!-- Input Form -->
                <div class="space-y-4 opacity-50 pointer-events-none transition-all duration-300" id="configForm">
                    <h3 class="font-bold text-lg text-slate-700">ç¬¬äºŒæ­¥ï¼šWiFi è³‡è¨Š</h3>

                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">WiFi SSID
                            (åç¨±)</label>
                        <input type="text" id="ssidInput" placeholder="è¼¸å…¥ WiFi åç¨±"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">
                    </div>

                    <div>
                        <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wide mb-1">Password
                            (å¯†ç¢¼)</label>
                        <input type="password" id="passwordInput" placeholder="è¼¸å…¥ WiFi å¯†ç¢¼"
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition">
                    </div>

                    <button id="sendBtn"
                        class="w-full py-3 bg-slate-800 text-white rounded-lg font-medium shadow transition hover:bg-slate-900 flex justify-center items-center gap-2">
                        <i class="fa-regular fa-paper-plane"></i>
                        å‚³é€è¨­å®šè‡³è£ç½®
                    </button>
                    <p id="msgDetails" class="text-xs text-center text-slate-400 min-h-[1.5em]"></p>
                </div>
            </div>
        </div>

        <!-- Warning / Info -->
        <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-12 rounded-r-lg">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa-solid fa-triangle-exclamation text-amber-500"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-amber-700">
                        æ³¨æ„ï¼šä¸€èˆ¬çš„ Line æˆ– Facebook å…§å»ºç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothã€‚IOS ç”¨æˆ¶è«‹ä¸‹è¼‰ Bluefy ç€è¦½å™¨ã€‚
                    </p>
                </div>
            </div>
        </div>

        <hr class="border-slate-200 my-12">

        <!-- Homework Section -->
        <section class="space-y-12">
            <h2 class="text-2xl font-bold text-slate-800 text-center mb-8">ğŸ› ï¸ èª²å¾Œç·´ç¿’èˆ‡æŒ‘æˆ°</h2>

            <div class="grid md:grid-cols-3 gap-6">
                <!-- HW 1-1 -->
                <div onclick="openSubmissionModal('wifi-setup-task-1', 'ä½œæ¥­ 1-1: å‰ç«¯é˜²å‘†èˆ‡ UI å„ªåŒ–')"
                    class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 cursor-pointer relative group hover:shadow-lg transition-all step-card">
                    <div
                        class="w-12 h-12 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-xl font-bold mb-4">
                        1-1</div>
                    <h3 class="font-bold text-lg mb-2">å‰ç«¯é˜²å‘†èˆ‡ UI å„ªåŒ–</h3>
                    <p class="text-sm text-slate-600 mb-4">ç¢ºä¿ä½¿ç”¨è€…ä¸æœƒè¼¸å…¥ç„¡æ•ˆè³‡æ–™å°è‡´è£ç½®å´©æ½°ã€‚</p>
                    <ul class="text-sm text-slate-500 list-disc list-inside space-y-1 mb-4">
                        <li>åŠ å…¥ SSID/å¯†ç¢¼é•·åº¦æª¢æŸ¥</li>
                        <li>ç©ºå€¼æ™‚ç¦ç”¨å‚³é€æŒ‰éˆ•</li>
                        <li>é€£ç·šæˆåŠŸå¾Œçš„èƒŒæ™¯è‰²è®Šæ›</li>
                    </ul>
                    <!-- Hover Overlay -->
                    <div
                        class="absolute inset-0 bg-blue-500/5 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-xl">
                        <span
                            class="bg-white text-blue-600 px-4 py-2 rounded-full font-bold shadow-lg transform translate-y-2 group-hover:translate-y-0 transition-transform">
                            ğŸ“¤ é»æ“Šç¹³äº¤ä½œæ¥­
                        </span>
                    </div>
                </div>

                <!-- HW 1-2 -->
                <div onclick="openSubmissionModal('wifi-setup-task-2', 'ä½œæ¥­ 1-2: é€šè¨Šå”è­°é™¤éŒ¯')"
                    class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 cursor-pointer relative group hover:shadow-lg transition-all step-card">
                    <div
                        class="w-12 h-12 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center text-xl font-bold mb-4">
                        1-2</div>
                    <h3 class="font-bold text-lg mb-2">é€šè¨Šå”è­°é™¤éŒ¯</h3>
                    <p class="text-sm text-slate-600 mb-4">ç†è§£æ•¸æ“šå¦‚ä½•è¢«ç·¨ç¢¼ä¸¦é€éè—ç‰™å‚³è¼¸ã€‚</p>
                    <ul class="text-sm text-slate-500 list-disc list-inside space-y-1 mb-4">
                        <li>ä½¿ç”¨ console.log è§€å¯Ÿç·¨ç¢¼çµæœ</li>
                        <li>æ¸¬è©¦ä¸­æ–‡å­—å…ƒçš„ Byte ä½”ç”¨</li>
                        <li>å¯¦ä½œ try...catch éŒ¯èª¤æ””æˆª</li>
                    </ul>
                    <!-- Hover Overlay -->
                    <div
                        class="absolute inset-0 bg-purple-500/5 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-xl">
                        <span
                            class="bg-white text-purple-600 px-4 py-2 rounded-full font-bold shadow-lg transform translate-y-2 group-hover:translate-y-0 transition-transform">
                            ğŸ“¤ é»æ“Šç¹³äº¤ä½œæ¥­
                        </span>
                    </div>
                </div>

                <!-- HW 1-3 -->
                <div onclick="openSubmissionModal('wifi-setup-task-3', 'ä½œæ¥­ 1-3: ç¡¬é«”é€£ç·šé©—è­‰')"
                    class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 cursor-pointer relative group hover:shadow-lg transition-all step-card">
                    <div
                        class="w-12 h-12 bg-emerald-100 text-emerald-600 rounded-full flex items-center justify-center text-xl font-bold mb-4">
                        1-3</div>
                    <h3 class="font-bold text-lg mb-2">ç¡¬é«”é€£ç·šé©—è­‰</h3>
                    <p class="text-sm text-slate-600 mb-4">é©—è­‰è»Ÿç¡¬é«”æ•´åˆå¾Œçš„ç©©å®šæ€§èˆ‡ NVS å­˜å–ã€‚</p>
                    <ul class="text-sm text-slate-500 list-disc list-inside space-y-1 mb-4">
                        <li>æ–·é›»é‡å•Ÿæ¸¬è©¦è‡ªå‹•é€£ç·š</li>
                        <li>å¤šæ¬¡è¦†å¯«è¨­å®šæ¸¬è©¦ç©©å®šæ€§</li>
                        <li>è—ç‰™å‚³è¼¸è·é›¢æ¥µé™æ¸¬è©¦</li>
                    </ul>
                    <!-- Hover Overlay -->
                    <div
                        class="absolute inset-0 bg-emerald-500/5 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center rounded-xl">
                        <span
                            class="bg-white text-emerald-600 px-4 py-2 rounded-full font-bold shadow-lg transform translate-y-2 group-hover:translate-y-0 transition-transform">
                            ğŸ“¤ é»æ“Šç¹³äº¤ä½œæ¥­
                        </span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Developer Notes -->
        <section class="mt-16 bg-slate-800 text-slate-300 p-8 rounded-xl font-mono text-sm">
            <h3 class="text-white font-bold text-lg mb-4 flex items-center gap-2">
                <i class="fa-solid fa-code"></i> Developer Notes
            </h3>
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h4 class="text-indigo-400 font-bold mb-2">UUID Configuration</h4>
                    <ul class="space-y-2">
                        <li>Service: <span class="break-all text-white">6E400001-B5A3-F393-E0A9-E50E24DCCA9E</span></li>
                        <li>Char (SSID): <span class="break-all text-white">6E400002...</span> (Write)</li>
                        <li>Char (Pwd): <span class="break-all text-white">6E400003...</span> (Write)</li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-pink-400 font-bold mb-2">Key Logic</h4>
                    <p class="mb-2">TextEncoder is used to convert strings to Uint8Array before writing to
                        characteristics.</p>
                    <p>Device auto-restarts upon receiving the password (implied commit).</p>
                </div>
            </div>
        </section>

    </main>

    <!-- Logic Script -->
    <script src="/js/course-shared.js"></script>
    <script>
        const connectBtn = document.getElementById('connectBtn');
        const sendBtn = document.getElementById('sendBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const configForm = document.getElementById('configForm');
        const ssidInput = document.getElementById('ssidInput');
        const passwordInput = document.getElementById('passwordInput');
        const msgDetails = document.getElementById('msgDetails');

        // Bluetooth Constants
        // Nordic UART Service
        const SERVICE_UUID = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
        const CHAR_SSID_UUID = '6e400002-b5a3-f393-e0a9-e50e24dcca9e';
        const CHAR_PWD_UUID = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

        let bluetoothDevice;
        let charSSID;
        let charPWD;

        connectBtn.addEventListener('click', async () => {
            try {
                // Request Device
                console.log('Requesting Bluetooth Device...');
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'esp32' }],
                    optionalServices: [SERVICE_UUID]
                });

                updateStatus('connecting', 'æ­£åœ¨é€£ç·š...');

                // Connect to GATT
                const server = await bluetoothDevice.gatt.connect();
                console.log('Connected to GATT Server');

                // Get Service
                const service = await server.getPrimaryService(SERVICE_UUID);
                console.log('Service found');

                // Get Characteristics
                charSSID = await service.getCharacteristic(CHAR_SSID_UUID);
                charPWD = await service.getCharacteristic(CHAR_PWD_UUID);
                console.log('Characteristics found');

                // Update UI upon success
                onConnected();

                // Handle disconnection
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);

            } catch (error) {
                console.error('Connection failed!', error);

                let msg = 'é€£ç·šå¤±æ•—';
                if (error.name === 'NotFoundError') {
                    msg = 'ä½¿ç”¨è€…å–æ¶ˆé¸æ“‡æˆ–æ‰¾ä¸åˆ°è£ç½®';
                } else if (error.name === 'SecurityError') {
                    msg = 'å®‰å…¨é™åˆ¶ï¼šè«‹ç¢ºä¿æ‚¨ä½¿ç”¨ HTTPS æˆ– localhost';
                }
                alert(msg + '\n' + error.message);
                updateStatus('disconnected', 'æœªé€£ç·š');
            }
        });

        sendBtn.addEventListener('click', async () => {
            const ssid = ssidInput.value;
            const password = passwordInput.value;

            if (!ssid) {
                alert('è«‹è¼¸å…¥ WiFi åç¨± (SSID)');
                return;
            }

            if (!bluetoothDevice || !bluetoothDevice.gatt.connected) {
                alert('è—ç‰™å·²æ–·ç·šï¼Œè«‹é‡æ–°é€£ç·š');
                onDisconnected();
                return;
            }

            try {
                updateStatus('sending', 'å‚³é€ä¸­...');

                const encoder = new TextEncoder();

                // 1. Write SSID
                console.log(`Writing SSID: ${ssid}`);
                await charSSID.writeValue(encoder.encode(ssid));

                // 2. Write Password
                console.log(`Writing Password...`);
                await charPWD.writeValue(encoder.encode(password));

                console.log('Write Complete');
                msgDetails.textContent = 'âœ… è¨­å®šæˆåŠŸå‚³é€! è£ç½®æ­£åœ¨é‡å•Ÿ...';
                msgDetails.className = 'text-green-600 font-bold text-sm text-center mt-2';

                // Usually device disconnects itself after restart, but we can reset UI after a delay
                setTimeout(() => {
                    if (bluetoothDevice.gatt.connected) {
                        bluetoothDevice.gatt.disconnect();
                    }
                }, 3000);

            } catch (error) {
                console.error('Write failed', error);
                alert('å‚³é€å¤±æ•—: ' + error.message);
                updateStatus('connected', 'âœ… å·²é€£ç·š: ' + bluetoothDevice.name);
            }
        });

        function onConnected() {
            updateStatus('connected', 'âœ… å·²é€£ç·š: ' + bluetoothDevice.name);
            connectBtn.disabled = true;
            connectBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            connectBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');

            // Enable Form
            configForm.classList.remove('opacity-50', 'pointer-events-none');

            // Optional: Change BG to indicate success (Homework hint)
            document.body.style.backgroundColor = '#f0f9ff'; // Light Blue
        }

        function onDisconnected() {
            console.log('Device Disconnected');
            updateStatus('disconnected', 'âŒ å·²æ–·ç·š');
            connectBtn.disabled = false;
            connectBtn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            connectBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            connectBtn.innerHTML = '<i class="fa-solid fa-bolt"></i> é‡æ–°é€£ç·š BLE';

            // Disable Form
            configForm.classList.add('opacity-50', 'pointer-events-none');
            document.body.style.backgroundColor = '#f8fafc'; // Reset BG
        }

        function updateStatus(state, text) {
            connectionStatus.innerHTML = '';

            const dot = document.createElement('span');
            dot.className = 'w-2 h-2 rounded-full mr-2';

            if (state === 'connected') {
                dot.classList.add('bg-green-500');
                connectionStatus.classList.replace('text-slate-500', 'text-green-700');
                connectionStatus.classList.replace('bg-slate-100', 'bg-green-100');
            } else if (state === 'connecting' || state === 'sending') {
                dot.classList.add('bg-amber-500', 'animate-pulse');
                connectionStatus.className = 'mt-2 md:mt-0 px-4 py-1.5 bg-amber-100 text-amber-700 rounded-full text-sm font-medium flex items-center';
            } else {
                dot.classList.add('bg-slate-400');
                connectionStatus.className = 'mt-2 md:mt-0 px-4 py-1.5 bg-slate-100 text-slate-500 rounded-full text-sm font-medium flex items-center';
            }

            connectionStatus.appendChild(dot);
            connectionStatus.appendChild(document.createTextNode(text));
        }
    </script>
</body>

</html>