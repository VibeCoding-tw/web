<!doctype html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
    <title>馬達 Ramping 組態設定 - BLE 傳輸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 確保全螢幕高度和柔軟的背景色 */
        body {
            background-color: #1f2937;
            color: #f9fafb;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
        }

        .container-wrap {
            max-width: 500px;
            /* 稍微放大容器以容納更多欄位 */
            width: 100%;
            padding: 30px;
            background-color: #1f2937;
            border-radius: 1.5rem;
        }

        /* 頂部控制列 */
        .top-control {
            width: 100%;
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 20px;
        }

        /* 按鈕樣式 (Connect / Send) */
        button {
            padding: 12px 16px;
            border-radius: 12px;
            border: none;
            background: #4f46e5;
            /* 靛藍色 */
            color: white;
            font-weight: 700;
            /* Neumorphic 外凸效果 */
            box-shadow: 3px 3px 6px #171d26, -3px -3px 6px #273142;
            transition: all 0.15s ease-in-out;
        }

        button:hover {
            background: #3730a3;
            box-shadow: 5px 5px 10px #171d26, -5px -5px 10px #273142;
        }

        button:disabled {
            background: #374151;
            color: #9ca3af;
            box-shadow: none;
            cursor: not-allowed;
        }

        /* 狀態顯示區域 - 內凹樣式 */
        #statusLog {
            flex: 1;
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: #9ca3af;
            padding: 12px;
            background: #2d3748;
            border-radius: 12px;
            /* Neumorphic 內凹效果 */
            box-shadow: inset 3px 3px 6px #171d26, inset -3px -3px 6px #3b4555;
        }

        .log-success {
            color: #4ade80 !important;
        }

        .log-error {
            color: #f87171 !important;
        }

        .log-info {
            color: #60a5fa !important;
        }

        /* 輸入框樣式 */
        input[type="number"] {
            width: 100%;
            padding: 12px;
            margin-top: 4px;
            border-radius: 10px;
            border: none;
            background: #2d3748;
            color: #f9fafb;
            font-weight: 500;
            /* 深色內凹效果 */
            box-shadow: inset 3px 3px 6px #171d26, inset -3px -3px 6px #3b4555;
            transition: box-shadow 0.15s;
        }

        input[type="number"]:focus {
            outline: none;
            background: #232d3a;
            /* 輕微的亮光效果 */
            box-shadow: inset 2px 2px 4px #171d26, inset -2px -2px 4px #3b4555, 0 0 5px #4f46e5;
        }

        /* 返回主選單按鈕 */
        .menu-button {
            display: block;
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: none;
            background: #4f46e5;
            color: white;
            font-weight: 700;
            text-align: center;
            text-decoration: none;
            box-shadow: 3px 3px 6px #171d26, -3px -3px 6px #273142;
            transition: all 0.2s ease;
        }
    </style>
</head>

<body class="p-4">
    <div class="container-wrap">

        <h1 class="text-2xl font-extrabold text-center text-indigo-400 mb-6 border-b border-gray-700 pb-2">
            馬達 Ramping 組態設定
        </h1>

        <!-- 頂部控制列：連線按鈕與狀態 -->
        <div class="top-control">
            <button id="btnConnect" class="flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <span>連線 BLE</span>
            </button>

            <div id="statusLog">
                等待連線...
            </div>
        </div>

        <!-- 設定參數表單 -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl space-y-4">
            <p class="text-sm font-bold text-indigo-300 mb-4">
                MotorConfig_t 參數 (共 28 Bytes)
            </p>

            <div class="grid grid-cols-1 gap-4">
                <!-- controlTimeoutMs (unsigned long, 4 bytes) - 獨立一行，放大寬度 -->
                <div class="space-y-1 col-span-1">
                    <label for="controlTimeoutMs" class="block text-sm font-medium text-gray-400">controlTimeoutMs
                        (ms)</label>
                    <!-- 初始值設定為空，連線後由裝置讀取，或由使用者輸入 -->
                    <input type="number" id="controlTimeoutMs" value="" min="0" required placeholder="例如: 1000">
                </div>
            </div>

            <!-- 其餘 6 個欄位，二二並排 -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                <!-- 1左. pwmEffectiveLimitS (int, 4 bytes) -->
                <div class="space-y-1">
                    <label for="pwmEffectiveLimitS"
                        class="block text-sm font-medium text-gray-400">pwmEffectiveLimitS</label>
                    <input type="number" id="pwmEffectiveLimitS" value="" min="0" required placeholder="例如: 255">
                </div>

                <!-- 1右. pwmEffectiveLimitT (int, 4 bytes) -->
                <div class="space-y-1">
                    <label for="pwmEffectiveLimitT"
                        class="block text-sm font-medium text-gray-400">pwmEffectiveLimitT</label>
                    <input type="number" id="pwmEffectiveLimitT" value="" min="0" required placeholder="例如: 255">
                </div>

                <!-- 2左. rampAccelStepS (int, 4 bytes) -->
                <div class="space-y-1">
                    <label for="rampAccelStepS" class="block text-sm font-medium text-gray-400">rampAccelStepS</label>
                    <input type="number" id="rampAccelStepS" value="" min="0" required placeholder="例如: 10">
                </div>

                <!-- 2右. rampAccelStepT (int, 4 bytes) -->
                <div class="space-y-1">
                    <label for="rampAccelStepT" class="block text-sm font-medium text-gray-400">rampAccelStepT</label>
                    <input type="number" id="rampAccelStepT" value="" min="0" required placeholder="例如: 10">
                </div>

                <!-- 3左. pwmStartKickS (int, 4 bytes) -->
                <div class="space-y-1">
                    <label for="pwmStartKickS" class="block text-sm font-medium text-gray-400">pwmStartKickS</label>
                    <input type="number" id="pwmStartKickS" value="" min="0" required placeholder="例如: 50">
                </div>

                <!-- 3右. pwmStartKickT (int, 4 bytes) -->
                <div class="space-y-1">
                    <label for="pwmStartKickT" class="block text-sm font-medium text-gray-400">pwmStartKickT</label>
                    <input type="number" id="pwmStartKickT" value="" min="0" required placeholder="例如: 50">
                </div>

            </div>

            <button id="btnSend"
                class="mt-6 w-full bg-indigo-600 text-white p-4 rounded-xl font-bold transition duration-150 hover:bg-indigo-700 disabled:opacity-50"
                disabled>
                讀取/傳送 馬達組態設定
            </button>

            <p class="text-center text-xs text-gray-500 pt-2">
                點擊上方按鈕讀取/儲存 7 個 4-byte 參數 (共 28 Bytes)
            </p>
        </div>

        <!-- 返回主選單按鈕 -->
        <a href="../index.html"
            class="menu-button w-full mt-8 text-center bg-gray-700 hover:bg-gray-600 text-gray-300 p-3 block rounded-xl shadow-md transition">
            返回主選單
        </a>
    </div>

    <!-- 引入 Quantifier 和 BLE Client 模組 -->
    <script src="../js/quantifier.js"></script>
    <script src="../js/ble-client.js"></script>

    <script>
        // --- BLE Configuration ---
        const MOTOR_SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c0ffee00dead';
        const MOTOR_CHARACTERISTIC_UUID = '4fafc203-1fb5-459e-8fcc-c0ffee02dead';
        const DEVICE_ID_KEY = 'ble_motor_config_device_id';
        const LITTLE_ENDIAN = true;

        // --- DOM Elements ---
        const statusLog = document.getElementById('statusLog');
        const btnConnect = document.getElementById('btnConnect');
        const btnSend = document.getElementById('btnSend');

        // 欄位 ID 陣列
        const PARAM_IDS = [
            { id: 'controlTimeoutMs', type: 'Uint32', offset: 0 },
            { id: 'pwmEffectiveLimitT', type: 'Int32', offset: 4 },
            { id: 'rampAccelStepT', type: 'Int32', offset: 8 },
            { id: 'pwmStartKickT', type: 'Int32', offset: 12 },
            { id: 'pwmEffectiveLimitS', type: 'Int32', offset: 16 },
            { id: 'rampAccelStepS', type: 'Int32', offset: 20 },
            { id: 'pwmStartKickS', type: 'Int32', offset: 24 }
        ];

        // --- Helper Functions ---

        function logStatus(message, type = 'info') {
            let typeClass = type === 'success' ? 'log-success' : (type === 'error' ? 'log-error' : 'log-info');
            statusLog.classList.remove('log-success', 'log-error', 'log-info');
            statusLog.classList.add(typeClass);
            statusLog.innerHTML = message;
        }

        function updateUI(isConnected) {
            if (isConnected) {
                btnConnect.querySelector('span').textContent = '斷開';
                btnSend.disabled = false;
                btnSend.textContent = '傳送設定至裝置';
            } else {
                btnConnect.querySelector('span').textContent = '連線 BLE';
                btnSend.disabled = true;
                btnSend.textContent = '讀取/傳送 馬達組態設定';
            }
        }

        function clearInputFields() {
            PARAM_IDS.forEach(param => {
                const element = document.getElementById(param.id);
                if (element) element.value = "";
            });
        }

        // --- Logic ---

        function onDisconnect() {
            logStatus('❌ 已斷線', 'error');
            updateUI(false);
            clearInputFields();
        }

        async function readConfig() {
            try {
                logStatus('正在從裝置讀取設定值...', 'info');
                btnSend.disabled = true;

                // 使用 bleClient 讀取
                const value = await window.bleClient.read();
                const dataView = value; // readValue returns DataView

                if (value.byteLength !== 28) {
                    logStatus(`⚠️ 讀取數據長度錯誤: ${value.byteLength} bytes (預期 28 bytes)`, 'error');
                    return;
                }

                PARAM_IDS.forEach(param => {
                    let val;
                    const element = document.getElementById(param.id);
                    if (param.offset + 4 > dataView.byteLength) return;

                    if (param.type === 'Uint32') {
                        val = dataView.getUint32(param.offset, LITTLE_ENDIAN);
                    } else {
                        val = dataView.getInt32(param.offset, LITTLE_ENDIAN);
                    }

                    if (element) element.value = val;
                });

                logStatus('✅ 設定值讀取成功!', 'success');
            } catch (err) {
                logStatus(`❌ 讀取設定失敗: ${err.message}`, 'error');
                console.error('BLE Read Error:', err);
            } finally {
                btnSend.disabled = false;
            }
        }

        async function connectBLE() {
            if (!navigator.bluetooth) return;

            // 如果已連線，則斷開
            if (window.bleClient.connected) {
                window.bleClient.disconnect();
                return; // onDisconnect callback 會處理 UI
            }

            try {
                logStatus('準備連線...', 'info');

                // 註冊斷線回調 (只註冊一次)
                if (window.bleClient.onDisconnectCallbacks.indexOf(onDisconnect) === -1) {
                    window.bleClient.onDisconnectCallbacks.push(onDisconnect);
                }

                const device = await window.bleClient.connect(MOTOR_SERVICE_UUID, MOTOR_CHARACTERISTIC_UUID);

                logStatus('✅ 已連線: ' + device.name, 'success');
                updateUI(true);

                // 連線成功後讀取
                await readConfig();

            } catch (err) {
                console.error('BLE 連線失敗:', err);
                logStatus(`❌ 連線失敗 (${err.message})`, 'error');
                updateUI(false);
                clearInputFields();
            }
        }

        async function sendConfig() {
            if (!window.bleClient.connected) {
                logStatus('⚠️ 請先連線到 BLE 裝置。', 'info');
                return;
            }

            const buffer = new ArrayBuffer(28);
            const dataView = new DataView(buffer);

            try {
                PARAM_IDS.forEach(param => {
                    const element = document.getElementById(param.id);
                    const value = parseInt(element.value);
                    if (isNaN(value)) throw new Error(`欄位 ${param.id} 包含無效數值。`);

                    if (param.type === 'Uint32') {
                        dataView.setUint32(param.offset, value, LITTLE_ENDIAN);
                    } else {
                        dataView.setInt32(param.offset, value, LITTLE_ENDIAN);
                    }
                });

                logStatus('傳送 28-byte 馬達組態設定...', 'info');
                btnSend.disabled = true;

                // 使用 bleClient 寫入
                await window.bleClient.write(buffer);

                logStatus('✅ 設定已成功傳送! (28 Bytes)', 'success');

            } catch (err) {
                logStatus(`❌ 傳送失敗: ${err.message}`, 'error');
            } finally {
                btnSend.disabled = false;
            }
        }

        // --- Initialization ---

        btnConnect.addEventListener('click', connectBLE);
        btnSend.addEventListener('click', sendConfig);

        if (!navigator.bluetooth) {
            logStatus('❌ 瀏覽器不支援 Web Bluetooth。', 'error');
            btnConnect.disabled = true;
            btnConnect.querySelector('span').textContent = "不支援";
        } else {
            clearInputFields();
        }
    </script>
</body>

</html>