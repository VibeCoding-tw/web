<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Coding å¾…çµå¸³é …ç›®</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body class="bg-gray-50 flex flex-col min-h-screen">
    <div id="nav-placeholder"></div>
    <script src="js/nav-component.js?v=3"></script>
    <script>
        renderNav('.', { showAuth: true });
    </script>

    <main class="max-w-4xl mx-auto p-6">
        <section class="bg-white p-6 rounded-lg shadow-xl mb-10">
            <h2 class="text-3xl font-extrabold text-gray-800 border-b pb-4 mb-6">å¾…çµå¸³é …ç›®</h2>

            <div id="auth-error-message" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4"
                role="alert">
                <p class="font-bold">ç™»å…¥å¤±æ•—é€šçŸ¥</p>
                <p id="error-details">æ‚¨çš„ç™»å…¥å˜—è©¦å¤±æ•—ï¼ŒåŸå› å¯èƒ½ç‚ºç€è¦½å™¨é˜»æ“‹ã€‚æˆ‘å€‘å·²åˆ‡æ›åˆ°ã€Œé é¢é‡æ–°å°å‘ã€æ–¹å¼ï¼Œè«‹é‡æ–°é»æ“Šç™»å…¥ã€‚</p>
            </div>

            <div id="unpaid-items" class="space-y-4">
            </div>
            <p id="empty-cart-msg" class="text-gray-500 italic text-center pt-4">è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼è«‹å›åˆ°èª²ç¨‹é é¢é¸è³¼ã€‚</p>

            <div id="cart-summary" class="mt-8 pt-4 border-t-2 border-dashed border-gray-200">
                <div class="flex justify-between items-center text-2xl font-bold text-gray-800">
                    <span>ç¸½é‡‘é¡ (TWD):</span>
                    <span id="cart-total">0</span>
                </div>
                <div id="payment-form-container" class="hidden"></div>

                <!-- [NEW] Shipping Information Section -->
                <div id="shipping-info-section" class="hidden mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="text-lg font-bold text-gray-800 mb-3">ğŸ“¦ æ”¶ä»¶èˆ‡ç‰©æµè³‡è¨Š (å¯¦é«”å•†å“å¿…å¡«)</h3>

                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æ”¶ä»¶äººå§“å</label>
                            <input type="text" id="receiver-name"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"
                                placeholder="è«‹è¼¸å…¥çœŸå¯¦å§“å (éœ€æ ¸å°è­‰ä»¶)">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">æ”¶ä»¶äººæ‰‹æ©Ÿ</label>
                            <input type="tel" id="receiver-phone"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm p-2"
                                placeholder="09xxxxxxxx">
                        </div>

                        <div class="pt-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">å–è²¨é–€å¸‚</label>
                            <div id="store-display" class="bg-white p-3 border rounded-md mb-2 text-sm text-gray-600">
                                å°šæœªé¸æ“‡é–€å¸‚
                            </div>
                            <input type="hidden" id="store-id">
                            <input type="hidden" id="store-name">
                            <input type="hidden" id="store-address">

                            <div class="flex gap-2">
                                <button onclick="openMap('UNIMART')"
                                    class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">é¸æ“‡
                                    7-11</button>
                                <button onclick="openMap('FAMI')"
                                    class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">é¸æ“‡
                                    å…¨å®¶</button>
                                <button onclick="openMap('HILIFE')"
                                    class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">é¸æ“‡
                                    èŠçˆ¾å¯Œ</button>
                                <button onclick="openMap('OKMART')"
                                    class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">é¸æ“‡
                                    OK</button>
                            </div>
                        </div>
                    </div>
                </div>

                <button id="checkout-btn"
                    class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white text-lg py-3 rounded-lg disabled:opacity-50"
                    disabled>
                    ğŸ’³ å‰å¾€ä»˜æ¬¾
                </button>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 py-8 border-t border-gray-700 mt-10">
        <div class="container mx-auto px-4 text-center">
            <div class="flex justify-center space-x-6 mb-6 text-gray-400">
                <a href="prepare.html" class="hover:text-white">èª²å‰æº–å‚™</a>
                <a href="started.html" class="hover:text-white">å…¥é–€èª²ç¨‹</a>
                <a href="basic.html" class="hover:text-white">åŸºç¤å¯¦ä½œ</a>
                <a href="advanced.html" class="hover:text-white">é€²éšæ‡‰ç”¨</a>
            </div>

            <div class="border-t border-gray-700 pt-6">
                <p class="text-gray-500 text-sm mb-2">&copy; 2025 Vibe Coding. All rights reserved.</p>
                <div class="flex flex-col md:flex-row justify-center items-center gap-2 md:gap-6 text-sm text-gray-400">
                    <span>ç‡Ÿæ¥­äººåç¨±ï¼šè…³ä¸«å¥åº·ç§‘æŠ€æœ‰é™å…¬å¸</span>
                    <span class="hidden md:inline">|</span>
                    <span>çµ±ä¸€ç·¨è™Ÿï¼š80187668</span>
                    <span class="hidden md:inline">|</span>
                    <span>èª²ç¨‹åˆä½œæ´½è«‡ï¼šinfo@vibe-coding.tw</span>
                </div>
            </div>
        </div>
    </footer>



    <script type="module">
        // 1. åŒ¯å…¥å¿…è¦çš„ Firebase å‡½å¼
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-functions.js";

        // 2. Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyCO6Y6Pa7b7zbieJIErysaNF6-UqbT8KJw",
            authDomain: "e-learning-942f7.firebaseapp.com",
            projectId: "e-learning-942f7",
            storageBucket: "e-learning-942f7.firebasestorage.app",
            messagingSenderId: "878397058574",
            appId: "1:878397058574:web:28aaa07a291ee3baab165f"
        };

        // 3. åˆå§‹åŒ– Firebase æœå‹™
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const functions = getFunctions(app, 'asia-east1');

        // ä¿®æ”¹ç‚ºé€šç”¨çš„ä»˜æ¬¾è«‹æ±‚ Function (å¾Œç«¯éœ€é…åˆä¿®æ”¹)
        const initiatePayment = httpsCallable(functions, 'initiatePayment');

        // æ‚¨çš„å•†åº—ä»£è™Ÿ (å…¬é–‹è³‡è¨Šå¯æ”¾åœ¨å‰ç«¯)
        const MERCHANT_ID = "3271550";
        // æ³¨æ„ï¼šHashKey å’Œ HashIV è«‹å‹™å¿…è¨­å®šåœ¨ Firebase Cloud Functions çš„ç’°å¢ƒè®Šæ•¸ä¸­ï¼Œä¸è¦å¯«åœ¨é€™è£¡ï¼

        // ===============================================
        // A. è³¼ç‰©è»Šé …ç›®æ¸²æŸ“é‚è¼¯
        // ===============================================

        const unpaidItemsContainer = document.getElementById('unpaid-items');
        const emptyMsg = document.getElementById('empty-cart-msg');
        const cartTotalElement = document.getElementById('cart-total');
        const checkoutBtn = document.getElementById('checkout-btn');
        const paymentFormContainer = document.getElementById('payment-form-container');

        function removeFromCart(productId) {
            let cart = JSON.parse(localStorage.getItem('vibeCodingCart') || '{}');
            delete cart[productId];
            localStorage.setItem('vibeCodingCart', JSON.stringify(cart));
            renderCartItems();
        }

        function renderCartItems() {
            const cart = JSON.parse(localStorage.getItem('vibeCodingCart') || '{}');
            let total = 0;

            unpaidItemsContainer.innerHTML = '';

            if (Object.keys(cart).length === 0) {
                emptyMsg.style.display = 'block';
                cartTotalElement.textContent = '0';
                checkoutBtn.disabled = true;
                return;
            } else {
                emptyMsg.style.display = 'none';
            }

            for (const [id, item] of Object.entries(cart)) {
                const price = parseFloat(item.price) || 0;
                const quantity = parseInt(item.quantity) || 1;
                const itemTotal = price * quantity;
                total += itemTotal;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-md border';
                itemDiv.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${item.name}</p>
                        <p class="text-xs text-gray-500">ç”¢å“ä»£è™Ÿ: ${id}</p>
                    </div>
                    <div class="text-right">
                         <p class="font-bold text-indigo-600">${itemTotal.toLocaleString()} å…ƒ</p>
                         <button class="remove-cart-item-btn" data-product-id="${id}">ç§»é™¤</button>
                    </div>
                `;
                unpaidItemsContainer.appendChild(itemDiv);
            }

            cartTotalElement.textContent = total.toLocaleString();
            checkoutBtn.disabled = (total === 0);

            document.querySelectorAll('.remove-cart-item-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    removeFromCart(event.currentTarget.dataset.productId);
                });
            });
        }

        renderCartItems();

        // ===============================================
        // A-2. ç‰©æµèˆ‡å¯¦é«”å•†å“é‚è¼¯ (æ–°å¢)
        // ===============================================
        const shippingSection = document.getElementById('shipping-info-section');
        const receiverNameInput = document.getElementById('receiver-name');
        const receiverPhoneInput = document.getElementById('receiver-phone');
        const storeDisplay = document.getElementById('store-display');
        const storeIdInput = document.getElementById('store-id');
        const storeNameInput = document.getElementById('store-name');
        const storeAddressInput = document.getElementById('store-address');

        // 1. æª¢æŸ¥æ˜¯å¦åŒ…å«å¯¦é«”å•†å“
        function checkPhysicalItems() {
            const cart = JSON.parse(localStorage.getItem('vibeCodingCart') || '{}');
            let hasPhysical = false;
            for (const item of Object.values(cart)) {
                if (item.isPhysical) {
                    hasPhysical = true;
                    break;
                }
            }

            if (hasPhysical) {
                shippingSection.classList.remove('hidden');
            } else {
                shippingSection.classList.add('hidden');
            }
            return hasPhysical;
        }

        // é é¢è¼‰å…¥æ™‚æª¢æŸ¥
        const hasPhysicalGoods = checkPhysicalItems();

        // 2. è™•ç†å¾ Map è¿”å›çš„åƒæ•¸
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const action = urlParams.get('action');
            if (action === 'storeSelected') {
                const sId = urlParams.get('storeId');
                const sName = urlParams.get('storeName');
                const sAddr = urlParams.get('address');

                if (sId) {
                    storeIdInput.value = sId;
                    storeNameInput.value = sName;
                    storeAddressInput.value = sAddr;
                    storeDisplay.textContent = `[${sId}] ${sName} - ${sAddr}`;
                    storeDisplay.classList.add('text-green-700', 'font-bold');

                    // æ¢å¾©é¡¯ç¤º (å› ç‚ºé‡æ•´å¾Œ JS æœƒé‡æ–°åŸ·è¡Œ checkPhysicalItems)
                    // ä½†æˆ‘å€‘éœ€è¦ç¢ºä¿ cart é‚„æœ‰æ±è¥¿
                    checkPhysicalItems();
                }
            }
        });

        // 3. é–‹å•Ÿé›»å­åœ°åœ–
        window.openMap = function (logisticsSubType) {
            // æ§‹å»º Form POST åˆ°ç¶ ç•Œ Map
            // æ³¨æ„ï¼šé€™è£¡æ˜¯ç›´æ¥ POST åˆ°ç¶ ç•Œï¼ŒServerReplyURL è¦æŒ‡å‘æˆ‘å€‘çš„ mapReply Function

            const mapForm = document.createElement('form');
            mapForm.method = 'POST';
            mapForm.action = 'https://logistics.ecpay.com.tw/Express/map'; // æ­£å¼ç’°å¢ƒ
            // mapForm.action = 'https://logistics-stage.ecpay.com.tw/Express/map'; // æ¸¬è©¦ç’°å¢ƒ (è‹¥éœ€è¦)

            const params = {
                MerchantID: MERCHANT_ID,
                MerchantTradeNo: 'MAP' + Date.now(), // è‡¨æ™‚å–®è™Ÿ
                LogisticsType: 'CVS',
                LogisticsSubType: logisticsSubType,
                IsCollection: 'N',
                ServerReplyURL: 'https://asia-east1-e-learning-942f7.cloudfunctions.net/mapReply' // é‡è¦ï¼šå›å‚³ç¶²å€
            };

            for (const key in params) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = params[key];
                mapForm.appendChild(input);
            }

            document.body.appendChild(mapForm);
            mapForm.submit();
        };

        // ===============================================
        // B. èº«ä»½é©—è­‰é‚è¼¯
        // ===============================================

        async function handleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("ç™»å…¥å¤±æ•—:", error);
            }
        }

        async function handleLogout() {
            await signOut(auth);
            onAuthStateChanged(auth, () => { });
        }

        onAuthStateChanged(auth, (user) => {
            const userDisplay = document.getElementById('user-display');
            const loginBtn = document.getElementById('login-btn');

            if (user) {
                userDisplay.textContent = `æ‚¨å¥½, ${user.displayName || user.email}`;
                loginBtn.textContent = 'ç™»å‡º';
                loginBtn.onclick = handleLogout;
            } else {
                userDisplay.textContent = 'è¨ªå®¢æ¨¡å¼';
                loginBtn.textContent = 'ç™»å…¥ / è¨»å†Š';
                loginBtn.onclick = handleLogin;
            }
        });

        // ===============================================
        // C. ä»˜æ¬¾æŒ‰éˆ•é‚è¼¯ (å·²é‡å°æ–°é‡‘æµä¿®æ­£)
        // ===============================================

        checkoutBtn.addEventListener('click', () => {
            const totalText = cartTotalElement.textContent.replace(/,/g, '').trim();
            const total = parseInt(totalText);

            if (total <= 0) {
                alert("è³¼ç‰©è»Šç‚ºç©ºï¼Œç„¡æ³•çµå¸³ã€‚");
                return;
            }

            if (!auth.currentUser) {
                alert("è«‹å…ˆç™»å…¥æ‰èƒ½é€²è¡Œä»˜æ¬¾ï¼è«‹é»æ“Šå³ä¸Šè§’æŒ‰éˆ•ç™»å…¥ã€‚");
                return;
            }

            const cartItems = JSON.parse(localStorage.getItem('vibeCodingCart') || '{}');
            const user = auth.currentUser;

            // å‘¼å«è™•ç†æ–°é‡‘æµ (è—æ–°) çš„å‡½å¼
            handlePaymentCheckout(user, total, cartItems);
        });

        // ... (å‰é¢çš„ç¨‹å¼ç¢¼ä¸è®Š)

        /**
         * è™•ç†ä»˜æ¬¾çµå¸³æµç¨‹ (ç¶ ç•Œç‰ˆ)
         */
        async function handlePaymentCheckout(user, total, cartItems) {

            // [NEW] é©—è­‰å¯¦é«”å•†å“æ¬„ä½
            const hasPhysical = checkPhysicalItems();
            let logisticsInfo = null;

            if (hasPhysical) {
                const rName = receiverNameInput.value.trim();
                const rPhone = receiverPhoneInput.value.trim();
                const sId = storeIdInput.value;

                if (!rName || !rPhone || !sId) {
                    alert('è«‹å®Œæ•´å¡«å¯«æ”¶ä»¶äººå§“åã€æ‰‹æ©Ÿä¸¦é¸æ“‡å–è²¨é–€å¸‚ï¼');
                    return;
                }
                logisticsInfo = {
                    receiverName: rName,
                    receiverPhone: rPhone,
                    storeId: sId,
                    storeName: storeNameInput.value,
                    storeAddress: storeAddressInput.value
                };
            }

            checkoutBtn.disabled = true;
            checkoutBtn.textContent = 'ğŸ”’ æ­£åœ¨é€£æ¥ç¶ ç•Œé‡‘æµ...';

            try {
                const response = await initiatePayment({
                    amount: total,
                    userId: user.uid,
                    cartDetails: cartItems,
                    logistics: logisticsInfo, // [NEW] Pass logistics info
                    // è¨­å®šäº¤æ˜“å®Œæˆå¾Œçš„è¿”å›ç¶²å€
                    returnUrl: window.location.origin + '/payment-return.html'
                });

                const data = response.data;

                if (data && data.paymentParams) {
                    console.log("å–å¾—ç¶ ç•Œåƒæ•¸æˆåŠŸï¼Œæ­£åœ¨è·³è½‰...");
                    checkoutBtn.textContent = 'ğŸš€ å‰å¾€ä»˜æ¬¾é é¢...';

                    // åŸ·è¡Œç¶ ç•Œè¡¨å–®æäº¤
                    submitECPayForm(data.paymentParams, data.apiUrl);
                } else {
                    throw new Error('ç„¡æ³•å–å¾—äº¤æ˜“åƒæ•¸ã€‚');
                }

            } catch (error) {
                console.error("çµå¸³å¤±æ•—:", error);
                alert(`çµå¸³å¤±æ•—ï¼š${error.message}`);
                checkoutBtn.disabled = false;
                checkoutBtn.textContent = 'ğŸ’³ å‰å¾€ä»˜æ¬¾';
            }
        }

        /**
         * å»ºç«‹ä¸¦é€å‡ºç¶ ç•Œ (ECPay) è¡¨å–®
         */
        function submitECPayForm(params, apiUrl) {
            const form = document.createElement('form');
            form.method = 'post';
            form.action = apiUrl; // ç¶ ç•Œçš„ API ç¶²å€

            // å°‡å¾Œç«¯å›å‚³çš„æ‰€æœ‰åƒæ•¸è½‰ç‚º hidden input
            for (const key in params) {
                if (params.hasOwnProperty(key)) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = params[key];
                    form.appendChild(input);
                }
            }

            paymentFormContainer.appendChild(form);
            form.submit();
        }
    </script>
</body>

</html>