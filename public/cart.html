<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Coding å¾…çµå¸³é …ç›®</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* çµ±ä¸€ç§»é™¤æŒ‰éˆ•æ¨£å¼ */
        .remove-cart-item-btn {
            color: #ef4444; /* red-500 */
            font-size: 0.75rem; /* text-xs */
            transition: color 0.2s;
        }
        .remove-cart-item-btn:hover {
            text-decoration: underline;
            color: #b91c1c; /* red-700 */
        }

        /* ä¸‹æ‹‰é¸å–® */
        .dropdown:hover .dropdown-menu { display: block; }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <nav class="bg-white/90 backdrop-blur-md shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center py-4">
                <a href="index.html" class="text-2xl font-extrabold text-blue-900 tracking-tight flex items-center gap-2">
                    <span>ğŸš€</span> Vibe Coding
                </a>

                <div class="hidden md:flex items-center space-x-6 font-medium text-gray-600">
                    <div class="relative dropdown group">
                        <button class="flex items-center hover:text-cyan-600 transition cursor-pointer py-2">
                            èª²ç¨‹é€£çµ <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="dropdown-menu absolute hidden bg-white shadow-xl rounded-lg py-2 w-48 mt-0 border border-gray-100 left-0">
                            <a href="prepare.html" class="block px-4 py-2 hover:bg-cyan-50 hover:text-cyan-700">èª²å‰æº–å‚™</a>
                            <a href="started.html" class="block px-4 py-2 hover:bg-cyan-50 hover:text-cyan-700">å…¥é–€èª²ç¨‹</a>
                            <a href="basic.html" class="block px-4 py-2 hover:bg-cyan-50 hover:text-cyan-700">åŸºç¤å¯¦ä½œ</a>
                            <a href="advanced.html" class="block px-4 py-2 hover:bg-cyan-50 hover:text-cyan-700">é€²éšæ‡‰ç”¨</a>
                        </div>
                    </div>

                    <div class="relative dropdown group">
                        <button class="flex items-center hover:text-cyan-600 transition cursor-pointer py-2">
                            çµ„æ…‹è¨­å®š <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="dropdown-menu absolute hidden bg-white shadow-xl rounded-lg py-2 w-48 mt-0 border border-gray-100 left-0">
                            <a href="examples/wifi-config.html" class="block px-4 py-2 hover:bg-cyan-50 hover:text-cyan-700">WiFi è¨­å®š</a>
                            <a href="examples/motor-config.html" class="block px-4 py-2 hover:bg-cyan-50 hover:text-cyan-700">é¦¬é”è¨­å®š</a>
                        </div>
                    </div>

                    <div class="relative dropdown group">
                        <button class="flex items-center hover:text-cyan-600 transition cursor-pointer py-2">
                            é—œæ–¼æˆ‘å€‘ <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <div class="dropdown-menu absolute hidden bg-white shadow-xl rounded-lg py-2 w-48 mt-0 border border-gray-100 left-0">
                            <a href="faq.html" class="block px-4 py-2 hover:bg-cyan-50 hover:text-cyan-700">èª²ç¨‹å¸¸è¦‹å•é¡Œ</a>
                            <a href="about.html" class="block px-4 py-2 hover:bg-cyan-50 hover:text-cyan-700">é—œæ–¼ä»˜è²»èˆ‡è³¼è²·</a>
                            <a href="collaboration.html" class="block px-4 py-2 hover:bg-cyan-50 hover:text-cyan-700">åˆä½œäº‹å®œ</a>
                        </div>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <a href="cart.html" class="text-gray-600 hover:text-cyan-600 transition duration-150 relative" title="å‰å¾€è³¼ç‰©è»Š">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.2 4h12.4M15 13H7" />
                        </svg>
                    </a>
                    
                    <div id="auth-status" class="text-sm flex items-center">
                        <span id="user-display" class="text-gray-600 hidden md:inline mr-2">è¨ªå®¢</span>
                        <button id="login-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm py-2 px-4 rounded-full transition shadow-md">ç™»å…¥</button>
                    </div>

                    <div class="md:hidden ml-2">
                        <button id="mobile-menu-btn" class="text-gray-600 focus:outline-none p-2 border rounded hover:bg-gray-100">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                    </div>
                </div>
            </div>

            <div id="mobile-menu" class="hidden md:hidden pb-4 border-t border-gray-100 mt-2">
                <div class="flex flex-col space-y-3 pt-4 font-medium text-gray-600">
                    <div class="pl-2 border-l-2 border-gray-200 ml-2">
                        <p class="text-xs text-gray-400 mb-1 uppercase">èª²ç¨‹é€£çµ</p>
                        <a href="prepare.html" class="block py-1 hover:text-cyan-600">èª²å‰æº–å‚™</a>
                        <a href="started.html" class="block py-1 hover:text-cyan-600">å…¥é–€èª²ç¨‹</a>
                        <a href="basic.html" class="block py-1 hover:text-cyan-600">åŸºç¤å¯¦ä½œ</a>
                        <a href="advanced.html" class="block py-1 hover:text-cyan-600">é€²éšæ‡‰ç”¨</a>
                    </div>

                    <div class="pl-2 border-l-2 border-gray-200 ml-2">
                        <p class="text-xs text-gray-400 mb-1 uppercase">çµ„æ…‹è¨­å®š</p>
                        <a href="examples/wifi-config.html" class="block py-1 hover:text-cyan-600">WiFi è¨­å®š</a>
                        <a href="examples/motor-config.html" class="block py-1 hover:text-cyan-600">é¦¬é”è¨­å®š</a>
                    </div>

                    <div class="pl-2 border-l-2 border-gray-200 ml-2">
                        <p class="text-xs text-gray-400 mb-1 uppercase">é—œæ–¼æˆ‘å€‘</p>
                        <a href="faq.html" class="block py-1 hover:text-cyan-600">èª²ç¨‹å¸¸è¦‹å•é¡Œ</a>
                        <a href="about.html" class="block py-1 hover:text-cyan-600">é—œæ–¼ä»˜è²»èˆ‡è³¼è²·</a>
                        <a href="collaboration.html" class="block py-1 hover:text-cyan-600">åˆä½œäº‹å®œ</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-4xl mx-auto p-6">        
        <section class="bg-white p-6 rounded-lg shadow-xl mb-10">
            <h2 class="text-3xl font-extrabold text-gray-800 border-b pb-4 mb-6">å¾…çµå¸³é …ç›®</h2>
            
            <div id="auth-error-message" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
                <p class="font-bold">ç™»å…¥å¤±æ•—é€šçŸ¥</p>
                <p id="error-details">æ‚¨çš„ç™»å…¥å˜—è©¦å¤±æ•—ï¼ŒåŸå› å¯èƒ½ç‚ºç€è¦½å™¨é˜»æ“‹ã€‚æˆ‘å€‘å·²åˆ‡æ›åˆ°ã€Œé é¢é‡æ–°å°å‘ã€æ–¹å¼ï¼Œè«‹é‡æ–°é»æ“Šç™»å…¥ã€‚</p>
            </div>
            
            <div id="unpaid-items" class="space-y-4">
            </div>
            <p id="empty-cart-msg" class="text-gray-500 italic text-center pt-4">è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼è«‹å›åˆ°èª²ç¨‹é é¢é¸è³¼ã€‚</p>
            
            <div id="cart-summary" class="mt-8 pt-4 border-t-2 border-dashed border-gray-200">
                <div class="flex justify-between items-center text-2xl font-bold text-gray-800">
                    <span>ç¸½é‡‘é¡ (TWD):</span>
                    <span id="cart-total">0</span>
                </div>
                <div id="payment-form-container" class="hidden"></div>
                
                <button id="checkout-btn" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white text-lg py-3 rounded-lg disabled:opacity-50" disabled>
                    ğŸ’³ å‰å¾€ä»˜æ¬¾
                </button>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 py-8 border-t border-gray-700 mt-10">
        <div class="container mx-auto px-4 text-center">
            <div class="flex justify-center space-x-6 mb-6 text-gray-400">
                <a href="prepare.html" class="hover:text-white">èª²å‰æº–å‚™</a>
                <a href="started.html" class="hover:text-white">å…¥é–€èª²ç¨‹</a>
                <a href="basic.html" class="hover:text-white">åŸºç¤å¯¦ä½œ</a>
                <a href="advanced.html" class="hover:text-white">é€²éšæ‡‰ç”¨</a>
            </div>
            
            <div class="border-t border-gray-700 pt-6">
                <p class="text-gray-500 text-sm mb-2">&copy; 2025 Vibe Coding. All rights reserved.</p>
                <div class="flex flex-col md:flex-row justify-center items-center gap-2 md:gap-6 text-sm text-gray-400">
                    <span>ç‡Ÿæ¥­äººåç¨±ï¼šè…³ä¸«å¥åº·ç§‘æŠ€æœ‰é™å…¬å¸</span>
                    <span class="hidden md:inline">|</span>
                    <span>çµ±ä¸€ç·¨è™Ÿï¼š80187668</span>
                    <span class="hidden md:inline">|</span>
                    <span>èª²ç¨‹åˆä½œæ´½è«‡ï¼šinfo@vibe-coding.tw</span>
                </div>
            </div>
        </div>
    </footer>

    <script>
        const btn = document.getElementById('mobile-menu-btn');
        const menu = document.getElementById('mobile-menu');
        btn.addEventListener('click', () => {
            menu.classList.toggle('hidden');
        });
    </script>

    <script type="module">
        // 1. åŒ¯å…¥å¿…è¦çš„ Firebase å‡½å¼
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js"; 
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-functions.js";

        // 2. Firebase é…ç½®
        const firebaseConfig = {
          apiKey: "AIzaSyCO6Y6Pa7b7zbieJIErysaNF6-UqbT8KJw",
          authDomain: "e-learning-942f7.firebaseapp.com",
          projectId: "e-learning-942f7",
          storageBucket: "e-learning-942f7.firebasestorage.app",
          messagingSenderId: "878397058574",
          appId: "1:878397058574:web:28aaa07a291ee3baab165f"
        };

        // 3. åˆå§‹åŒ– Firebase æœå‹™
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);    
        const functions = getFunctions(app, 'asia-east1'); 
        
        // ä¿®æ”¹ç‚ºé€šç”¨çš„ä»˜æ¬¾è«‹æ±‚ Function (å¾Œç«¯éœ€é…åˆä¿®æ”¹)
        const initiatePayment = httpsCallable(functions, 'initiatePayment');
        
        // æ‚¨çš„å•†åº—ä»£è™Ÿ (å…¬é–‹è³‡è¨Šå¯æ”¾åœ¨å‰ç«¯)
        const MERCHANT_ID = "3271550";
        // æ³¨æ„ï¼šHashKey å’Œ HashIV è«‹å‹™å¿…è¨­å®šåœ¨ Firebase Cloud Functions çš„ç’°å¢ƒè®Šæ•¸ä¸­ï¼Œä¸è¦å¯«åœ¨é€™è£¡ï¼

        // ===============================================
        // A. è³¼ç‰©è»Šé …ç›®æ¸²æŸ“é‚è¼¯
        // ===============================================

        const unpaidItemsContainer = document.getElementById('unpaid-items');
        const emptyMsg = document.getElementById('empty-cart-msg');
        const cartTotalElement = document.getElementById('cart-total');
        const checkoutBtn = document.getElementById('checkout-btn');
        const paymentFormContainer = document.getElementById('payment-form-container');

        function removeFromCart(productId) {
            let cart = JSON.parse(localStorage.getItem('vibeCodingCart') || '{}');
            delete cart[productId];
            localStorage.setItem('vibeCodingCart', JSON.stringify(cart));
            renderCartItems(); 
        }

        function renderCartItems() {
            const cart = JSON.parse(localStorage.getItem('vibeCodingCart') || '{}');
            let total = 0;
            
            unpaidItemsContainer.innerHTML = ''; 

            if (Object.keys(cart).length === 0) {
                emptyMsg.style.display = 'block';
                cartTotalElement.textContent = '0';
                checkoutBtn.disabled = true;
                return;
            } else {
                emptyMsg.style.display = 'none';
            }

            for (const [id, item] of Object.entries(cart)) {
                const price = parseFloat(item.price) || 0;
                const quantity = parseInt(item.quantity) || 1;
                const itemTotal = price * quantity;
                total += itemTotal;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-md border';
                itemDiv.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${item.name}</p>
                        <p class="text-xs text-gray-500">ç”¢å“ä»£è™Ÿ: ${id}</p>
                    </div>
                    <div class="text-right">
                         <p class="font-bold text-indigo-600">${itemTotal.toLocaleString()} å…ƒ</p>
                         <button class="remove-cart-item-btn" data-product-id="${id}">ç§»é™¤</button>
                    </div>
                `;
                unpaidItemsContainer.appendChild(itemDiv);
            }

            cartTotalElement.textContent = total.toLocaleString();
            checkoutBtn.disabled = (total === 0);

            document.querySelectorAll('.remove-cart-item-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    removeFromCart(event.currentTarget.dataset.productId);
                });
            });
        }

        renderCartItems();

        // ===============================================
        // B. èº«ä»½é©—è­‰é‚è¼¯
        // ===============================================
        
         async function handleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("ç™»å…¥å¤±æ•—:", error);
            }
        }

        async function handleLogout() {
            await signOut(auth);
            onAuthStateChanged(auth, () => {}); 
        }
        
        onAuthStateChanged(auth, (user) => {
            const userDisplay = document.getElementById('user-display');
            const loginBtn = document.getElementById('login-btn');
            
            if (user) {
                userDisplay.textContent = `æ‚¨å¥½, ${user.displayName || user.email}`;
                loginBtn.textContent = 'ç™»å‡º';
                loginBtn.onclick = handleLogout;
            } else {
                userDisplay.textContent = 'è¨ªå®¢æ¨¡å¼';
                loginBtn.textContent = 'ç™»å…¥ / è¨»å†Š';
                loginBtn.onclick = handleLogin;
            }
        });

        // ===============================================
        // C. ä»˜æ¬¾æŒ‰éˆ•é‚è¼¯ (å·²é‡å°æ–°é‡‘æµä¿®æ­£)
        // ===============================================

        checkoutBtn.addEventListener('click', () => {
            const totalText = cartTotalElement.textContent.replace(/,/g, '').trim();
            const total = parseInt(totalText);

            if (total <= 0) {
                alert("è³¼ç‰©è»Šç‚ºç©ºï¼Œç„¡æ³•çµå¸³ã€‚");
                return;
            }

            if (!auth.currentUser) {
                alert("è«‹å…ˆç™»å…¥æ‰èƒ½é€²è¡Œä»˜æ¬¾ï¼è«‹é»æ“Šå³ä¸Šè§’æŒ‰éˆ•ç™»å…¥ã€‚");
                return;
            }
            
            const cartItems = JSON.parse(localStorage.getItem('vibeCodingCart') || '{}');
            const user = auth.currentUser;

            // å‘¼å«è™•ç†æ–°é‡‘æµ (è—æ–°) çš„å‡½å¼
            handlePaymentCheckout(user, total, cartItems);
        });

        // ... (å‰é¢çš„ç¨‹å¼ç¢¼ä¸è®Š)

        /**
         * è™•ç†ä»˜æ¬¾çµå¸³æµç¨‹ (ç¶ ç•Œç‰ˆ)
         */
         async function handlePaymentCheckout(user, total, cartItems) {
            checkoutBtn.disabled = true;
            checkoutBtn.textContent = 'ğŸ”’ æ­£åœ¨é€£æ¥ç¶ ç•Œé‡‘æµ...';
            
            try {
                const response = await initiatePayment({
                    amount: total,
                    userId: user.uid,
                    cartDetails: cartItems, 
                    // è¨­å®šäº¤æ˜“å®Œæˆå¾Œçš„è¿”å›ç¶²å€
                    returnUrl: window.location.origin + '/payment-return.html'
                });

                const data = response.data;

                if (data && data.paymentParams) {
                    console.log("å–å¾—ç¶ ç•Œåƒæ•¸æˆåŠŸï¼Œæ­£åœ¨è·³è½‰...");
                    checkoutBtn.textContent = 'ğŸš€ å‰å¾€ä»˜æ¬¾é é¢...';
                    
                    // åŸ·è¡Œç¶ ç•Œè¡¨å–®æäº¤
                    submitECPayForm(data.paymentParams, data.apiUrl);
                } else {
                    throw new Error('ç„¡æ³•å–å¾—äº¤æ˜“åƒæ•¸ã€‚');
                }

            } catch (error) {
                console.error("çµå¸³å¤±æ•—:", error);
                alert(`çµå¸³å¤±æ•—ï¼š${error.message}`);
                checkoutBtn.disabled = false;
                checkoutBtn.textContent = 'ğŸ’³ å‰å¾€ä»˜æ¬¾';
            }
        }    

        /**
         * å»ºç«‹ä¸¦é€å‡ºç¶ ç•Œ (ECPay) è¡¨å–®
         */
        function submitECPayForm(params, apiUrl) {
            const form = document.createElement('form');
            form.method = 'post';
            form.action = apiUrl; // ç¶ ç•Œçš„ API ç¶²å€
            
            // å°‡å¾Œç«¯å›å‚³çš„æ‰€æœ‰åƒæ•¸è½‰ç‚º hidden input
            for (const key in params) {
                if (params.hasOwnProperty(key)) {
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = params[key];
                    form.appendChild(input);
                }
            }

            paymentFormContainer.appendChild(form);
            form.submit();
        }
    </script>
</body>
</html>