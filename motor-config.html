<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>馬達 Ramping 組態設定 - BLE 傳輸</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* 確保全螢幕高度和柔軟的背景色 */
    body { 
        background-color: #1f2937; 
        color: #f9fafb; 
        font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
        display: flex; 
        justify-content: center; 
        align-items: center; 
        min-height: 100vh; 
        margin: 0; 
        padding: 1rem;
    }
    .container-wrap { 
        max-width: 500px; /* 稍微放大容器以容納更多欄位 */
        width: 100%; 
        padding: 30px; 
        background-color: #1f2937;
        border-radius: 1.5rem;
    }
    
    /* 頂部控制列 */
    .top-control{
        width:100%;
        display:flex;
        gap:8px;
        align-items:center;
        margin-bottom: 20px;
    }

    /* 按鈕樣式 (Connect / Send) */
    button {
        padding:12px 16px;
        border-radius:12px;
        border:none;
        background:#4f46e5; /* 靛藍色 */
        color:white;
        font-weight:700;
        /* Neumorphic 外凸效果 */
        box-shadow: 3px 3px 6px #171d26, -3px -3px 6px #273142; 
        transition: all 0.15s ease-in-out;
    }
    button:hover { 
        background: #3730a3; 
        box-shadow: 5px 5px 10px #171d26, -5px -5px 10px #273142;
    }
    button:disabled {
        background: #374151;
        color: #9ca3af;
        box-shadow: none;
        cursor: not-allowed;
    }
    
    /* 狀態顯示區域 - 內凹樣式 */
    #statusLog{
        flex:1;
        text-align:center;
        font-weight:600;
        font-size: 0.875rem;
        color:#9ca3af; 
        padding: 12px; 
        background: #2d3748; 
        border-radius: 12px; 
        /* Neumorphic 內凹效果 */
        box-shadow: inset 3px 3px 6px #171d26, inset -3px -3px 6px #3b4555;
    }
    .log-success { color: #4ade80 !important; }
    .log-error { color: #f87171 !important; }
    .log-info { color: #60a5fa !important; }

    /* 輸入框樣式 */
    input[type="number"] {
        width: 100%;
        padding: 12px;
        margin-top: 4px;
        border-radius: 10px;
        border: none;
        background: #2d3748; 
        color: #f9fafb;
        font-weight: 500;
        /* 深色內凹效果 */
        box-shadow: inset 3px 3px 6px #171d26, inset -3px -3px 6px #3b4555;
        transition: box-shadow 0.15s;
    }

    input[type="number"]:focus {
        outline: none;
        background: #232d3a;
        /* 輕微的亮光效果 */
        box-shadow: inset 2px 2px 4px #171d26, inset -2px -2px 4px #3b4555, 0 0 5px #4f46e5;
    }
    
    /* 返回主選單按鈕 */
    .menu-button {
        display: block;
        width: 100%;
        padding: 12px;
        border-radius: 12px;
        border: none;
        background: #4f46e5; 
        color: white;
        font-weight: 700;
        text-align: center;
        text-decoration: none;
        box-shadow: 3px 3px 6px #171d26, -3px -3px 6px #273142;
        transition: all 0.2s ease;
    }
  </style>
</head>
<body class="p-4">
    <div class="container-wrap">
        
        <h1 class="text-2xl font-extrabold text-center text-indigo-400 mb-6 border-b border-gray-700 pb-2">
            馬達 Ramping 組態設定
        </h1>
        
        <!-- 頂部控制列：連線按鈕與狀態 -->
        <div class="top-control">
            <button id="btnConnect" class="flex items-center justify-center space-x-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <span>連線 BLE</span>
            </button>
            
            <div id="statusLog">
                等待連線...
            </div>
        </div>

        <!-- 設定參數表單 -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl space-y-4">
            <p class="text-sm font-bold text-indigo-300 mb-4">
                MotorConfig_t 參數 (共 28 Bytes)
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- controlTimeoutMs (unsigned long, 4 bytes) -->
                <div class="space-y-1">
                    <label for="controlTimeoutMs" class="block text-sm font-medium text-gray-400">controlTimeoutMs (ms)</label>
                    <input type="number" id="controlTimeoutMs" value="1000" min="0" required>
                </div>

                <!-- pwmEffectiveLimitT (int, 4 bytes) -->
                <div class="space-y-1">
                    <label for="pwmEffectiveLimitT" class="block text-sm font-medium text-gray-400">pwmEffectiveLimitT</label>
                    <input type="number" id="pwmEffectiveLimitT" value="255" min="0" required>
                </div>

                <!-- rampAccelStepT (int, 4 bytes) -->
                <div class="space-y-1">
                    <label for="rampAccelStepT" class="block text-sm font-medium text-gray-400">rampAccelStepT</label>
                    <input type="number" id="rampAccelStepT" value="10" min="0" required>
                </div>

                <!-- pwmStartKickT (int, 4 bytes) -->
                <div class="space-y-1">
                    <label for="pwmStartKickT" class="block text-sm font-medium text-gray-400">pwmStartKickT</label>
                    <input type="number" id="pwmStartKickT" value="50" min="0" required>
                </div>

                <!-- pwmEffectiveLimitS (int, 4 bytes) -->
                <div class="space-y-1">
                    <label for="pwmEffectiveLimitS" class="block text-sm font-medium text-gray-400">pwmEffectiveLimitS</label>
                    <input type="number" id="pwmEffectiveLimitS" value="255" min="0" required>
                </div>

                <!-- rampAccelStepS (int, 4 bytes) -->
                <div class="space-y-1">
                    <label for="rampAccelStepS" class="block text-sm font-medium text-gray-400">rampAccelStepS</label>
                    <input type="number" id="rampAccelStepS" value="10" min="0" required>
                </div>

                <!-- pwmStartKickS (int, 4 bytes) -->
                <div class="space-y-1">
                    <label for="pwmStartKickS" class="block text-sm font-medium text-gray-400">pwmStartKickS</label>
                    <input type="number" id="pwmStartKickS" value="50" min="0" required>
                </div>
            </div>
            
            <button id="btnSend" class="mt-6 w-full bg-indigo-600 text-white p-4 rounded-xl font-bold transition duration-150 hover:bg-indigo-700 disabled:opacity-50" disabled>
                讀取/傳送 馬達組態設定
            </button>
            
            <p class="text-center text-xs text-gray-500 pt-2">
                點擊上方按鈕讀取/儲存 7 個 4-byte 參數 (共 28 Bytes)
            </p>
        </div>
        
        <!-- 返回主選單按鈕 -->
        <a href="index.html" class="menu-button w-full mt-8 text-center bg-gray-700 hover:bg-gray-600 text-gray-300 p-3 block rounded-xl shadow-md transition">
            返回主選單
        </a>
    </div>

<script>
// --- BLE Configuration (使用新的 UUID) ---
// 馬達配置服務 UUID
const MOTOR_CONFIG_SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c0ffee00dead'; 
// 配置特徵值 UUID (用於讀取和寫入 28-byte 結構體)
const CONFIG_CHARACTERISTIC_UUID = '4fafc203-1fb5-459e-8fcc-c0ffee02dead'; 

const DEVICE_ID_KEY = 'ble_motor_config_device_id'; 
const LITTLE_ENDIAN = true; // C/C++ on ESP32 is typically little-endian

// --- State Variables ---
let device = null;
let config_characteristic = null;

// --- DOM Elements ---
const statusLog = document.getElementById('statusLog');
const btnConnect = document.getElementById('btnConnect');
const btnSend = document.getElementById('btnSend');

// 欄位 ID 陣列 (用於迭代和打包數據)
const PARAM_IDS = [
    { id: 'controlTimeoutMs', type: 'Uint32', offset: 0 }, // unsigned long
    { id: 'pwmEffectiveLimitT', type: 'Int32', offset: 4 }, // int
    { id: 'rampAccelStepT', type: 'Int32', offset: 8 }, // int
    { id: 'pwmStartKickT', type: 'Int32', offset: 12 }, // int
    { id: 'pwmEffectiveLimitS', type: 'Int32', offset: 16 }, // int
    { id: 'rampAccelStepS', type: 'Int32', offset: 20 }, // int
    { id: 'pwmStartKickS', type: 'Int32', offset: 24 }  // int
    // 總共 28 bytes
];

// --- Helper Functions ---

/**
 * 將訊息記錄到狀態區域
 */
function logStatus(message, type = 'info') {
    let typeClass = '';
    switch (type) {
        case 'success':
            typeClass = 'log-success';
            break;
        case 'error':
            typeClass = 'log-error';
            break;
        case 'info':
        default:
            typeClass = 'log-info';
            break;
    }
    statusLog.classList.remove('log-success', 'log-error', 'log-info');
    statusLog.classList.add(typeClass);
    statusLog.innerHTML = message;
}

/**
 * 更新 UI 狀態（按鈕啟用/禁用）
 */
function updateUI(isConnected) {
    if (isConnected) {
        btnConnect.querySelector('span').textContent = '斷開';
        btnSend.disabled = false;
        btnSend.querySelector('span').textContent = '傳送設定至裝置';
    } else {
        btnConnect.querySelector('span').textContent = '連線 BLE';
        btnSend.disabled = true;
        btnSend.querySelector('span').textContent = '讀取/傳送 馬達組態設定';
    }
}

/**
 * 處理 BLE 斷線
 */
function onDisconnect() {
    logStatus('❌ 已斷線', 'error');
    updateUI(false);
    if (device) device.removeEventListener('gattserverdisconnected', onDisconnect);
    device = null;
    config_characteristic = null;
}

/**
 * 取得裝置物件 (透過掃描)
 */
async function acquireDevice() {
    logStatus('掃描中 (過濾: esp32)...', 'info');
    
    try {
        // 使用 filters 確保只顯示預期的裝置名稱
        const newDevice = await navigator.bluetooth.requestDevice({
            filters:[{ namePrefix: 'esp32' }],
            // 請求我們的配置服務 UUID
            optionalServices: [MOTOR_CONFIG_SERVICE_UUID] 
        });
        
        localStorage.setItem(DEVICE_ID_KEY, newDevice.id);
        return newDevice;
    } catch(e) {
        if (e.name === 'NotFoundError') {
             throw new Error("找不到裝置或使用者取消。");
        }
        throw e;
    }
}


/**
 * 讀取並顯示裝置當前的設定值
 */
async function readConfig() {
    if (!config_characteristic) {
        logStatus('⚠️ 特徵值未就緒，請重新連線。', 'error');
        return;
    }

    try {
        logStatus('正在從裝置讀取設定值...', 'info');
        btnSend.disabled = true;
        
        const value = await config_characteristic.readValue();
        const dataView = new DataView(value.buffer);
        
        // 確保讀到的長度正確 (28 bytes)
        if (value.byteLength !== 28) {
            throw new Error(`讀取數據長度錯誤: ${value.byteLength} bytes (預期 28 bytes)`);
        }

        // 依據 PARAM_IDS 陣列解析數據並填入輸入框
        PARAM_IDS.forEach(param => {
            let val;
            const element = document.getElementById(param.id);

            if (param.type === 'Uint32') {
                val = dataView.getUint32(param.offset, LITTLE_ENDIAN);
            } else { // Int32
                val = dataView.getInt32(param.offset, LITTLE_ENDIAN);
            }

            if (element) {
                element.value = val;
            }
        });

        logStatus('✅ 設定值讀取成功!', 'success');
    } catch (err) {
        logStatus(`❌ 讀取設定失敗: ${err.message.slice(0, 50)}...`, 'error');
        console.error('BLE Read Error:', err);
    } finally {
        btnSend.disabled = false;
    }
}


/**
 * 連線/斷開 BLE 裝置
 */
async function connectBLE(){
    if (!navigator.bluetooth) {
        logStatus('❌ 瀏覽器不支援 Web Bluetooth。', 'error');
        return;
    }
    
    // 處理已連線狀態下的按鈕點擊 (斷開連線)
    if (device && device.gatt && device.gatt.connected) {
        logStatus('中斷連線中...');
        device.gatt.disconnect();
        return;
    }

    try{
        device = await acquireDevice();
        if (!device) throw new Error("裝置未連線或未找到。");

        logStatus(`連線到 ${device.name}...`, 'info');

        device.removeEventListener('gattserverdisconnected', onDisconnect);
        device.addEventListener('gattserverdisconnected', onDisconnect);

        const server = await device.gatt.connect();
        
        // 取得馬達配置服務
        const service = await server.getPrimaryService(MOTOR_CONFIG_SERVICE_UUID);
        
        // 取得配置特徵值
        config_characteristic = await service.getCharacteristic(CONFIG_CHARACTERISTIC_UUID); 
        
        logStatus('✅ 已連線: ' + device.name, 'success');
        updateUI(true);

        // 連線成功後，立即讀取當前配置
        await readConfig();

    }catch(err){
        console.error('BLE 連線失敗:', err);
        logStatus(`❌ 連線失敗 (${err.message.slice(0, 30)}...)`, 'error');
        updateUI(false);
        // 清理殘留的 device 引用
        if (device && (!device.gatt || !device.gatt.connected)) {
            device = null;
        }
    }
}


/**
 * 傳送 28-byte 結構體給裝置
 */
async function sendConfig(){
    if(!config_characteristic || !device || !device.gatt.connected) {
        logStatus('⚠️ 請先連線到 BLE 裝置。', 'info');
        return;
    }
    
    // 總共 28 bytes (7 * 4-byte 欄位)
    const buffer = new ArrayBuffer(28); 
    const dataView = new DataView(buffer);
    let offset = 0;

    try{
        // 1. 建立 28-byte 數據包
        PARAM_IDS.forEach(param => {
            const element = document.getElementById(param.id);
            const value = parseInt(element.value);

            if (isNaN(value)) {
                throw new Error(`欄位 ${param.id} 包含無效數值。`);
            }
            
            // 使用 DataView 寫入 4-byte 整數 (有/無符號)
            if (param.type === 'Uint32') {
                dataView.setUint32(param.offset, value, LITTLE_ENDIAN);
            } else { // Int32
                dataView.setInt32(param.offset, value, LITTLE_ENDIAN);
            }
        });

        logStatus('傳送 28-byte 馬達組態設定...', 'info');
        btnSend.disabled = true; // 傳送中禁用按鈕

        // 2. 寫入特徵值
        await config_characteristic.writeValue(buffer);
        
        logStatus('✅ 設定已成功傳送! (28 Bytes)', 'success');
        
    }catch(err){
        logStatus(`❌ 傳送失敗: ${err.message.slice(0, 50)}...`, 'error');
        console.error('BLE Write Error:', err);
    } finally {
        btnSend.disabled = false;
    }
}

// --- Event Listeners ---

btnConnect.addEventListener('click', connectBLE);
btnSend.addEventListener('click', sendConfig);

// --- Initialization ---

// 檢查瀏覽器是否支援 Web Bluetooth
if (!navigator.bluetooth) {
    logStatus('❌ 瀏覽器不支援 Web Bluetooth。', 'error');
    btnConnect.disabled = true;
    btnConnect.querySelector('span').textContent = "不支援";
}
</script>
</body>
</html>