<!doctype html>
<html lang="zh-Hant">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>BLE èªéŸ³æ§åˆ¶ (Mobile)</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            /* ç¢ºä¿å…¨è¢å¹•é«˜åº¦å’ŒæŸ”è»Ÿçš„èƒŒæ™¯è‰² */
            body {
                background-color: #1f2937;
                color: #f9fafb;
                font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
                display: flex;
                justify-content: center;
                align-items: center;
                min-height: 100vh;
                margin: 0;
                padding: 1rem;
            }
            .container-wrap {
                max-width: 400px;
                width: 100%;
                padding: 20px;
                background-color: #1f2937; /* èˆ‡ body èƒŒæ™¯ä¸€è‡´ */
                border-radius: 1rem;
                box-shadow: 10px 10px 20px #171d26, -10px -10px 20px #273142;
            }
            /* é ‚éƒ¨æ§åˆ¶åˆ— */
            .top{width:100%;display:flex;gap:8px;align-items:center; max-width: 520px; margin-bottom: 20px;}
            button{padding:10px 14px;border-radius:12px;border:none;background:#4f46e5;color:white;font-weight:700;box-shadow: 3px 3px 6px #1a202c, -3px -3px 6px #273142; transition: all 0.15s ease-in-out; white-space: nowrap; cursor: pointer;}
            button:hover { background: #3730a3; box-shadow: 5px 5px 10px #1a202c, -5px -5px 10px #273142;}

            #status{flex:1;text-align:center;font-weight:700;color:#f9fafb; padding: 10px; background: #2d3748; border-radius: 12px; box-shadow: inset 3px 3px 6px #1a202c, inset -3px -3px 6px #273142;}

            /* ç‹€æ…‹æ–‡å­— */
            #main-status { font-weight: 700; text-shadow: 0 0 5px rgba(79, 70, 229, 0.5); }
            .info{font-size:14px;color:#9ca3af; margin-top: 20px;}

            /* æ–°å¢èªéŸ³æ§åˆ¶æŒ‰éˆ•æ¨£å¼ */
            #btnSpeech {
                background-color: #ef4444; /* ç´…è‰² */
                color: white;
                font-size: 1.25rem;
                padding: 1.5rem;
                width: 100%;
                height: 150px;
                display: flex;
                align-items: center;
                justify-content: center;
                margin-top: 20px;
                box-shadow: 5px 5px 10px #1a202c, -5px -5px 10px #273142;
                animation: pulse 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
            }
            #btnSpeech.listening {
                background-color: #10b981; /* ç¶ è‰² */
                box-shadow: 0 0 10px #10b981, 0 0 20px #10b981;
                animation: none;
            }
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: .5; }
            }

            #speech-result {
                min-height: 2.5rem;
                padding: 10px;
                background: #2d3748;
                border-radius: 8px;
                margin-top: 15px;
                font-style: italic;
            }

            /* ç¦ç”¨æŒ‰éˆ•çš„æ¨£å¼ */
            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                box-shadow: none;
                background: #4f46e5;
            }
            #btnSpeech:disabled {
                background-color: #4b5563; /* ç°è‰² */
            }
        </style>
    </head>
    <body class="p-4">
        <div class="container-wrap">

            <h1 class="text-3xl font-extrabold text-center text-indigo-400 mb-6">ğŸ™ï¸ BLE èªéŸ³æ§åˆ¶</h1>

            <div class="top">
                <button id="btnConnect" class="flex-grow">é€£ç·š BLE</button>
                <div id="status">æœªé€£ç·š</div>
            </div>

            <button id="btnSpeech" disabled>
                é»æ“Šé–‹å§‹èªéŸ³æ§åˆ¶
            </button>

            <div id="speech-result" class="text-center text-gray-400">
                èªªå‡º: å‰é€² | å¾Œé€€ | å·¦è½‰ | å³è½‰ | åœæ­¢
            </div>

            <div class="text-center space-y-2 mt-4">
                <p class="text-xl">ç›®å‰å‘½ä»¤: <span id="main-status" class="text-green-400">éœæ­¢</span></p>
                <p class="text-xs text-gray-500">
                    T (é€Ÿåº¦): <span id="val_t">0</span> | S (è½‰å‘): <span id="val_s">0</span>
                </p>
            </div>        
        </div>

        <script>
            // --- BLE & Control Configuration ---
            // æ³¨æ„: ç¢ºä¿ SERVICE_UUID å’Œ CHARACTERISTIC_UUID èˆ‡æ‚¨çš„ ESP32 ç¨‹å¼ç¢¼ä¸€è‡´
            const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c0ffee00dead';
            const CHARACTERISTIC_UUID = '4fafc201-1fb5-459e-8fcc-c0ffee01feed';
            const DEVICE_ID_KEY = 'ble_joystick_device_id';
            const MAX_CONTROL_VALUE = 255;
            const MAX_RETRIES = 5; // æŒ‡æ•¸é€€é¿æœ€å¤§é‡è©¦æ¬¡æ•¸

            // èªéŸ³å‘½ä»¤å°æ‡‰çš„é¦¬é”æ§åˆ¶å€¼ (T, S)
            const COMMANDS = {
                "å‰é€²": {t: MAX_CONTROL_VALUE, s: 0, status: "å‰é€²ä¸­", color: "text-green-400"},
                "å¾Œé€€": {t: -MAX_CONTROL_VALUE, s: 0, status: "å¾Œé€€ä¸­", color: "text-orange-400"},
                "å·¦è½‰": {t: 0, s: -MAX_CONTROL_VALUE, status: "å·¦è½‰ä¸­", color: "text-blue-400"},
                "å³è½‰": {t: 0, s: MAX_CONTROL_VALUE, status: "å³è½‰ä¸­", color: "text-blue-400"},
                "åœæ­¢": {t: 0, s: 0, status: "éœæ­¢", color: "text-red-400"},
                "åœ": {t: 0, s: 0, status: "éœæ­¢", color: "text-red-400"}, // å¢åŠ ã€Œåœã€ä½œç‚ºåˆ¥å
            };
            const COMMAND_KEYWORDS = Object.keys(COMMANDS);

            // --- DOM Elements ---
            const statusEl = document.getElementById('status'); // BLE é€£ç·šç‹€æ…‹
            const mainStatusEl = document.getElementById('main-status'); // ç›®å‰å‘½ä»¤ç‹€æ…‹
            const valTEl = document.getElementById('val_t'); // T (Throttle)
            const valSEl = document.getElementById('val_s'); // S (Steer)
            const btnConnect = document.getElementById('btnConnect');
            const btnSpeech = document.getElementById('btnSpeech'); // èªéŸ³æ§åˆ¶æŒ‰éˆ•
            const speechResultEl = document.getElementById('speech-result');

            // --- State Variables ---
            let device = null;
            let characteristic = null;
            let lastPayload = {t: 0, s: 0}; // å„²å­˜ä¸Šæ¬¡ç™¼é€çš„ T, S å€¼
            let isSpeechSupported = false;

            // æª¢æŸ¥ Web Speech API æ”¯æ´
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                isSpeechSupported = true;
                btnSpeech.disabled = true; // é è¨­ç¦ç”¨ï¼Œé€£ç·šå¾Œå•Ÿç”¨
            } else {
                statusEl.textContent = 'âŒ ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ã€‚';
                btnSpeech.disabled = true;
                btnSpeech.textContent = 'èªéŸ³è¾¨è­˜ä¸æ”¯æ´';
            }
            
            // --- LLM API Key Placeholder (For future Gemini integration) ---
            function getGeminiApiKey() {
                // åœ¨ Canvas ç’°å¢ƒä¸­ï¼Œæˆ‘å€‘å‡è¨­ API é‡‘é‘°æœƒç”±é‹è¡Œç’°å¢ƒæä¾›
                // å¦‚æœåœ¨å¤–éƒ¨ç’°å¢ƒé‹è¡Œï¼Œéœ€è¦åœ¨æ­¤è™•æä¾›æˆ–å¾å®‰å…¨çš„æ–¹å¼ç²å–
                return typeof __api_key !== 'undefined' ? __api_key : '';
            }

            // --- Speech Recognition Setup ---
            let recognition = null;
            let isListening = false;

            function stopListeningUI() {
                isListening = false;
                btnSpeech.textContent = "é»æ“Šé–‹å§‹èªéŸ³æ§åˆ¶";
                btnSpeech.classList.remove('listening');
                btnSpeech.disabled = false; // åœæ­¢å¾Œå•Ÿç”¨
            }

            function processSpeechResult(transcript) {
                speechResultEl.textContent = `è¾¨è­˜çµæœ: ${transcript}`;

                // æª¢æŸ¥æ˜¯å¦åŒ…å«ä»»ä½•å‘½ä»¤é—œéµå­—
                for (const keyword of COMMAND_KEYWORDS) {
                    if (transcript.includes(keyword)) {
                        const command = COMMANDS[keyword];
                        updateMotorValues(command.t, command.s, command.status, command.color);
                        speechResultEl.textContent = `âœ… å‘½ä»¤åŸ·è¡Œ: ${keyword}`;
                        return; // æ‰¾åˆ°ç¬¬ä¸€å€‹å‘½ä»¤å°±åŸ·è¡Œä¸¦è¿”å›
                    }
                }

                // å¦‚æœæ²’æœ‰åŒ¹é…çš„å‘½ä»¤
                speechResultEl.textContent = `âŒ ç„¡æ•ˆå‘½ä»¤: ${transcript} (è«‹é‡è©¦)`;
                updateMotorValues(0, 0, "éœæ­¢", "text-red-400"); // ç„¡æ•ˆå‘½ä»¤æ™‚åœæ­¢é¦¬é”
            }


            function startSpeechRecognition() {
                if (!isSpeechSupported) {
                    alert("âŒ æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ Web Speech API (èªéŸ³è¾¨è­˜)ã€‚è«‹ä½¿ç”¨ Chrome æˆ– Edge ç€è¦½å™¨ã€‚");
                    return;
                }

                if (!device || !device.gatt.connected) {
                    statusEl.textContent = 'è«‹å…ˆé€£ç·š BLE è£ç½®ã€‚';
                    return;
                }

                if (isListening) {
                    recognition.stop(); // å¦‚æœæ­£åœ¨è½ï¼Œå‰‡åœæ­¢
                    return;
                }

                if (!recognition) {
                    recognition = new SpeechRecognition();
                    recognition.continuous = false; // åªè½ä¸€å€‹æŒ‡ä»¤
                    recognition.lang = 'zh-Hant'; // è¨­å®šç‚ºç¹é«”ä¸­æ–‡
                    recognition.interimResults = false; // åªè¿”å›æœ€çµ‚çµæœ

                    recognition.onstart = () => {
                        isListening = true;
                        btnSpeech.textContent = "è«‹èªªè©±... (é»æ“Šåœæ­¢)";
                        btnSpeech.classList.add('listening');
                        speechResultEl.textContent = "ğŸ‘‚ æ­£åœ¨è†è½...";
                        btnSpeech.disabled = false; // è†è½ä¸­å¯ä»¥é»æ“Šåœæ­¢
                    };

                    recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        processSpeechResult(transcript);
                    };

                    recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        speechResultEl.textContent = `âŒ èªéŸ³éŒ¯èª¤: ${event.error}`;
                        stopListeningUI();
                    };

                    recognition.onend = () => {
                        // ç¢ºä¿åªæœ‰åœ¨ééŒ¯èª¤æƒ…æ³ä¸‹æ‰è‡ªå‹•é‡æ–°å•Ÿç”¨
                        if (!isListening) {
                           stopListeningUI();
                        }
                    };
                }

                btnSpeech.disabled = true; // é¿å…é€£é»ï¼Œç›´åˆ° onstart å•Ÿç”¨æˆ– onend ç¦ç”¨
                recognition.start();
            }

            btnSpeech.addEventListener('click', startSpeechRecognition);


            // --- BLE Connection Logic ---

            function onDisconnect() {
                statusEl.textContent = 'âŒ å·²æ–·ç·š';
                btnConnect.textContent = 'é€£ç·š BLE';
                btnSpeech.disabled = true; // æ–·ç·šå¾Œç¦ç”¨èªéŸ³æŒ‰éˆ•
                updateMotorValues(0, 0, "éœæ­¢", "text-red-400"); // æ–·ç·šæ™‚åœæ­¢é¦¬é”
                if (device) device.removeEventListener('gattserverdisconnected', onDisconnect);
                device = null;
                characteristic = null;
            }

            async function acquireDevice() {
                statusEl.textContent = 'æƒæä¸­ (éæ¿¾: esp32)...';
                // ä½¿ç”¨ optionalServices æ˜¯ç‚ºäº†åœ¨ filters ä¸åŒ…å«æœå‹™ UUID æ™‚ä¹Ÿèƒ½é€£ç·š
                const newDevice = await navigator.bluetooth.requestDevice({
                    filters:[{ namePrefix: 'esp32' }],
                    optionalServices: [SERVICE_UUID]
                });

                // å³ä½¿ Web Bluetooth å·²ç¶“è¨˜ä½é€£ç·šï¼Œé€™è£¡ä»å»ºè­°ä½¿ç”¨ UUID
                // localStorage.setItem(DEVICE_ID_KEY, newDevice.id);
                return newDevice;
            }

            async function connectBLE(){
                if (!navigator.bluetooth) {
                    statusEl.textContent = 'âŒ ç€è¦½å™¨ä¸æ”¯æ´ Web Bluetoothã€‚';
                    return;
                }

                // è™•ç†å·²é€£ç·šç‹€æ…‹ä¸‹çš„æŒ‰éˆ•é»æ“Š (æ–·é–‹é€£ç·š)
                if (device && device.gatt && device.gatt.connected) {
                    statusEl.textContent = 'ä¸­æ–·é€£ç·šä¸­...';
                    device.gatt.disconnect();
                    return;
                }
                
                try{
                    device = await acquireDevice();
                    if (!device) throw new Error("è£ç½®æœªé€£ç·šæˆ–æœªæ‰¾åˆ°ã€‚");

                    statusEl.textContent = `é€£ç·šåˆ° ${device.name}...`;

                    device.removeEventListener('gattserverdisconnected', onDisconnect);
                    device.addEventListener('gattserverdisconnected', onDisconnect);

                    const server = await device.gatt.connect();
                    const service = await server.getPrimaryService(SERVICE_UUID);
                    characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

                    statusEl.textContent = 'âœ… å·²é€£ç·š: ' + device.name;
                    btnConnect.textContent = 'æ–·é–‹';
                    btnSpeech.disabled = false; // é€£ç·šæˆåŠŸå¾Œå•Ÿç”¨èªéŸ³æŒ‰éˆ•

                }catch(err){
                    console.error('BLE é€£ç·šå¤±æ•—:', err);
                    statusEl.textContent = `âŒ é€£ç·šå¤±æ•— (${err.message.slice(0, 30)}...)`;
                    btnConnect.textContent = 'é€£ç·š BLE';
                    btnSpeech.disabled = true; // é€£ç·šå¤±æ•—å‰‡ç¦ç”¨èªéŸ³æŒ‰éˆ•

                    if (device && (!device.gatt || !device.gatt.connected)) {
                        device = null;
                        // localStorage.removeItem(DEVICE_ID_KEY); // ç§»é™¤å„²å­˜çš„ ID
                    }
                }
            }


            /**
            * å‘ ESP32 å‚³é€æ§åˆ¶æŒ‡ä»¤ (T,S)ï¼ŒåŒ…å«æŒ‡æ•¸é€€é¿é‡è©¦æ©Ÿåˆ¶
            */
            async function sendControl(){
                if(!characteristic || !device || !device.gatt.connected) {
                    // å¦‚æœç”¨æˆ¶åœ¨èªéŸ³è¾¨è­˜éç¨‹ä¸­æ–·ç·šï¼Œé€™è£¡æœƒè¢«è§¸ç™¼
                    // statusEl.textContent = 'æœªé€£ç·šæˆ–å·²æ–·ç·šï¼Œç„¡æ³•å‚³é€å‘½ä»¤ã€‚';
                    return;
                }

                const t_int = lastPayload.t;
                const s_int = lastPayload.s;
                const payload = `${t_int},${s_int}`;
                const encodedPayload = new TextEncoder().encode(payload);

                for (let i = 0; i < MAX_RETRIES; i++) {
                    try {
                        await characteristic.writeValue(encodedPayload);
                        // console.log(`[BLE] æŒ‡ä»¤æˆåŠŸç™¼é€: ${payload}`);
                        return; // æˆåŠŸç™¼é€ï¼Œé€€å‡ºå‡½æ•¸
                    } catch (err) {
                        if (err.message.includes("GATT Server is disconnected")) {
                            console.warn('sendControl: GATT æ–·ç·šï¼Œåœæ­¢é‡è©¦ã€‚');
                            onDisconnect(); // ç«‹å³è™•ç†æ–·ç·š
                            return;
                        }
                        
                        const delay = Math.pow(2, i) * 100; // 100ms, 200ms, 400ms, ...
                        console.warn(`[BLE] å¯«å…¥å¤±æ•— (é‡è©¦ ${i+1}/${MAX_RETRIES}): ${err.message}. å»¶é² ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }

                console.error(`[BLE] é€£çºŒ ${MAX_RETRIES} æ¬¡å¯«å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚`);
                statusEl.textContent = 'ğŸš¨ BLE å‚³è¼¸å¤±æ•—ï¼Œè«‹é‡æ–°é€£ç·šã€‚';
                onDisconnect();
            }

            /**
            * æ›´æ–°é¦¬é”æ•¸å€¼ä¸¦ç™¼é€å‘½ä»¤
            * @param {number} t é€Ÿåº¦å€¼ (-255 åˆ° 255)
            * @param {number} s è½‰å‘å€¼ (-255 åˆ° 255)
            * @param {string} statusText é¡¯ç¤ºåœ¨ UI ä¸Šçš„å‘½ä»¤ç‹€æ…‹
            * @param {string} statusColor ç‹€æ…‹æ–‡å­—é¡è‰²
            */
            async function updateMotorValues(t, s, statusText, statusColor) {
                // å¦‚æœæ•¸å€¼æ²’æœ‰è®ŠåŒ–ï¼Œå‰‡ä¸ç™¼é€å‘½ä»¤ï¼Œç¯€çœ BLE é »å¯¬
                if (lastPayload.t === t && lastPayload.s === s) {
                    // ä½† UI ç‹€æ…‹ä»ç„¶éœ€è¦æ›´æ–°ï¼Œå› ç‚ºèªéŸ³å‘½ä»¤å¯èƒ½æœƒé‡è¤‡
                    mainStatusEl.textContent = statusText;
                    mainStatusEl.className = `${statusColor} font-bold`;
                    return;
                }

                lastPayload.t = t;
                lastPayload.s = s;

                // æ›´æ–° UI é¡¯ç¤º
                valTEl.textContent = t;
                valSEl.textContent = s;
                mainStatusEl.textContent = statusText;
                mainStatusEl.className = `${statusColor} font-bold`;

                // ç«‹å³ç™¼é€æ§åˆ¶å‘½ä»¤
                await sendControl();
            }


            // --- Initialization ---
            btnConnect.addEventListener('click', connectBLE);
            updateMotorValues(0, 0, "éœæ­¢", "text-red-400"); // ç¢ºä¿åˆå§‹ç‹€æ…‹ç‚ºéœæ­¢
        </script>
    </body>
</html>