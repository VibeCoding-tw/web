<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®‰è£èª²ç¨‹ï¼šVS Code, Copilot, PlatformIO ç’°å¢ƒè¨­å®š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* åŸºç¤æ¨£å¼ (ä½¿ç”¨ Tailwind çš„ reset) */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f4f7f9; 
            color: #333; 
        }
        .container { 
            max-width: 1200px; 
            margin: auto; 
        }
        /* é é¢æ¨™é¡Œæ¨£å¼ */
        h1 { 
            color: #28a745; /* ä¸»é¡Œè‰²ï¼šç¶ è‰² */
            text-align: center; 
            margin-bottom: 30px; 
            padding-bottom: 10px;
            border-bottom: 3px solid #e9fff0;
        }

        /* è³‡è¨Šå¡ç‰‡ç¶²æ ¼ä½ˆå±€ */
        .info-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); 
            gap: 30px; 
            margin-top: 30px;
        }
        
        /* è³‡è¨Šå¡ç‰‡æ¨£å¼ */
        .info-card { 
            background-color: #fff; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); 
            overflow: hidden; 
            padding: 25px;
            height: 100%;
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            display: flex;
            flex-direction: column;
        }
        /* é€£çµ/èª²ç¨‹å¡ç‰‡æ‡¸åœæ•ˆæœ */
        .course-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12); 
            background-color: #e9fff0; /* æ‡¸åœæ™‚ä½¿ç”¨æ·ºç¶ è‰²åé¥‹ */
            cursor: pointer;
        }

        .card-header { 
            display: flex; 
            align-items: center; 
            margin-bottom: 20px; 
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .card-header h2 { 
            margin: 0; 
            font-size: 1.5em; 
            color: #28a745; 
        }
        .card-icon { 
            width: 40px; 
            height: 40px; 
            background-color: #28a745; 
            color: #fff; 
            border-radius: 50%; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 1.5em; 
            margin-right: 15px;
        }
        
        /* å…§å®¹åˆ—è¡¨æ¨£å¼ */
        .content-list { 
            list-style: none; 
            padding: 0; 
            margin: 0; 
            flex-grow: 1; /* è®“åˆ—è¡¨ä½”æ»¿ç©ºé–“ */
        }
        .content-list li { 
            padding: 10px 0; 
            border-bottom: 1px dashed #f0f0f0; 
            font-size: 1em;
            display: flex;
            align-items: flex-start;
        }
        .content-list li:last-child { 
            border-bottom: none; 
        }
        .check-mark {
            color: #28a745;
            font-weight: bold;
            font-size: 1.2em;
            line-height: 1.5;
            margin-right: 10px;
        }

        /* åœ–ç‰‡èˆ‡è¦æ ¼æ¨£å¼ */
        .hardware-img-wrapper {
            text-align: center;
            margin-top: 20px;
            margin-bottom: 20px;
        }
        .hardware-img {
            max-width: 80%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .spec-item {
            margin-bottom: 15px;
            line-height: 1.4;
        }
        .spec-item strong {
            display: block;
            color: #333;
            margin-bottom: 3px;
        }
        .note {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 0.95em;
        }
        
        /* å‹•æ…‹æŒ‰éˆ•æ¨£å¼ */
        .action-btn { 
            margin-top: 20px; 
            width: 100%; 
            padding: 10px; 
            border-radius: 6px; 
            font-weight: bold; 
            transition: background-color 0.2s;
            cursor: pointer;
        }
    </style>
</head>
<body class="p-5">
    <div class="container">
        <header class="flex justify-between items-center py-4 px-0 border-b mb-6">
            <h1 class="text-3xl font-bold text-green-600">ğŸ› ï¸ä¸Šèª²å‰æ‡‰è©²æº–å‚™çš„äº‹é …</h1>
            <div class="flex items-center space-x-4">
                
                <a href="cart.html" class="text-gray-600 hover:text-green-600 transition duration-150 relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.2 4h12.4M15 13H7" />
                    </svg>
                </a>
                
                <div id="auth-status" class="text-sm flex items-center">
                    <span id="user-display" class="text-gray-600">è¨ªå®¢æ¨¡å¼</span>
                    <button id="login-btn" class="ml-3 bg-indigo-500 hover:bg-indigo-600 text-white text-sm py-1 px-3 rounded">ç™»å…¥</button>
                </div>
            </div>
        </header>

        <div class="info-grid">
            
            <div class="info-card course-card"
                 id="lesson-C1_SETUP" 
                 data-course-id="C1_SETUP" 
                 data-course-name="é–‹ç™¼ç’°å¢ƒå®‰è£èˆ‡è¨­å®š" 
                 data-course-price="0"
                 data-classroom-url="https://classroom.google.com/c/ODM1OTE3OTYwMTkw?cjc=72uyaadl"> 
                 <div class="card-header">
                    <div class="card-icon">IDE</div>
                    <h2>é–‹ç™¼ç’°å¢ƒå®‰è£èˆ‡è¨­å®š</h2>
                </div>
                <p style="color: #6c757d; font-style: italic;">æœ¬èª²ç¨‹ç›®æ¨™æ˜¯å°‡æ‰€æœ‰é–‹ç™¼å…ƒä»¶æ•´åˆåˆ°æ‚¨çš„é›»è…¦ä¸­ã€‚</p>
                
                <div class="hardware-img-wrapper">
                    <p style="font-size: 0.85em; color: #666; margin-top: 10px;">æ•´åˆ PlatformIO çš„ VS Code é–‹ç™¼ä»‹é¢</p>
                </div>
                
                <ul class="content-list">
                    <li><span class="check-mark">ğŸ–¥ï¸</span> <b>VS Codeï¼š</b> ä½œç‚ºæ‰€æœ‰ç¨‹å¼ç¢¼çš„æ ¸å¿ƒç·¨è¼¯å™¨ã€‚</li>
                    <li><span class="check-mark">ğŸ”Œ</span> <b>PlatformIOï¼š</b> è™•ç†æ‰€æœ‰ç·¨è­¯ã€ç‡’éŒ„å’Œå°ˆæ¡ˆç®¡ç†ã€‚</li>
                    <li><span class="check-mark">ğŸ¤–</span> <b>GitHub Copilotï¼š</b> æä¾›å³æ™‚çš„ AI ç¨‹å¼ç¢¼å»ºè­°ã€‚</li>
                </ul>
                <div class="note" style="background-color: #d4edda; color: #155724; border-left: 5px solid #28a745;">
                    <b>é‡è¦ï¼š</b> é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œå³å¯é€²å…¥ <b>Google Classroom</b> é€²è¡Œè©³ç´°çš„å®‰è£è¨­å®šæ­¥é©Ÿã€‚
                </div>
                <button id="action-btn-C1_SETUP" class="action-btn bg-gray-400 text-white" disabled>
                    è¼‰å…¥ä¸­...
                </button>
            </div>

            <div class="info-card">
                <div class="card-header">
                    <div class="card-icon">ğŸ’»</div>
                    <h2>é›»è…¦è¦æ ¼ï¼šæœ€ä½éœ€æ±‚ (å¯é‹è¡Œ)</h2>
                </div>
                <p style="color: #6c757d; font-style: italic;">æ­¤è¦æ ¼å¯é †åˆ©å®‰è£æ‰€æœ‰å·¥å…·ä¸¦é€²è¡ŒåŸºæœ¬é–‹ç™¼ï¼ŒCopilot é«”é©—å¯èƒ½å¶æœ‰å»¶é²ã€‚</p>
                
                <div class="spec-item">
                    <b style="display: block; color: #333; margin-bottom: 3px;">ä½œæ¥­ç³»çµ±ï¼š</b>
                    Windows 10/11 (64-bit)ã€macOS 12 æˆ–æ›´æ–°ç‰ˆæœ¬
                </div>
                <div class="spec-item">
                    <b style="display: block; color: #333; margin-bottom: 3px;">è™•ç†å™¨ (CPU)ï¼š</b>
                    Intel Core i3 æˆ– AMD Ryzen 3 é›™æ ¸å¿ƒè™•ç†å™¨
                </div>
                <div class="spec-item">
                    <b style="display: block; color: #333; margin-bottom: 3px;">è¨˜æ†¶é«” (RAM)ï¼š</b>
                    è‡³å°‘ <b>8 GB</b>
                </div>
                <div class="spec-item">
                    <b style="display: block; color: #333; margin-bottom: 3px;">å„²å­˜ç©ºé–“ï¼š</b>
                    è‡³å°‘ 5 GB å¯ç”¨ç©ºé–“ï¼Œå»ºè­°ä½¿ç”¨ <b>SSD</b> (å›ºæ…‹ç¡¬ç¢Ÿ)
                </div>
                <div class="spec-item">
                    <b style="display: block; color: #333; margin-bottom: 3px;">ç¶²è·¯é€£ç·šï¼š</b>
                    ç©©å®šçš„å¯¬é »ç¶²è·¯é€£ç·š
                </div>
                <div class="note" style="background-color: #fff3cd; color: #856404; border-left: 5px solid #ffc107;">
                    <b>ğŸš€ é—œéµå»ºè­°ï¼š</b> 8 GB è¨˜æ†¶é«”æ˜¯åŸºæœ¬é–€æª»ï¼Œä½†ç¢ºä¿æ“æœ‰ <b>SSD</b> å°æ–¼æå‡ç¨‹å¼è¼‰å…¥å’Œç·¨è­¯é€Ÿåº¦è‡³é—œé‡è¦ã€‚
                </div>
            </div>

            <div class="info-card">
                <div class="card-header">
                    <div class="card-icon">ğŸš€</div>
                    <h2>é›»è…¦è¦æ ¼ï¼šå»ºè­°è¦æ ¼ (æµæš¢é«”é©—)</h2>
                </div>
                <p style="color: #6c757d; font-style: italic;">æ­¤è¦æ ¼èƒ½ç¢ºä¿æ‚¨åœ¨é–‹ç™¼éç¨‹ä¸­ï¼ŒåŒæ™‚äº«å—å³æ™‚ AI è¼”åŠ©ä¸”æ“ä½œé †æš¢ã€‚</p>
                
                <div class="spec-item">
                    <b style="display: block; color: #333; margin-bottom: 3px;">ä½œæ¥­ç³»çµ±ï¼š</b>
                    Windows 11 (64-bit)ã€macOS 14 (Sonoma) æˆ–æ›´æ–°ç‰ˆæœ¬
                </div>
                <div class="spec-item">
                    <b style="display: block; color: #333; margin-bottom: 3px;">è™•ç†å™¨ (CPU)ï¼š</b>
                    Intel Core i5 æˆ– AMD Ryzen 5 å››æ ¸å¿ƒè™•ç†å™¨æˆ–æ›´é«˜ç‰ˆæœ¬
                </div>
                <div class="spec-item">
                    <b style="display: block; color: #333; margin-bottom: 3px;">è¨˜æ†¶é«” (RAM)ï¼š</b>
                    <b>16 GB</b> æˆ–æ›´é«˜
                </div>
                <div class="spec-item">
                    <b style="display: block; color: #333; margin-bottom: 3px;">å„²å­˜ç©ºé–“ï¼š</b>
                    <b>256 GB æˆ–æ›´å¤§å®¹é‡çš„ SSD</b>
                </div>
                <div class="spec-item">
                    <b style="display: block; color: #333; margin-bottom: 3px;">ç¶²è·¯é€£ç·šï¼š</b>
                    ç©©å®šä¸”é«˜é€Ÿçš„å¯¬é »é€£ç·š
                </div>
                <div class="note" style="background-color: #d4edda; color: #155724; border-left: 5px solid #28a745;">
                    å¼·çƒˆå»ºè­°é¸æ“‡ <b>16 GB è¨˜æ†¶é«”</b> çš„é›»è…¦ï¼Œé€™èƒ½ç¢ºä¿æ‚¨åŒæ™‚è™•ç†å¤šå€‹æ‡‰ç”¨ç¨‹å¼å’Œè¤‡é›œå°ˆæ¡ˆæ™‚ï¼Œç²å¾—æœ€ä½³é–‹ç™¼é«”é©—ã€‚
                </div>
            </div>

        </div>
    </div>

    <script type="module">
        // 1. åŒ¯å…¥å¿…è¦çš„ Firebase å‡½å¼
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js"; 
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-functions.js";

        // 2. æ‚¨çš„ Firebase é…ç½®
        const firebaseConfig = {
          apiKey: "AIzaSyCO6Y6Pa7b7zbieJIErysaNF6-UqbT8KJw",
          authDomain: "e-learning-942f7.firebaseapp.com",
          projectId: "e-learning-942f7",
          storageBucket: "e-learning-942f7.firebasestorage.app",
          messagingSenderId: "878397058574",
          appId: "1:878397058574:web:28aaa07a291ee3baab165f"
        };

        // 3. åˆå§‹åŒ– Firebase æœå‹™
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);           
        const functions = getFunctions(app, 'asia-east1');         
        const checkAuthFunction = httpsCallable(functions, 'checkPaymentAuthorization');
        const CART_URL = 'cart.html'; 
        const AUTH_URL = 'auth.html'; 

        // ===============================================
        // A. è³¼ç‰©è»Šæ ¸å¿ƒé‚è¼¯ (é‡æ–°åŠ å…¥)
        // ===============================================
        function addToCart(productId, productName, productPrice) {
            let cart = JSON.parse(localStorage.getItem('vibeCodingCart') || '{}');
            const priceNum = parseInt(productPrice, 10);
            
            if (!cart[productId]) {
                cart[productId] = { 
                    name: productName, 
                    price: priceNum, 
                    quantity: 1 
                };
                localStorage.setItem('vibeCodingCart', JSON.stringify(cart));
                alert(`ã€Œ${productName}ã€å·²åŠ å…¥è³¼ç‰©è»Šï¼`);
            } else {
                alert(`ã€Œ${productName}ã€å·²åœ¨è³¼ç‰©è»Šä¸­ï¼`);
            }
            window.location.href = CART_URL; 
        }

        // ===============================================
        // B. ç™»å…¥/ç™»å‡ºé‚è¼¯
        // ===============================================
        async function handleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("ç™»å…¥å¤±æ•—:", error);
            }
        }

        async function handleLogout() {
            await signOut(auth);
        }

        // ===============================================
        // C. å‹•æ…‹æŒ‰éˆ•ç‹€æ…‹æ›´æ–°æ ¸å¿ƒé‚è¼¯
        // ===============================================
        
        //const lessonCard = document.getElementById('lesson-C1_SETUP');
        const lessonCards = document.querySelectorAll('.lesson-card');

        /**
         * æ ¹æ“šæˆæ¬Šç‹€æ…‹æ›´æ–°å–®ä¸€èª²ç¨‹å¡ç‰‡çš„æŒ‰éˆ•
         */
        function updateCardAction(cardElement, status) {
            const btn = cardElement.querySelector('.action-btn');
            const courseId = cardElement.dataset.courseId;
            const courseName = cardElement.dataset.courseName;
            const coursePrice = cardElement.dataset.coursePrice;
            const classroomUrl = cardElement.dataset.classroomUrl;
            const isFreeCourse = parseInt(coursePrice, 10) === 0; // åˆ¤æ–·æ˜¯å¦ç‚ºå…è²»èª²ç¨‹
            const priceText = `NT$ ${parseInt(cardElement.dataset.coursePrice, 10).toLocaleString()}`; 

            // æ¸…é™¤æ‰€æœ‰èˆŠçš„äº‹ä»¶ç›£è½å™¨
            btn.onclick = null; 
            btn.disabled = false;
            btn.textContent = '';

            if (status === 'AUTHORIZED') {
                // ç‹€æ…‹ 1: å·²æˆæ¬Š (å·²ç™»å…¥ä¸”è¢« Cloud Function èªè­‰) -> é€²å…¥èª²ç¨‹
                btn.textContent = 'âœ… é€²å…¥èª²ç¨‹å…§å®¹';
                btn.className = 'action-btn bg-green-600 hover:bg-green-700 text-white';
                btn.onclick = () => {
                    const redirectUrl = `${AUTH_URL}?url=${encodeURIComponent(classroomUrl)}&id=${courseId}`;
                    window.location.href = redirectUrl;
                };
            } else if (status === 'UNAUTHORIZED' || status === 'NOT_LOGGED_IN') {
                // ç‹€æ…‹ 2 & 3: æœªæˆæ¬Šæˆ–æœªç™»å…¥ -> åŠ å…¥è³¼ç‰©è»Š
                if (isFreeCourse) {
                    // å…è²»èª²ç¨‹ï¼šå¼•å°ç™»å…¥
                    btn.textContent = 'ğŸ‘¤ è«‹å…ˆç™»å…¥ä»¥é€²å…¥èª²ç¨‹ (å…è²»)';
                    btn.className = 'action-btn bg-indigo-600 hover:bg-indigo-700 text-white';
                    btn.onclick = handleLogin; 
                } else {
                    btn.textContent = 'ğŸ›’ åŠ å…¥è³¼ç‰©è»Š (NT$ ' + coursePrice + ')';
                    btn.className = 'action-btn bg-indigo-600 hover:bg-indigo-700 text-white';
                    btn.onclick = () => {
                        addToCart(courseId, courseName, coursePrice); 
                    };
                }
            } else if (status === 'UNAUTHORIZED' && status !== 'NOT_LOGGED_IN') {
                // ç‹€æ…‹ 2 & 3: æœªæˆæ¬Šæˆ–æœªç™»å…¥ -> åŠ å…¥è³¼ç‰©è»Š
                if (isFreeCourse) {
                    btn.textContent = 'âœ… é€²å…¥å…è²»èª²ç¨‹';
                    btn.className = 'action-btn bg-green-600 hover:bg-green-700 text-white';
                    btn.onclick = () => {
                        const redirectUrl = `${AUTH_URL}?url=${encodeURIComponent(classroomUrl)}&id=${courseId}`;
                        window.location.href = redirectUrl;
                    };
                } else {
                    btn.textContent = 'ğŸ›’ åŠ å…¥è³¼ç‰©è»Š (NT$ ' + coursePrice + ')';
                    btn.className = 'action-btn bg-indigo-600 hover:bg-indigo-700 text-white';
                    btn.onclick = () => {
                        addToCart(courseId, courseName, coursePrice); 
                    };
                }
/*
            } else if (status === 'UNAUTHORIZED') {
                // ç‹€æ…‹ 2: å·²ç™»å…¥ä½†æœªè³¼è²· (æ”¶è²»èª²ç¨‹æœƒå‡ºç¾)
                
                if (isFreeCourse) {
                    // é‡å°å…è²»èª²ç¨‹ï¼Œå¦‚æœå·²ç™»å…¥ä½† Cloud Function å›å‚³ UNAUTHORIZEDï¼Œè¦–ç‚ºéŒ¯èª¤
                    btn.textContent = 'â›” æˆæ¬Šå¤±æ•— (è«‹è¯ç¹«å®¢æœ)';
                    btn.className = 'action-btn bg-red-600 hover:bg-red-700 text-white';
                    btn.onclick = () => window.location.reload(); 
                } else {
                    // æ”¶è²»èª²ç¨‹ï¼šå¼•å°åŠ å…¥è³¼ç‰©è»Š
                    btn.textContent = `ğŸ›’ åŠ å…¥è³¼ç‰©è»Š (${priceText})`;
                    btn.className = 'action-btn bg-indigo-600 hover:bg-indigo-700 text-white';
                    btn.onclick = () => {
                        addToCart(courseId, cardElement.dataset.courseName, cardElement.dataset.coursePrice); 
                    };
                }

            } else if (status === 'NOT_LOGGED_IN') {
                // ç‹€æ…‹ 3: æœªç™»å…¥
                
                if (isFreeCourse) {
                    // å…è²»èª²ç¨‹ï¼šå¼•å°ç™»å…¥
                    btn.textContent = 'ğŸ‘¤ è«‹å…ˆç™»å…¥ä»¥é€²å…¥èª²ç¨‹ (å…è²»)';
                    btn.className = 'action-btn bg-indigo-600 hover:bg-indigo-700 text-white';
                    btn.onclick = handleLogin; 
                } else {
                    // æ”¶è²»èª²ç¨‹ï¼šå¼•å°ç™»å…¥ï¼ˆèˆ‡ started.html é¢¨æ ¼ä¸€è‡´ï¼‰
                    btn.textContent = `ğŸ‘¤ ç™»å…¥å¾Œå¯è³¼è²· (${priceText})`;
                    btn.className = 'action-btn bg-indigo-600 hover:bg-indigo-700 text-white';
                    btn.onclick = handleLogin; 
                }
*/
            } else if (status === 'LOADING') {
                // ç‹€æ…‹ 4: è¼‰å…¥ä¸­
                btn.textContent = 'æ¬Šé™æª¢æŸ¥ä¸­...';
                btn.className = 'action-btn bg-gray-400 text-white';
                btn.disabled = true;
            } else if (status === 'ERROR') {
                // ç‹€æ…‹ 5: éŒ¯èª¤ (èˆ‡ started.html ä¸€è‡´ï¼Œé«˜è¨ºæ–·æ€§)
                btn.textContent = 'éŒ¯èª¤: é»æ“Šé‡æ–°è¼‰å…¥';
                btn.className = 'action-btn bg-red-600 hover:bg-red-700 text-white';
                btn.onclick = () => window.location.reload();
            }
        }

        /**
         * æª¢æŸ¥å–®ä¸€èª²ç¨‹çš„æˆæ¬Šç‹€æ…‹
         */
        async function checkLessonAuthorization(cardElement, user) {
            // åªæœ‰ç™»å…¥å¾Œæ‰æª¢æŸ¥æˆæ¬Š
            if (!user) {
                updateCardAction(cardElement, 'NOT_LOGGED_IN');
                return;
            }

            updateCardAction(cardElement, 'LOADING');

            const courseId = cardElement.dataset.courseId;
            const classroomUrl = cardElement.dataset.classroomUrl;

            try {
                // å‘¼å« Cloud Function æª¢æŸ¥æˆæ¬Š
                const result = await checkAuthFunction({ 
                    courseId: courseId, 
                    targetUrl: encodeURIComponent(classroomUrl) 
                });

                const status = result.data.status; 
                
                // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
                updateCardAction(cardElement, status);

            } catch (error) {
                console.error(`èª²ç¨‹ ${courseId} æˆæ¬Šæª¢æŸ¥å¤±æ•—:`, error);
                // æª¢æŸ¥å¤±æ•—ï¼Œä½¿ç”¨ ERROR ç‹€æ…‹ (é«˜è¨ºæ–·æ€§)
                updateCardAction(cardElement, 'ERROR'); 
            }
        }

        // ----------------------------------------------------
        // D. ç¸½é«”æˆæ¬Šæµç¨‹æ§åˆ¶å™¨ 
        // ----------------------------------------------------
        onAuthStateChanged(auth, (user) => {
            const userDisplay = document.getElementById('user-display');
            const loginBtn = document.getElementById('login-btn');

            if (user) {
                // 1. å·²ç™»å…¥
                userDisplay.textContent = `æ‚¨å¥½, ${user.displayName || user.email}`;
                loginBtn.textContent = 'ç™»å‡º';
                loginBtn.onclick = handleLogout;
                
                // æª¢æŸ¥èª²ç¨‹æˆæ¬Š
                checkLessonAuthorization(lessonCard, user); 

            } else {
                // 2. æœªç™»å…¥
                userDisplay.textContent = 'è¨ªå®¢æ¨¡å¼';
                loginBtn.textContent = 'ç™»å…¥';
                loginBtn.onclick = handleLogin;
                
                // é¡¯ç¤ºæœªç™»å…¥ç‹€æ…‹
                updateCardAction(lessonCard, 'NOT_LOGGED_IN');
            }
        });

    </script>
</body>
</html>