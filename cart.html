<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Coding å¾…çµå¸³é …ç›®</title> 
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* çµ±ä¸€ç§»é™¤æŒ‰éˆ•æ¨£å¼ */
        .remove-cart-item-btn {
            color: #ef4444; /* red-500 */
            font-size: 0.75rem; /* text-xs */
            transition: color 0.2s;
        }
        .remove-cart-item-btn:hover {
            text-decoration: underline;
            color: #b91c1c; /* red-700 */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-indigo-600">Vibe Coding</h1> 
            <div id="auth-status" class="text-sm text-gray-600">
                <span id="user-display">è«‹ç™»å…¥</span>
                <button id="login-btn" class="ml-3 bg-indigo-500 hover:bg-indigo-600 text-white text-xs py-1 px-3 rounded">ç™»å…¥ / è¨»å†Š</button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-6">
        
        <section class="bg-white p-6 rounded-lg shadow-xl mb-10">
            <h2 class="text-3xl font-extrabold text-gray-800 border-b pb-4 mb-6">å¾…çµå¸³é …ç›®</h2>
            
            <div id="auth-error-message" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4" role="alert">
                <p class="font-bold">ç™»å…¥å¤±æ•—é€šçŸ¥</p>
                <p id="error-details">æ‚¨çš„ç™»å…¥å˜—è©¦å¤±æ•—ï¼ŒåŸå› å¯èƒ½ç‚ºç€è¦½å™¨é˜»æ“‹ã€‚æˆ‘å€‘å·²åˆ‡æ›åˆ°ã€Œé é¢é‡æ–°å°å‘ã€æ–¹å¼ï¼Œè«‹é‡æ–°é»æ“Šç™»å…¥ã€‚</p>
            </div>
            
            <div id="unpaid-items" class="space-y-4">
            </div>
            <p id="empty-cart-msg" class="text-gray-500 italic text-center pt-4">è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼è«‹å›åˆ°èª²ç¨‹é é¢é¸è³¼ã€‚</p>
            
            <div id="cart-summary" class="mt-8 pt-4 border-t-2 border-dashed border-gray-200">
                <div class="flex justify-between items-center text-2xl font-bold text-gray-800">
                    <span>ç¸½é‡‘é¡ (TWD):</span>
                    <span id="cart-total">0</span>
                </div>
                <button id="checkout-btn" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white text-lg py-3 rounded-lg disabled:opacity-50" disabled>
                    ğŸ’³ å‰å¾€ä»˜æ¬¾
                </button>
            </div>
        </section>

        </main>

    <script type="module">
        // 1. åŒ¯å…¥å¿…è¦çš„ Firebase å‡½å¼
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js"; 
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, signOut, getRedirectResult } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-functions.js";


        // 2. æ‚¨çš„ Firebase é…ç½®
        const firebaseConfig = {
          apiKey: "AIzaSyCO6Y6Pa7b7zbieJIErysaNF6-UqbT8KJw",
          authDomain: "e-learning-942f7.firebaseapp.com",
          projectId: "e-learning-942f7",
          storageBucket: "e-learning-942f7.firebasestorage.app",
          messagingSenderId: "878397058574",
          appId: "1:878397058574:web:28aaa07a291ee3baab165f"
        };

        // 3. åˆå§‹åŒ– Firebase æœå‹™
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);    
        const functions = getFunctions(app, 'asia-east1'); 
        const initLinePay = httpsCallable(functions, 'initiateLinePayPayment');
        
        // ===============================================
        // A. è³¼ç‰©è»Šé …ç›®æ¸²æŸ“é‚è¼¯
        // ===============================================

        // è³¼ç‰©è»Šå®¹å™¨
        const unpaidItemsContainer = document.getElementById('unpaid-items');
        const emptyMsg = document.getElementById('empty-cart-msg');
        const cartTotalElement = document.getElementById('cart-total');
        const checkoutBtn = document.getElementById('checkout-btn');
        const authErrorMessage = document.getElementById('auth-error-message');
        const errorDetails = document.getElementById('error-details');


        /**
         * ç§»é™¤è³¼ç‰©è»Šé …ç›®çš„æ ¸å¿ƒé‚è¼¯ 
         * @param {string} productId - è¦ç§»é™¤çš„ç”¢å“ ID
         */
        function removeFromCart(productId) {
            let cart = JSON.parse(localStorage.getItem('vibeCodingCart') || '{}');
            delete cart[productId];
            localStorage.setItem('vibeCodingCart', JSON.stringify(cart));
            renderCartItems(); // é‡æ–°æ¸²æŸ“é é¢ï¼Œå¯¦ç¾å³æ™‚åˆ·æ–°
        }

        /**
         * æ¸²æŸ“è³¼ç‰©è»Šæ‰€æœ‰é …ç›®
         */
        function renderCartItems() {
            const cart = JSON.parse(localStorage.getItem('vibeCodingCart') || '{}');
            let total = 0;
            
            unpaidItemsContainer.innerHTML = ''; 

            if (Object.keys(cart).length === 0) {
                emptyMsg.style.display = 'block';
                cartTotalElement.textContent = '0';
                checkoutBtn.disabled = true;
                return;
            } else {
                emptyMsg.style.display = 'none';
            }

            for (const [id, item] of Object.entries(cart)) {
                // ç¢ºä¿åƒ¹æ ¼æ˜¯æ•¸å­—ï¼Œæé«˜å¥å£¯æ€§
                const price = parseFloat(item.price) || 0;
                const quantity = parseInt(item.quantity) || 1;

                const itemTotal = price * quantity;
                total += itemTotal;

                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex justify-between items-center bg-gray-50 p-3 rounded-md border';
                itemDiv.innerHTML = `
                    <div>
                        <p class="font-semibold text-gray-800">${item.name}</p>
                        <p class="text-xs text-gray-500">ç”¢å“ä»£è™Ÿ: ${id}</p>
                    </div>
                    <div class="text-right">
                         <p class="font-bold text-indigo-600">${itemTotal.toLocaleString()} å…ƒ</p>
                         <button class="remove-cart-item-btn" data-product-id="${id}">ç§»é™¤</button>
                    </div>
                `;
                unpaidItemsContainer.appendChild(itemDiv);
            }

            // ç¸½é‡‘é¡è¼¸å‡º
            cartTotalElement.textContent = total.toLocaleString();
            checkoutBtn.disabled = (total === 0);

            // ç¶å®šç§»é™¤æŒ‰éˆ•äº‹ä»¶
            document.querySelectorAll('.remove-cart-item-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const productId = event.currentTarget.dataset.productId;
                    removeFromCart(productId);
                });
            });
        }

        // é é¢è¼‰å…¥æ™‚ï¼Œå…ˆæ¸²æŸ“è³¼ç‰©è»Šå…§å®¹
        renderCartItems();


        // ===============================================
        // B. èº«ä»½é©—è­‰é‚è¼¯ (ä½¿ç”¨ Redirect è§£æ±ºå½ˆçª—å•é¡Œ)
        // ===============================================
        
        /**
         * è™•ç†ç™»å…¥ï¼Œæ”¹ç‚ºé é¢é‡æ–°å°å‘
         */
         async function handleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("ç™»å…¥å¤±æ•—:", error);
            }
        }

        async function handleLogout() {
            await signOut(auth);
            // ç™»å‡ºå¾Œé‡æ–°æ¸²æŸ“ç‹€æ…‹
            onAuthStateChanged(auth, () => {}); 
        }
        
        /**
         * è™•ç†ç™»å…¥å›å‚³çµæœ (å¿…é ˆåœ¨é é¢é ‚éƒ¨åŸ·è¡Œ)
         */
        async function handleRedirectResult() {
            try {
                // å˜—è©¦ç²å–å¾ Google é‡æ–°å°å‘å›ä¾†çš„çµæœ
                const result = await getRedirectResult(auth);
                if (result) {
                    // ç™»å…¥æˆåŠŸï¼ŒonAuthStateChanged æœƒè¢«è§¸ç™¼
                    console.log("ç™»å…¥æˆåŠŸ (Redirect Result):", result.user.displayName);
                    authErrorMessage.style.display = 'none';
                }
            } catch (error) {
                // ç™»å…¥å¤±æ•—è™•ç†
                console.error("ç™»å…¥å¤±æ•— (Redirect Error):", error);
                authErrorMessage.style.display = 'block';
                errorDetails.textContent = `ç™»å…¥å¤±æ•—ï¼š${error.message}ã€‚æˆ‘å€‘å·²ä½¿ç”¨é‡æ–°å°å‘æ–¹å¼ï¼Œè«‹å†æ¬¡å˜—è©¦ç™»å…¥ã€‚`;
            }
        }

        // é é¢è¼‰å…¥æ™‚ç«‹å³æª¢æŸ¥æ˜¯å¦æœ‰é‡æ–°å°å‘çµæœ
        handleRedirectResult();

        // ç›£è½ç™»å…¥ç‹€æ…‹è®ŠåŒ– (åªç”¨æ–¼æ›´æ–°é ‚éƒ¨ UI)
        onAuthStateChanged(auth, (user) => {
            const userDisplay = document.getElementById('user-display');
            const loginBtn = document.getElementById('login-btn');
            
            if (user) {
                // å·²ç™»å…¥
                userDisplay.textContent = `æ‚¨å¥½, ${user.displayName || user.email}`;
                loginBtn.textContent = 'ç™»å‡º';
                loginBtn.onclick = handleLogout;
            } else {
                // æœªç™»å…¥
                userDisplay.textContent = 'è¨ªå®¢æ¨¡å¼';
                loginBtn.textContent = 'ç™»å…¥ / è¨»å†Š';
                loginBtn.onclick = handleLogin;
            }
        });

        // ===============================================
        // C. ä»˜æ¬¾æŒ‰éˆ•é‚è¼¯
        // ===============================================

        checkoutBtn.addEventListener('click', () => {
            const totalText = cartTotalElement.textContent.replace(/,/g, '').trim();
            const total = parseInt(totalText);

            if (total <= 0) {
                alert("è³¼ç‰©è»Šç‚ºç©ºï¼Œç„¡æ³•çµå¸³ã€‚");
                return;
            }

            if (!auth.currentUser) {
                alert("è«‹å…ˆç™»å…¥æ‰èƒ½é€²è¡Œä»˜æ¬¾ï¼é é¢å°‡è·³è½‰è‡³ç™»å…¥æµç¨‹...");
                // å»ºè­°è‡ªå‹•å¼•å°ç™»å…¥ï¼ˆæ­¤æ™‚æœƒè§¸ç™¼é é¢è·³è½‰ï¼‰
                handleLogin(); 
                return;
            }
            
            // ç²å–è³¼ç‰©è»Šå…§å®¹å’Œç•¶å‰ç”¨æˆ¶
            const cartItems = JSON.parse(localStorage.getItem('vibeCodingCart') || '{}');
            const user = auth.currentUser;

            // å‘¼å« Cloud Function è™•ç† Line Pay è«‹æ±‚
            handleLinePayCheckout(user, total, cartItems);
        });

        /**
         * è™•ç†èˆ‡å¾Œç«¯çš„ Line Pay çµå¸³æµç¨‹
         * ğŸš¨ æ³¨æ„ï¼šæ­¤åŠŸèƒ½éœ€è¦å¾Œç«¯ Cloud Function (initiateLinePayPayment) æ”¯æ´
         */
        async function handleLinePayCheckout(user, total, cartItems) {
            checkoutBtn.disabled = true;
            checkoutBtn.textContent = 'ğŸ“ æ­£åœ¨å»ºç«‹ Line Pay äº¤æ˜“...';
            
            try {
                const response = await initLinePay({
                    amount: total,
                    userId: user.uid,
                    cartDetails: cartItems, // å‚³éè©³ç´°è³¼ç‰©è»Šå…§å®¹çµ¦å¾Œç«¯
                    // è®“å¾Œç«¯çŸ¥é“ä»˜æ¬¾æˆåŠŸå¾Œï¼Œè¦å°‡ç”¨æˆ¶å°å›å“ªå€‹é é¢
                    confirmUrl: window.location.origin + '/payment-confirm.html' 
                });

                // æˆåŠŸå»ºç«‹äº¤æ˜“
                if (response.data && response.data.webPaymentUrl) {
                    console.log("Line Pay äº¤æ˜“å»ºç«‹æˆåŠŸï¼Œæ­£åœ¨å°å‘...");
                    // å°å‘ Line Pay å®˜æ–¹ä»˜æ¬¾é é¢
                    window.location.href = response.data.webPaymentUrl;
                } else {
                    throw new Error(response.data.message || 'Line Pay å»ºç«‹å¤±æ•—ã€‚');
                }

            } catch (error) {
                console.error("Line Pay çµå¸³å¤±æ•—:", error);
                alert(`çµå¸³å¤±æ•—ï¼š${error.message}ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚`);
                checkoutBtn.disabled = false;
                checkoutBtn.textContent = 'ğŸ’³ å‰å¾€ä»˜æ¬¾';
            }
        }
        
    </script>
</body>
</html>