<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe Coding è³¼ç‰©è»Šèˆ‡èª²ç¨‹ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .lesson-card {
            transition: transform 0.2s;
        }
        .lesson-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl font-bold text-indigo-600">Vibe Coding èª²ç¨‹ä¸­å¿ƒ</h1>
            <div id="auth-status" class="text-sm text-gray-600">
                <span id="user-display">è«‹ç™»å…¥</span>
                <button id="login-btn" class="ml-3 bg-indigo-500 hover:bg-indigo-600 text-white text-xs py-1 px-3 rounded">ç™»å…¥ / è¨»å†Š</button>
            </div>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-6">
        
        <section class="bg-white p-6 rounded-lg shadow-xl mb-10">
            <h2 class="text-3xl font-extrabold text-gray-800 border-b pb-4 mb-6">ğŸ›’ æ‚¨çš„è³¼ç‰©è»Š (å¾…çµå¸³é …ç›®)</h2>
            
            <div id="unpaid-items" class="space-y-4">
                <p id="empty-cart-msg" class="text-gray-500 italic">è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼è«‹å›åˆ°èª²ç¨‹é é¢é¸è³¼ã€‚</p>
            </div>
            
            <div id="cart-summary" class="mt-8 pt-4 border-t-2 border-dashed border-gray-200">
                <div class="flex justify-between items-center text-2xl font-bold text-gray-800">
                    <span>ç¸½é‡‘é¡ (TWD):</span>
                    <span id="cart-total">0</span>
                </div>
                <button id="checkout-btn" class="w-full mt-6 bg-green-600 hover:bg-green-700 text-white text-lg py-3 rounded-lg disabled:opacity-50" disabled>
                    ğŸ’³ å‰å¾€ä»˜æ¬¾
                </button>
            </div>
        </section>

        
        <section class="bg-white p-6 rounded-lg shadow-xl">
            <h2 class="text-3xl font-extrabold text-gray-800 border-b pb-4 mb-6">âœ… å·²ä»˜æ¬¾é …ç›® (èª²ç¨‹ä¸­å¿ƒ)</h2>
            
            <div id="authorized-lessons" class="space-y-4">
                <div id="auth-status-loading" class="text-indigo-600">
                    <p>è«‹é»æ“Šå³ä¸Šè§’ã€Œç™»å…¥ã€æŒ‰éˆ•ï¼Œæª¢æŸ¥æ‚¨çš„èª²ç¨‹æ¬Šé™ã€‚</p>
                </div>
                </div>
        </section>

    </main>

    <script type="module">
        // 1. åŒ¯å…¥å¿…è¦çš„ Firebase å‡½å¼ (ä½¿ç”¨æ‚¨æŒ‡å®šçš„ 12.6.0 ç‰ˆæœ¬)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js"; 
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-analytics.js";
        
        // åŒ¯å…¥ Auth å’Œ Functions SDK
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-functions.js";


        // 2. æ‚¨çš„ Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyBv2fciGdUD4CifE1fH3hnzzamPdrvjjN8",
            authDomain: "onlinelearning-b5cfc.firebaseapp.com",
            projectId: "onlinelearning-b5cfc",
            storageBucket: "onlinelearning-b5cfc.firebasestorage.app",
            messagingSenderId: "505254683984",
            appId: "1:505254683984:web:9653dfa4eef5489cedf855",
            measurementId: "G-P5LQ23Y31Q"
        };

        // 3. åˆå§‹åŒ– Firebase æœå‹™
        const app = initializeApp(firebaseConfig);
        // const analytics = getAnalytics(app); // é™¤éæœ‰è¿½è¹¤éœ€æ±‚ï¼Œå¦å‰‡å¯ä»¥è¨»è§£æ‰
        const auth = getAuth(app);           
        
        // è«‹å°‡ 'asia-east1' æ›¿æ›ç‚ºæ‚¨çš„ Cloud Function éƒ¨ç½²åœ°å€
        const functions = getFunctions(app, 'asia-east1'); 
        
        // ğŸš¨ é€™æ˜¯æ–°çš„ Cloud Function åç¨±ï¼Œç”¨æ–¼æŸ¥è©¢ç”¨æˆ¶å·²æˆæ¬Šçš„èª²ç¨‹åˆ—è¡¨
        const getAuthorizedCourses = httpsCallable(functions, 'getAuthorizedCourses');


        // ===============================================
        // A. è³¼ç‰©è»Šé …ç›®æ¸²æŸ“é‚è¼¯
        // ===============================================

        function renderCartItems() {
            const cart = JSON.parse(localStorage.getItem('vibeCodingCart') || '{}');
            const unpaidItemsContainer = document.getElementById('unpaid-items');
            const emptyMsg = document.getElementById('empty-cart-msg');
            let total = 0;
            
            unpaidItemsContainer.innerHTML = ''; 

            if (Object.keys(cart).length === 0) {
                emptyMsg.style.display = 'block';
                document.getElementById('cart-total').textContent = '0';
                document.getElementById('checkout-btn').disabled = true;
                return;
            } else {
                emptyMsg.style.display = 'none';
            }

            for (const [id, item] of Object.entries(cart)) {
                const itemTotal = item.price * item.quantity;
                total += itemTotal;

                const itemHTML = `
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded-md border">
                        <div>
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-xs text-gray-500">ç”¢å“ä»£è™Ÿ: ${id}</p>
                        </div>
                        <div class="text-right">
                             <p class="font-bold text-indigo-600">${itemTotal} å…ƒ</p>
                             <button class="text-red-500 text-xs hover:underline" data-product-id="${id}" onclick="removeFromCart('${id}')">ç§»é™¤</button>
                        </div>
                    </div>
                `;
                unpaidItemsContainer.innerHTML += itemHTML;
            }

            document.getElementById('cart-total').textContent = total.toLocaleString();
            document.getElementById('checkout-btn').disabled = (total === 0);
        }

        // å®šç¾©ç§»é™¤è³¼ç‰©è»Šé …ç›®çš„å‡½å¼ (ä¾›æŒ‰éˆ•é»æ“Šä½¿ç”¨)
        window.removeFromCart = function(productId) {
            let cart = JSON.parse(localStorage.getItem('vibeCodingCart') || '{}');
            delete cart[productId];
            localStorage.setItem('vibeCodingCart', JSON.stringify(cart));
            renderCartItems(); // é‡æ–°æ¸²æŸ“é é¢
        }

        // é é¢è¼‰å…¥æ™‚ï¼Œå…ˆæ¸²æŸ“è³¼ç‰©è»Šå…§å®¹
        renderCartItems();


        // ===============================================
        // B. èº«ä»½é©—è­‰èˆ‡èª²ç¨‹ä¸­å¿ƒé‚è¼¯
        // ===============================================
        
        async function handleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("ç™»å…¥å¤±æ•—:", error);
                alert("ç™»å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            }
        }

        async function handleLogout() {
            await signOut(auth);
            alert("å·²ç™»å‡ºã€‚");
        }

        async function renderAuthorizedLessons(user) {
            const lessonsContainer = document.getElementById('authorized-lessons');
            lessonsContainer.innerHTML = '<p class="text-indigo-600">æ­£åœ¨æŸ¥è©¢æ‚¨çš„èª²ç¨‹æ¬Šé™...</p>';

            try {
                // å‘¼å« Cloud Function å–å¾—ç”¨æˆ¶çš„æˆæ¬Šèª²ç¨‹åˆ—è¡¨
                const result = await getAuthorizedCourses(); 
                const courses = result.data.courses || [];
                
                if (courses.length === 0) {
                    lessonsContainer.innerHTML = '<p class="text-gray-500">æ‚¨ç›®å‰æ²’æœ‰å·²æˆæ¬Šçš„èª²ç¨‹ã€‚è«‹å…ˆè³¼è²·ï¼</p>';
                    return;
                }
                
                let lessonsHTML = '';
                courses.forEach(course => {
                    const buttonClass = course.redirectUrl ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-gray-400 cursor-not-allowed';
                    
                    lessonsHTML += `
                        <div class="lesson-card flex justify-between items-center p-4 bg-white border rounded-lg shadow-sm">
                            <div class="flex flex-col">
                                <p class="font-semibold text-gray-800">${course.name}</p>
                                <p class="text-sm text-gray-500">ä»£è™Ÿ: ${course.courseId} / æ•™å®¤ä»£ç¢¼: ${course.classCode || 'N/A'}</p>
                            </div>
                            <a href="${course.redirectUrl || '#'}" target="_blank" 
                                class="text-white py-2 px-4 rounded ${buttonClass}"
                                ${course.redirectUrl ? '' : 'disabled'}>
                                é€²å…¥èª²ç¨‹
                            </a>
                        </div>
                    `;
                });

                lessonsContainer.innerHTML = lessonsHTML;

            } catch (error) {
                console.error("ç²å–æˆæ¬Šèª²ç¨‹å¤±æ•—:", error);
                lessonsContainer.innerHTML = '<p class="text-red-500">æŸ¥è©¢èª²ç¨‹æ¬Šé™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ã€‚</p>';
            }
        }
        
        // ç›£è½ç™»å…¥ç‹€æ…‹è®ŠåŒ–
        onAuthStateChanged(auth, (user) => {
            const userDisplay = document.getElementById('user-display');
            const loginBtn = document.getElementById('login-btn');
            
            if (user) {
                // å·²ç™»å…¥
                userDisplay.textContent = `æ‚¨å¥½, ${user.displayName || user.email}`;
                loginBtn.textContent = 'ç™»å‡º';
                loginBtn.onclick = handleLogout;
                renderAuthorizedLessons(user); // æª¢æŸ¥å·²ä»˜æ¬¾èª²ç¨‹
            } else {
                // æœªç™»å…¥
                userDisplay.textContent = 'è¨ªå®¢æ¨¡å¼';
                loginBtn.textContent = 'ç™»å…¥ / è¨»å†Š';
                loginBtn.onclick = handleLogin;
                document.getElementById('authorized-lessons').innerHTML = '<p class="text-gray-500">è«‹ç™»å…¥ä»¥æŸ¥çœ‹æ‚¨çš„å·²ä»˜æ¬¾èª²ç¨‹ã€‚</p>';
            }
        });

        // ===============================================
        // C. ä»˜æ¬¾æŒ‰éˆ•é‚è¼¯ (é€™è£¡åƒ…ç‚ºæ¨¡æ“¬ï¼Œéœ€æ›¿æ›ç‚ºå¯¦éš›æ”¯ä»˜ä»‹é¢å°å‘)
        // ===============================================
        document.getElementById('checkout-btn').addEventListener('click', () => {
            const total = document.getElementById('cart-total').textContent.replace(/,/g, '');
            if (parseInt(total) > 0) {
                alert(`æ¨¡æ“¬ä»˜æ¬¾æµç¨‹ï¼šæ‚¨å°‡æ”¯ä»˜ ${total} å…ƒã€‚`);
                
                // ğŸš¨ é€™è£¡æ‡‰æ›¿æ›ç‚ºå°å‘åˆ°æ‚¨çš„ç¬¬ä¸‰æ–¹æ”¯ä»˜ä»‹é¢ï¼ˆç¶ ç•Œ/æ”¯ä»˜å¯¶/Stripe ç­‰ï¼‰
                // æ¨¡æ“¬ä»˜æ¬¾æˆåŠŸå¾Œï¼Œé€šå¸¸æ˜¯å¾Œç«¯ Webhook æ›´æ–° paid_usersï¼Œç„¶å¾Œå‰ç«¯æ¸…ç©ºè³¼ç‰©è»Š
                
                // æ¨¡æ“¬æ¸…ç©ºè³¼ç‰©è»Š (å®Œæˆäº¤æ˜“å¾Œ)
                // localStorage.removeItem('vibeCodingCart'); 
                // renderCartItems();
            }
        });
        
    </script>
</body>
</html>