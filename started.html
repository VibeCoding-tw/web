<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¥é–€èª²ç¨‹ï¼šWeb App é™æ§å™¨è¨­è¨ˆèˆ‡ Web BLE æ•´åˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* åŸºç¤æ¨£å¼ */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f9; color: #333; }
        
        /* èª²ç¨‹ç¶²æ ¼èˆ‡å¡ç‰‡ */
        .lesson-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        .lesson-card { 
            background-color: #fff; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); 
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            height: 100%; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .lesson-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12); 
            background-color: #e9f0ff; /* æ”¹è®Šæ‡¸åœé¡è‰²ä»¥åŒ¹é…ä¸»é¡Œ */
        }
        .lesson-header { background-color: #e9f0ff; padding: 15px 20px; border-bottom: 2px solid #3b82f6; } /* æ”¹ç”¨ Tailwind Blue-500 */
        .lesson-header h2 { margin: 0; font-size: 1.25em; color: #3b82f6; }
        .lesson-body { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .lesson-icon { width: 50px; height: 50px; background-color: #3b82f6; color: #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2em; margin-bottom: 15px; }
        .phase-tag { display: inline-block; background-color: #6c757d; color: #fff; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; margin-bottom: 10px; }
        .core-content { margin-top: 15px; font-size: 0.9em; color: #555; flex-grow: 1;}
        .core-content ul { list-style: disc; padding-left: 20px; margin: 5px 0 0 0; }
        .duration { font-style: italic; color: #666; margin-top: 5px; font-size: 0.9em; }
        
        /* å‹•æ…‹æŒ‰éˆ•æ¨£å¼ */
        .action-btn { 
            margin-top: 20px; 
            width: 100%; 
            padding: 10px; 
            border-radius: 6px; 
            font-weight: bold; 
            transition: background-color 0.2s;
            cursor: pointer;
        }
    </style>
</head>
<body class="p-5"> <div class="container mx-auto">
        <header class="flex justify-between items-center py-4 px-0 border-b mb-6">
            <h1 class="text-3xl font-bold text-indigo-600">ğŸ“± å…¥é–€èª²ç¨‹ï¼šWeb App é™æ§å™¨è¨­è¨ˆèˆ‡ Web BLE æ•´åˆ</h1>
            <div class="flex items-center space-x-4">                
                <a href="cart.html" class="text-gray-600 hover:text-indigo-600 transition duration-150 relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.2 4h12.4M15 13H7" />
                    </svg>
                </a>
                <div id="auth-status" class="text-sm flex items-center">
                    <span id="user-display" class="text-gray-600">è¨ªå®¢æ¨¡å¼</span>
                    <button id="login-btn" class="ml-3 bg-indigo-500 hover:bg-indigo-600 text-white text-sm py-1 px-3 rounded">ç™»å…¥</button>
                </div>
            </div>
        </header>

        <div class="lesson-grid">
            <div class="lesson-card" 
                 id="lesson-C1_L1" 
                 data-course-id="ydb63bg" 
                 data-course-name="We App å¿«é€Ÿå…¥é–€èˆ‡ UI/UX è¨­è¨ˆ" 
                 data-course-price="1200"
                 data-classroom-url="https://classroom.google.com/c/MTIwMDA5MzE2NjFa?cjc=ydb63bg">
                <div class="lesson-header">
                    <h2>ç¬¬ 1 èª²ï¼šWe App å¿«é€Ÿå…¥é–€èˆ‡ UI/UX è¨­è¨ˆ <span class="duration">(3H)</span></h2>
                </div>
                <div class="lesson-body">
                    <div class="lesson-icon" title="UI/UX Icon">ğŸ¨</div>
                    <span class="phase-tag">I. Web App åŸºç¤èˆ‡ BLE é€£ç·š</span>
                    <div class="core-content">
                        <strong>æ ¸å¿ƒå…§å®¹ï¼š</strong>
                        <ul>
                            <li>åŸºç¤ä½ˆå±€ï¼ˆFlexbox/Gridï¼‰èˆ‡ Tailwind CSS æ‡‰ç”¨ã€‚</li>
                            <li>é™æ§å™¨éŸ¿æ‡‰å¼ç•Œé¢è¨­è¨ˆã€è¡Œå‹•ç«¯è§¸æ§è€ƒé‡ã€‚</li>
                            <li>å¯¦ä½œå–®ä¸€ HTML æª”æ¡ˆï¼Œè¨­è¨ˆé€£ç·šèˆ‡ç‹€æ…‹é¡¯ç¤ºå€å¡Šã€‚</li>
                        </ul>
                    </div>
                    <button id="action-btn-C1_L1" class="action-btn bg-gray-400 text-white" disabled>
                        è¼‰å…¥ä¸­...
                    </button>
                </div>
            </div>

            <div class="lesson-card" id="lesson-C1_L2" data-course-id="a45cwlak" data-course-name="Web BLE å®¢æˆ¶ç«¯é€£ç·šé‚è¼¯" data-course-price="1200" data-classroom-url="https://classroom.google.com/c/ODM2MDU1NDE1NTg2?cjc=a45cwlak">
                <div class="lesson-header"><h2>ç¬¬ 2 èª²ï¼šWeb BLE å®¢æˆ¶ç«¯é€£ç·šé‚è¼¯å¯¦ä½œ <span class="duration">(3H)</span></h2></div>
                <div class="lesson-body">
                    <div class="lesson-icon" title="Bluetooth Icon">ğŸ”—</div>
                    <span class="phase-tag">I. Web App åŸºç¤èˆ‡ BLE é€£ç·š</span>
                    <div class="core-content">
                        <strong>æ ¸å¿ƒå…§å®¹ï¼š</strong>
                        <ul>
                            <li>ä»‹ç´¹ JavaScript Web BLE APIï¼š`navigator.bluetooth` èˆ‡æ¬Šé™æ¨¡å‹ã€‚</li>
                            <li>å¯¦ä½œ `requestDevice`ã€`gatt.connect`ã€æœå‹™èˆ‡ç‰¹å¾µå€¼ (UUID) è™•ç†ã€‚</li>
                            <li>å¯¦ç¾é€£ç·š/æ–·é–‹æŒ‰éˆ•åŠŸèƒ½ï¼Œä½¿ç”¨ JS ç›£è½é€£ç·šç‹€æ…‹ã€‚</li>
                        </ul>
                    </div>
                    <button id="action-btn-C1_L2" class="action-btn bg-gray-400 text-white" disabled>è¼‰å…¥ä¸­...</button></div>
            </div>
            
            <div class="lesson-card" id="lesson-C1_L3" data-course-id="a7smdfeq" data-course-name="åŸºç¤æŒ‰éˆ•æ§åˆ¶èˆ‡ API æ•¸æ“šæ ¼å¼åŒ–" data-course-price="1200" data-classroom-url="https://classroom.google.com/c/ODIxNTU0MDcyODMy?cjc=a7smdfeq">
                <div class="lesson-header"><h2>ç¬¬ 3 èª²ï¼šåŸºç¤æŒ‰éˆ•æ§åˆ¶èˆ‡ API æ•¸æ“šæ ¼å¼åŒ– <span class="duration">(3H)</span></h2></div>
                <div class="lesson-body"><div class="lesson-icon" title="Control Icon">ğŸ•¹ï¸</div><span class="phase-tag">II. æŒ‰éˆ•æ§åˆ¶èˆ‡ API æ•¸æ“šå°åŒ…</span><div class="core-content"><strong>æ ¸å¿ƒå…§å®¹ï¼š</strong><ul><li>æ•¸æ“šå°åŒ…è¨­è¨ˆï¼šå°‡æŒ‰éˆ•äº‹ä»¶è½‰æ›ç‚º API å­—ä¸²æ ¼å¼ï¼ˆå¦‚ CMD, F, 180ï¼‰ã€‚</li><li>Web BLE å¯«å…¥å¯¦ä½œï¼šä½¿ç”¨ `characteristic.writeValue` ç™¼é€æŒ‡ä»¤ã€‚</li></ul></div><button id="action-btn-C1_L3" class="action-btn bg-gray-400 text-white" disabled>è¼‰å…¥ä¸­...</button></div>
            </div>
            
            <div class="lesson-card" id="lesson-C1_L4" data-course-id="hkdq5j3m" data-course-name="è§¸æ§äº‹ä»¶å„ªåŒ–ï¼šé•·æŒ‰èˆ‡æ”¾é–‹" data-course-price="1200" data-classroom-url="https://classroom.google.com/c/ODIxNTU0NDk5MzE5?cjc=hkdq5j3m">
                <div class="lesson-header"><h2>ç¬¬ 4 èª²ï¼šè§¸æ§äº‹ä»¶å„ªåŒ–ï¼šé•·æŒ‰èˆ‡æ”¾é–‹ <span class="duration">(3H)</span></h2></div>
                <div class="lesson-body"><div class="lesson-icon" title="Touch Icon">ğŸ‘†</div><span class="phase-tag">II. æŒ‰éˆ•æ§åˆ¶èˆ‡ API æ•¸æ“šå°åŒ…</span><div class="core-content"><strong>æ ¸å¿ƒå…§å®¹ï¼š</strong><ul><li>å€åˆ†åŸç”Ÿè§¸æ§äº‹ä»¶ï¼š`mousedown/mouseup` å’Œ `touchstart/touchend`ã€‚</li><li>å¯¦ç¾é•·æŒ‰ç™¼é€æŒçºŒç§»å‹•æŒ‡ä»¤ï¼Œæ”¾é–‹ç™¼é€åœæ­¢æŒ‡ä»¤ï¼ˆä½¿ç”¨ `setInterval`ï¼‰ã€‚</li></ul></div><button id="action-btn-C1_L4" class="action-btn bg-gray-400 text-white" disabled>è¼‰å…¥ä¸­...</button></div>
            </div>

            <div class="lesson-card" id="lesson-C1_L5" data-course-id="io5rxgxl" data-course-name="è™›æ“¬æ–æ¡¿ UI è£½ä½œèˆ‡åº§æ¨™æ“·å–" data-course-price="1200" data-classroom-url="https://classroom.google.com/c/ODIxNzY4MjMzMDQ4?cjc=io5rxgxl">
                <div class="lesson-header"><h2>ç¬¬ 5 èª²ï¼šè™›æ“¬æ–æ¡¿ UI è£½ä½œèˆ‡åº§æ¨™æ“·å– <span class="duration">(3H)</span></h2></div>
                <div class="lesson-body"><div class="lesson-icon" title="Canvas Icon">ğŸ›ï¸</div><span class="phase-tag">III. è™›æ“¬æ–æ¡¿èˆ‡ç²¾ç´°åŒ–æ§åˆ¶</span><div class="core-content"><strong>æ ¸å¿ƒå…§å®¹ï¼š</strong><ul><li>ä½¿ç”¨ HTML `Canvas` è£½ä½œæ–æ¡¿ç•«å¸ƒå€åŸŸå’Œæ‰‹æŸ„ï¼ˆä½¿ç”¨ JS ç¹ªåœ–ï¼‰ã€‚</li><li>å¯¦ä½œæ–æ¡¿æ‰‹æŸ„åœ¨ç•«å¸ƒå…§è·Ÿéš¨ç§»å‹•ï¼Œä¸¦åœ¨é¬†æ‰‹æ™‚è‡ªå‹•å›åˆ°ä¸­å¿ƒã€‚</li></ul></div><button id="action-btn-C1_L5" class="action-btn bg-gray-400 text-white" disabled>è¼‰å…¥ä¸­...</button></div>
            </div>

            <div class="lesson-card" id="lesson-C1_L6" data-course-id="bee4arc4" data-course-name="æ–æ¡¿åº§æ¨™åˆ° API æŒ‡ä»¤çš„æ•¸å­¸è½‰æ›" data-course-price="1200" data-classroom-url="https://classroom.google.com/c/ODIxNzY4NDM1NzU0?cjc=bee4arc4">
                <div class="lesson-header"><h2>ç¬¬ 6 èª²ï¼šæ–æ¡¿åº§æ¨™åˆ° API æŒ‡ä»¤çš„æ•¸å­¸è½‰æ› <span class="duration">(3H)</span></h2></div>
                <div class="lesson-body"><div class="lesson-icon" title="Math Icon">ğŸ”¢</div><span class="phase-tag">III. è™›æ“¬æ–æ¡¿èˆ‡ç²¾ç´°åŒ–æ§åˆ¶</span><div class="core-content"><strong>æ ¸å¿ƒå…§å®¹ï¼š</strong><ul><li>ç·šæ€§æ˜ å°„åŸç†ï¼šå°‡ç•«å¸ƒ X/Y åƒç´ ç¯„åœï¼Œè½‰æ›ç‚ºé€Ÿåº¦/è½‰å‘æ•¸å€¼ç¯„åœï¼ˆ0-255ï¼‰ã€‚</li><li>å·®é€Ÿæ•¸æ“šè¨ˆç®—ï¼šå»ºç«‹å°‡ X/Y åº§æ¨™è½‰æ›ç‚ºé€Ÿåº¦/è½‰å‘æŒ‡ä»¤ (CMD, F, V ç­‰) çš„ JS é‚è¼¯ã€‚</li></ul></div><button id="action-btn-C1_L6" class="action-btn bg-gray-400 text-white" disabled>è¼‰å…¥ä¸­...</button></div>
            </div>

            <div class="lesson-card" id="lesson-C1_L7" data-course-id="ks3fg46c" data-course-name="å®šæ™‚å™¨èˆ‡é€£çºŒæ•¸æ“šç™¼é€" data-course-price="1200" data-classroom-url="https://classroom.google.com/c/ODM2NzU4NzczMDc3?cjc=ks3fg46c">
                <div class="lesson-header"><h2>ç¬¬ 7 èª²ï¼šå®šæ™‚å™¨èˆ‡é€£çºŒæ•¸æ“šç™¼é€ <span class="duration">(3H)</span></h2></div>
                <div class="lesson-body"><div class="lesson-icon" title="Timer Icon">â±ï¸</div><span class="phase-tag">III. è™›æ“¬æ–æ¡¿èˆ‡ç²¾ç´°åŒ–æ§åˆ¶</span><div class="core-content"><strong>æ ¸å¿ƒå…§å®¹ï¼š</strong><ul><li>ä»‹ç´¹ `setInterval` èˆ‡ `requestAnimationFrame` åœ¨å³æ™‚æ§åˆ¶ä¸­çš„ä½œç”¨ã€‚</li><li>è¨­å®š `setInterval` (å¦‚ 50ms é–“éš”)ï¼Œé€±æœŸæ€§å‘¼å«æ–æ¡¿æ•¸æ“šç™¼é€ç¨‹åºã€‚</li></ul></div><button id="action-btn-C1_L7" class="action-btn bg-gray-400 text-white" disabled>è¼‰å…¥ä¸­...</button></div>
            </div>

            <div class="lesson-card" id="lesson-C1_L8" data-course-id="r7cnaf4t" data-course-name="Wi-Fi (HTTP) é€šè¨Šèˆ‡ Fetch API" data-course-price="1200" data-classroom-url="https://classroom.google.com/c/ODM2NzU2NjA4NjMx?cjc=r7cnaf4t">
                <div class="lesson-header"><h2>ç¬¬ 8 èª²ï¼šWi-Fi (HTTP) é€šè¨Šèˆ‡ Fetch API <span class="duration">(3H)</span></h2></div>
                <div class="lesson-body"><div class="lesson-icon" title="WiFi Icon">ğŸ“¶</div><span class="phase-tag">IV. Wi-Fi é€šè¨Šèˆ‡é›™æ¨¡å¼æ•´åˆ</span><div class="core-content"><strong>æ ¸å¿ƒå…§å®¹ï¼š</strong><ul><li>ä»‹ç´¹ç¾ä»£ JS çš„ `fetch` ç”¨æ–¼ç™¼é€ HTTP è«‹æ±‚ã€‚</li><li>å¯¦ä½œ Wi-Fi æ¨¡å¼ä¸‹çš„æ¸¬è©¦æŒ‰éˆ•ï¼Œç™¼é€ HTTP è«‹æ±‚æ§åˆ¶ä¸»æ§æ¿ã€‚</li></ul></div><button id="action-btn-C1_L8" class="action-btn bg-gray-400 text-white" disabled>è¼‰å…¥ä¸­...</button></div>
            </div>

            <div class="lesson-card" id="lesson-C1_L9" data-course-id="wlilo4dc" data-course-name="é›™æ¨¡å¼é™æ§å™¨è¨­è¨ˆèˆ‡ç‹€æ…‹åˆ‡æ›" data-course-price="1200" data-classroom-url="https://classroom.google.com/c/ODM2NzU4NzI3MDY5?cjc=wlilo4dc">
                <div class="lesson-header"><h2>ç¬¬ 9 èª²ï¼šé›™æ¨¡å¼é™æ§å™¨è¨­è¨ˆèˆ‡ç‹€æ…‹åˆ‡æ› <span class="duration">(3H)</span></h2></div>
                <div class="lesson-body"><div class="lesson-icon" title="Toggle Icon">ğŸ”„</div><span class="phase-tag">IV. Wi-Fi é€šè¨Šèˆ‡é›™æ¨¡å¼æ•´åˆ</span><div class="core-content"><strong>æ ¸å¿ƒå…§å®¹ï¼š</strong><ul><li>è¨­è¨ˆä¸€å€‹å¯åˆ‡æ›çš„ç•Œé¢ï¼Œå®¹ç´ BLE é€£ç·šå’Œ Wi-Fi è¨­å®š (IP è¼¸å…¥)ã€‚</li><li>å¯¦ä½œæ ¹æ“šç•¶å‰æ¨¡å¼ï¼Œæ§åˆ¶æŒ‡ä»¤é€é BLE æˆ– Wi-Fi ç™¼é€çš„é‚è¼¯ã€‚</li></ul></div><button id="action-btn-C1_L9" class="action-btn bg-gray-400 text-white" disabled>è¼‰å…¥ä¸­...</button></div>
            </div>

            <div class="lesson-card" 
                 id="lesson-C1_L10" 
                 data-course-id="idzxwgbc" 
                 data-course-name="å°ˆæ¡ˆå„ªåŒ–ã€éŒ¯èª¤è™•ç†èˆ‡æœ€çµ‚å±•ç¤º" 
                 data-course-price="0"
                 data-classroom-url="https://classroom.google.com/c/ODIxNzY4MzIyNjgy?cjc=idzxwgbc">
                <div class="lesson-header">
                    <h2>ç¬¬ 10 èª²ï¼šå°ˆæ¡ˆå„ªåŒ–ã€éŒ¯èª¤è™•ç†èˆ‡æœ€çµ‚å±•ç¤º <span class="duration">(3H)</span></h2>
                </div>
                <div class="lesson-body">
                    <div class="lesson-icon" title="Final Project Icon">âœ…</div>
                    <span class="phase-tag">V. ç¶œåˆæ‡‰ç”¨èˆ‡é™¤éŒ¯</span>
                    <div class="core-content">
                        <strong>æ ¸å¿ƒå…§å®¹ï¼š</strong>
                        <ul>
                            <li>éŒ¯èª¤è™•ç†ï¼šå¢åŠ é€£ç·šéŒ¯èª¤ã€Web BLE ä¸å¯ç”¨ã€`fetch` å¤±æ•—ç­‰éŒ¯èª¤æç¤ºã€‚</li>
                            <li>ç•Œé¢å„ªåŒ–ï¼šæœ€çµ‚ç•Œé¢ç¾åŒ–ã€æ–æ¡¿åƒæ•¸å¾®èª¿ã€éŸ¿æ‡‰å¼å„ªåŒ–ã€‚</li>
                            <li>å°ˆæ¡ˆç¸½çµï¼šç•¢æ¥­ä½œå“å±•ç¤ºèˆ‡åˆ†äº«ã€‚</li>
                        </ul>
                    </div>
                    <button id="action-btn-C1_L10" class="action-btn bg-gray-400 text-white" disabled>
                        è¼‰å…¥ä¸­...
                    </button>
                </div>
            </div>
            
        </div>
    </div>

    <script type="module">

        // 1. åŒ¯å…¥å¿…è¦çš„ Firebase å‡½å¼
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js"; 
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-functions.js";

        // 2. Firebase é…ç½®
        const firebaseConfig = {
          apiKey: "AIzaSyCO6Y6Pa7b7zbieJIErysaNF6-UqbT8KJw",
          authDomain: "e-learning-942f7.firebaseapp.com",
          projectId: "e-learning-942f7",
          storageBucket: "e-learning-942f7.firebasestorage.app",
          messagingSenderId: "878397058574",
          appId: "1:878397058574:web:28aaa07a291ee3baab165f"
        };

        // 3. åˆå§‹åŒ– Firebase æœå‹™
        const app = initializeApp(firebaseConfig);        
        const auth = getAuth(app);           
        const functions = getFunctions(app, 'asia-east1');         
        const checkAuthFunction = httpsCallable(functions, 'checkPaymentAuthorization');
        const CART_URL = 'cart.html'; 
        const AUTH_URL = 'auth.html'; 

        // ===============================================
        // A. è³¼ç‰©è»Šæ ¸å¿ƒé‚è¼¯ (åƒ…è™•ç†å­˜å„²ï¼Œç„¡æç¤º/è·³è½‰)
        // ===============================================
        function addToCart(productId, productName, productPrice) {
            let cart = JSON.parse(localStorage.getItem('vibeCodingCart') || '{}');
            const priceNum = parseInt(productPrice, 10);
            
            // æª¢æŸ¥å•†å“æ˜¯å¦å·²å­˜åœ¨
            if (cart[productId]) {
                return { success: false, message: `ã€Œ${productName}ã€å·²åœ¨è³¼ç‰©è»Šä¸­ï¼` };
            }
            
            // å°‡å•†å“åŠ å…¥è³¼ç‰©è»Š
            cart[productId] = { 
                name: productName, 
                price: priceNum, 
                quantity: 1 
            };
            localStorage.setItem('vibeCodingCart', JSON.stringify(cart));
            
            return { success: true, message: `ã€Œ${productName}ã€å·²æˆåŠŸåŠ å…¥è³¼ç‰©è»Šï¼` };
        }


        // ===============================================
        // B. è³¼ç‰©è»Šç¢ºèªæµç¨‹ (èˆ‡ basic.html ä¿æŒä¸€è‡´)
        // ===============================================
        function handleAddToCartConfirmation(courseId, courseName, coursePrice) {
            const cart = JSON.parse(localStorage.getItem('vibeCodingCart') || '{}');
            
            // 1. é å…ˆæª¢æŸ¥è³¼ç‰©è»Šï¼Œå¦‚æœå·²å­˜åœ¨ï¼Œåªå½ˆå‡º alert æé†’
            if (cart[courseId]) {
                alert(`âš ï¸ ã€Œ${courseName}ã€å·²åœ¨è³¼ç‰©è»Šä¸­ï¼`);
                return; // çµæŸå‡½å¼ï¼Œåœç•™åœ¨åŸé é¢
            }
            
            // 2. åªæœ‰ç•¶å•†å“ä¸å­˜åœ¨æ™‚ï¼Œæ‰åŸ·è¡Œ confirm æ­¥é©Ÿ
            const priceText = `NT$ ${parseInt(coursePrice, 10).toLocaleString()}`;
            
            const isConfirmed = confirm(`æ‚¨ç¢ºå®šè¦å°‡èª²ç¨‹ã€Œ${courseName}ã€åŠ å…¥è³¼ç‰©è»Šå—ï¼Ÿ\n\nåƒ¹æ ¼ï¼š${priceText}`);

            if (isConfirmed) {
                // å¦‚æœä½¿ç”¨è€…æŒ‰ä¸‹ã€Œç¢ºå®šã€
                const result = addToCart(courseId, courseName, coursePrice);
            } 
        }

        // ===============================================
        // C. ç™»å…¥/ç™»å‡ºé‚è¼¯ (ä¸è®Š)
        // ===============================================
        async function handleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("ç™»å…¥å¤±æ•—:", error);
            }
        }

        async function handleLogout() {
            await signOut(auth);
        }

        // ===============================================
        // D. å‹•æ…‹æŒ‰éˆ•ç‹€æ…‹æ›´æ–°æ ¸å¿ƒé‚è¼¯
        // ===============================================
        
        const lessonCards = document.querySelectorAll('.lesson-card');

        /**
         * æ ¹æ“šæˆæ¬Šç‹€æ…‹æ›´æ–°å–®ä¸€èª²ç¨‹å¡ç‰‡çš„æŒ‰éˆ•
         */
        function updateCardAction(cardElement, status) {
            const btn = cardElement.querySelector('.action-btn');
            const courseId = cardElement.dataset.courseId;
            const courseName = cardElement.dataset.courseName;
            const coursePrice = cardElement.dataset.coursePrice; // é—œéµï¼šåƒ¹æ ¼åƒæ•¸
            const classroomUrl = cardElement.dataset.classroomUrl;
            const isFreeCourse = parseInt(coursePrice, 10) === 0; 
            const priceText = `NT$ ${parseInt(coursePrice, 10).toLocaleString()}`; 

            // æ¸…é™¤æ‰€æœ‰èˆŠçš„äº‹ä»¶ç›£è½å™¨
            btn.onclick = null; 
            btn.disabled = false;

            if (status === 'AUTHORIZED') {
                // ç‹€æ…‹ 1: å·²æˆæ¬Š -> é€²å…¥èª²ç¨‹
                btn.textContent = 'âœ… é€²å…¥èª²ç¨‹å…§å®¹';
                btn.className = 'action-btn bg-blue-600 hover:bg-blue-700 text-white';
                btn.onclick = () => {
                    // å‚³é courseId å’Œ coursePrice çµ¦ auth.html 
                    window.location.href = `${AUTH_URL}?url=${encodeURIComponent(classroomUrl)}&id=${courseId}&price=${coursePrice}`;
                };
            } else if (status === 'UNAUTHORIZED') {
                // ç‹€æ…‹ 2: å·²ç™»å…¥ä½†æœªè³¼è²· (ä¸»è¦é‡å°æ”¶è²»èª²ç¨‹)
                
                if (isFreeCourse) {
                    // å…è²»èª²ç¨‹å‡ºç¾ UNAUTHORIZED è¦–ç‚ºç•°å¸¸
                    btn.textContent = 'â›” æˆæ¬ŠéŒ¯èª¤ (è«‹è¯ç¹«å®¢æœ)';
                    btn.className = 'action-btn bg-red-600 hover:bg-red-700 text-white';
                    btn.onclick = () => window.location.reload(); 
                } else {
                    // æ”¶è²»èª²ç¨‹ï¼šå¼•å°åŠ å…¥è³¼ç‰©è»Š (é»æ“Šå¾Œé€²å…¥ç¢ºèªæµç¨‹)
                    btn.textContent = `ğŸ›’ åŠ å…¥è³¼ç‰©è»Š (${priceText})`;
                    btn.className = 'action-btn bg-indigo-600 hover:bg-indigo-700 text-white';
                    btn.onclick = () => {
                        handleAddToCartConfirmation(courseId, courseName, coursePrice); 
                    };
                }
            } else if (status === 'NOT_LOGGED_IN') {
                // ç‹€æ…‹ 3: æœªç™»å…¥

                if (isFreeCourse) {
                    // å…è²»èª²ç¨‹ï¼šå¼•å°ç™»å…¥
                    btn.textContent = 'ğŸ‘¤ è«‹å…ˆç™»å…¥ä»¥é€²å…¥èª²ç¨‹ (å…è²»)';
                    btn.className = 'action-btn bg-indigo-600 hover:bg-indigo-700 text-white';
                    btn.onclick = handleLogin;
                } else {
                    // æ”¶è²»èª²ç¨‹ï¼šå¼•å°åŠ å…¥è³¼ç‰©è»Š (é»æ“Šå¾Œé€²å…¥ç¢ºèªæµç¨‹)
                    btn.textContent = `ğŸ›’ åŠ å…¥è³¼ç‰©è»Š (${priceText})`;
                    btn.className = 'action-btn bg-indigo-600 hover:bg-indigo-700 text-white';
                    btn.onclick = () => {
                        handleAddToCartConfirmation(courseId, courseName, coursePrice); 
                    };
                }

            } else if (status === 'LOADING') {
                // ç‹€æ…‹ 4: è¼‰å…¥ä¸­
                btn.textContent = 'æ¬Šé™æª¢æŸ¥ä¸­...';
                btn.className = 'action-btn bg-gray-400 text-white';
                btn.disabled = true;
            } else if (status === 'ERROR') {
                // éŒ¯èª¤ç‹€æ…‹ (æ”¶è²»èª²ç¨‹ CF æª¢æŸ¥å¤±æ•—ï¼Œå°å‘ UNAUTHORIZED æµç¨‹)
                
                if (isFreeCourse) {
                    // å…è²»èª²ç¨‹ï¼šèˆ‡ NOT_LOGGED_IN é‚è¼¯ç›¸åŒï¼Œå¼•å°ç™»å…¥
                    btn.textContent = 'ğŸ‘¤ è«‹å…ˆç™»å…¥ä»¥é€²å…¥èª²ç¨‹ (å…è²»)';
                    btn.className = 'action-btn bg-indigo-600 hover:bg-indigo-700 text-white';
                    btn.onclick = handleLogin;
                } else {
                    // æ”¶è²»èª²ç¨‹ï¼šå°å‘ UNAUTHORIZED (åŠ å…¥è³¼ç‰©è»Šç¢ºèª)
                    btn.textContent = `ğŸ›’ åŠ å…¥è³¼ç‰©è»Š (${priceText})`;
                    btn.className = 'action-btn bg-indigo-600 hover:bg-indigo-700 text-white';
                    btn.onclick = () => {
                        handleAddToCartConfirmation(courseId, courseName, coursePrice); 
                    };
                }
            }
        }

        /**
         * æª¢æŸ¥å–®ä¸€èª²ç¨‹çš„æˆæ¬Šç‹€æ…‹ (å„ªåŒ–ï¼šå…è²»èª²ç¨‹è·³é Cloud Function)
         */
        async function checkLessonAuthorization(cardElement, user) {
            updateCardAction(cardElement, 'LOADING');

            const courseId = cardElement.dataset.courseId;
            const classroomUrl = cardElement.dataset.classroomUrl;
            const isFreeCourse = parseInt(cardElement.dataset.coursePrice, 10) === 0;

            // ğŸ’¥ ä¿®æ­£ï¼šå…è²»èª²ç¨‹ä¸”ä½¿ç”¨è€…å·²ç™»å…¥ï¼Œç›´æ¥è¦–ç‚º AUTHORIZED (è·³é CF)
            if (isFreeCourse && user) {
                updateCardAction(cardElement, 'AUTHORIZED');
                return; 
            }
            
            // ğŸ’¥ ä¿®æ­£ï¼šå¦‚æœæœªç™»å…¥ï¼Œä¸éœ€è¦å‘¼å« CFï¼Œç›´æ¥å°å‘ NOT_LOGGED_IN
            if (!user) {
                updateCardAction(cardElement, 'NOT_LOGGED_IN');
                return;
            }

            // --- æ”¶è²»èª²ç¨‹æ‰æœƒèµ°åˆ°é€™è£¡ (å‘¼å« CF) ---
            try {
                const result = await checkAuthFunction({ 
                    courseId: courseId, 
                    targetUrl: encodeURIComponent(classroomUrl) 
                });

                const status = result.data.status; 
                updateCardAction(cardElement, status);

            } catch (error) {
                console.error(`èª²ç¨‹ ${courseId} æˆæ¬Šæª¢æŸ¥å¤±æ•—:`, error);
                
                // CF å‘¼å«å¤±æ•—ï¼Œæ”¶è²»èª²ç¨‹å°å‘ UNAUTHORIZED (åŠ å…¥è³¼ç‰©è»Š)
                updateCardAction(cardElement, 'UNAUTHORIZED');
            }
        }

        // ----------------------------------------------------
        // E. ç¸½é«”æˆæ¬Šæµç¨‹æ§åˆ¶å™¨ 
        // ----------------------------------------------------
        onAuthStateChanged(auth, (user) => {
            const userDisplay = document.getElementById('user-display');
            const loginBtn = document.getElementById('login-btn');

            if (user) {
                userDisplay.textContent = `æ‚¨å¥½, ${user.displayName || user.email}`;
                loginBtn.textContent = 'ç™»å‡º';
                loginBtn.onclick = handleLogout;
                
                lessonCards.forEach(card => {
                    checkLessonAuthorization(card, user);
                });
            } else {
                userDisplay.textContent = 'è¨ªå®¢æ¨¡å¼';
                loginBtn.textContent = 'ç™»å…¥';
                loginBtn.onclick = handleLogin;
                
                lessonCards.forEach(card => {
                    // ä¿®æ­£ï¼šæœªç™»å…¥æ™‚ï¼Œç›´æ¥è¨­å®šç‹€æ…‹ï¼Œè®“ updateCardAction è™•ç†å…è²»/æ”¶è²»èª²ç¨‹
                    updateCardAction(card, 'NOT_LOGGED_IN'); 
                });
            }
        });

    </script>
</body>
</html>