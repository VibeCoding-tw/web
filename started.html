<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>入門課程：Web App 遙控器設計與 Web BLE 整合</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 基礎樣式 (使用 Tailwind 的 reset) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f9; color: #333; }
        
        /* 課程網格與卡片 */
        .lesson-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; }
        .lesson-card { 
            background-color: #fff; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); 
            transition: transform 0.3s ease, box-shadow 0.3s ease; 
            height: 100%; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .lesson-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12); 
        }
        .lesson-header { background-color: #e9f0ff; padding: 15px 20px; border-bottom: 2px solid #007bff; }
        .lesson-header h2 { margin: 0; font-size: 1.25em; color: #007bff; }
        .lesson-body { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .lesson-icon { width: 50px; height: 50px; background-color: #007bff; color: #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2em; margin-bottom: 15px; }
        .phase-tag { display: inline-block; background-color: #6c757d; color: #fff; padding: 5px 10px; border-radius: 5px; font-size: 0.8em; margin-bottom: 10px; }
        .core-content { margin-top: 15px; font-size: 0.9em; color: #555; flex-grow: 1;}
        .core-content ul { list-style: disc; padding-left: 20px; margin: 5px 0 0 0; }
        .duration { font-style: italic; color: #666; margin-top: 5px; font-size: 0.9em; display: block; }
        
        /* 動態按鈕樣式 */
        .action-btn { 
            margin-top: 20px; 
            width: 100%; 
            padding: 10px; 
            border-radius: 6px; 
            font-weight: bold; 
            transition: background-color 0.2s;
            cursor: pointer;
        }
    </style>
</head>
<body class="p-5" style="display:none;"> 

    <div id="loading-overlay" class="fixed inset-0 bg-white flex flex-col justify-center items-center z-50">
        <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="mt-4 text-gray-700">正在檢查登入狀態與課程授權...</p>
    </div>
    <div class="container mx-auto">
        <header class="flex justify-between items-center py-4 px-0 border-b mb-6">
            <h1 class="text-3xl font-bold text-indigo-600">📱 入門課程：Web App 遙控器設計與 Web BLE 整合</h1>
            <div class="flex items-center space-x-4">
                
                <a href="cart.html" class="text-gray-600 hover:text-indigo-600 transition duration-150 relative">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.2 4h12.4M15 13H7" />
                    </svg>
                </a>

                <div id="auth-status" class="text-sm flex items-center">
                    <span id="user-display" class="text-gray-600">訪客模式</span>
                    <button id="login-btn" class="ml-3 bg-indigo-500 hover:bg-indigo-600 text-white text-sm py-1 px-3 rounded">登入</button>
                </div>
            </div>
        </header>

        <div class="lesson-grid">
            <div class="lesson-card" 
                 id="lesson-C1_L1" 
                 data-course-id="C1_L1" 
                 data-course-name="HTML/Tailwind CSS 快速入門" 
                 data-course-price="1200"
                 data-classroom-url="https://classroom.google.com/c/ODM1OTE3OTYwMTkw?cjc=72uyaadl&lesson=L1">
                <div class="lesson-header">
                    <h2>第 1 課：HTML/Tailwind CSS 快速入門與 UI/UX 基礎 <span class="duration">(3H)</span></h2>
                </div>
                <div class="lesson-body">
                    <div class="lesson-icon" title="UI/UX Icon">🎨</div>
                    <span class="phase-tag">I. Web App 基礎與 BLE 連線</span>
                    <div class="core-content">
                        <strong>核心內容：</strong>
                        <ul>
                            <li>基礎佈局（Flexbox/Grid）與 Tailwind CSS 應用。</li>
                            <li>遙控器響應式界面設計、行動端觸控考量。</li>
                            <li>實作單一 HTML 檔案，設計連線與狀態顯示區塊。</li>
                        </ul>
                    </div>
                    <button id="action-btn-C1_L1" class="action-btn bg-gray-400 text-white" disabled>
                        載入中...
                    </button>
                </div>
            </div>

            <div class="lesson-card" 
                 id="lesson-C1_L2" 
                 data-course-id="C1_L2" 
                 data-course-name="Web BLE 客戶端連線邏輯" 
                 data-course-price="1200"
                 data-classroom-url="https://classroom.google.com/c/ODM1OTE3OTYwMTkw?cjc=72uyaadl&lesson=L2">
                <div class="lesson-header">
                    <h2>第 2 課：Web BLE 客戶端連線邏輯實作 <span class="duration">(3H)</span></h2>
                </div>
                <div class="lesson-body">
                    <div class="lesson-icon" title="Bluetooth Icon">🔗</div>
                    <span class="phase-tag">I. Web App 基礎與 BLE 連線</span>
                    <div class="core-content">
                        <strong>核心內容：</strong>
                        <ul>
                            <li>介紹 JavaScript Web BLE API：`navigator.bluetooth` 與權限模型。</li>
                            <li>實作 `requestDevice`、`gatt.connect`、服務與特徵值 (UUID) 處理。</li>
                            <li>實現連線/斷開按鈕功能，使用 JS 監聽連線狀態。</li>
                        </ul>
                    </div>
                    <button id="action-btn-C1_L2" class="action-btn bg-gray-400 text-white" disabled>
                        載入中...
                    </button>
                </div>
            </div>
            
            <div class="lesson-card" 
                 id="lesson-C1_L3" 
                 data-course-id="C1_L3" 
                 data-course-name="基礎按鈕控制與 API 數據格式化" 
                 data-course-price="1200"
                 data-classroom-url="https://classroom.google.com/c/ODM1OTE3OTYwMTkw?cjc=72uyaadl&lesson=L3">
                <div class="lesson-header">
                    <h2>第 3 課：基礎按鈕控制與 API 數據格式化 <span class="duration">(3H)</span></h2>
                </div>
                <div class="lesson-body">
                    <div class="lesson-icon" title="Control Icon">🕹️</div>
                    <span class="phase-tag">II. 按鈕控制與 API 數據封包</span>
                    <div class="core-content">
                        <strong>核心內容：</strong>
                        <ul>
                            <li>數據封包設計：將按鈕事件轉換為 API 字串格式（如 CMD, F, 180）。</li>
                            <li>Web BLE 寫入實作：使用 `characteristic.writeValue` 發送指令。</li>
                            <li>實作前、後、左、右、停止五個按鈕，實現馬達基本控制。</li>
                        </ul>
                    </div>
                    <button id="action-btn-C1_L3" class="action-btn bg-gray-400 text-white" disabled>
                        載入中...
                    </button>
                </div>
            </div>
            
            <div class="lesson-card" 
                 id="lesson-C1_L4" 
                 data-course-id="C1_L4" 
                 data-course-name="觸控事件優化：長按與放開" 
                 data-course-price="1200"
                 data-classroom-url="https://classroom.google.com/c/ODM1OTE3OTYwMTkw?cjc=72uyaadl&lesson=L4">
                <div class="lesson-header">
                    <h2>第 4 課：觸控事件優化：長按與放開 <span class="duration">(3H)</span></h2>
                </div>
                <div class="lesson-body">
                    <div class="lesson-icon" title="Touch Icon">👆</div>
                    <span class="phase-tag">II. 按鈕控制與 API 數據封包</span>
                    <div class="core-content">
                        <strong>核心內容：</strong>
                        <ul>
                            <li>區分原生觸控事件：`mousedown/mouseup` 和 `touchstart/touchend`。</li>
                            <li>實現長按發送持續移動指令，放開發送停止指令（使用 `setInterval`）。</li>
                            <li>利用觸控事件優化控制按鈕的靈敏度與即時性。</li>
                        </ul>
                    </div>
                    <button id="action-btn-C1_L4" class="action-btn bg-gray-400 text-white" disabled>
                        載入中...
                    </button>
                </div>
            </div>

            <div class="lesson-card" 
                 id="lesson-C1_L5" 
                 data-course-id="C1_L5" 
                 data-course-name="虛擬搖桿 UI 製作與座標擷取" 
                 data-course-price="1200"
                 data-classroom-url="https://classroom.google.com/c/ODM1OTE3OTYwMTkw?cjc=72uyaadl&lesson=L5">
                <div class="lesson-header">
                    <h2>第 5 課：虛擬搖桿 UI 製作與座標擷取 <span class="duration">(3H)</span></h2>
                </div>
                <div class="lesson-body">
                    <div class="lesson-icon" title="Canvas Icon">🎛️</div>
                    <span class="phase-tag">III. 虛擬搖桿與精細化控制</span>
                    <div class="core-content">
                        <strong>核心內容：</strong>
                        <ul>
                            <li>使用 HTML `Canvas` 製作搖桿畫布區域和手柄（使用 JS 繪圖）。</li>
                            <li>學習在搖桿拖曳時，即時擷取 X/Y 座標並限制移動範圍。</li>
                            <li>實作搖桿手柄在畫布內跟隨移動，並在鬆手時自動回到中心。</li>
                        </ul>
                    </div>
                    <button id="action-btn-C1_L5" class="action-btn bg-gray-400 text-white" disabled>
                        載入中...
                    </button>
                </div>
            </div>

            <div class="lesson-card" 
                 id="lesson-C1_L6" 
                 data-course-id="C1_L6" 
                 data-course-name="搖桿座標到 API 指令的數學轉換" 
                 data-course-price="1200"
                 data-classroom-url="https://classroom.google.com/c/ODM1OTE3OTYwMTkw?cjc=72uyaadl&lesson=L6">
                <div class="lesson-header">
                    <h2>第 6 課：搖桿座標到 API 指令的數學轉換 <span class="duration">(3H)</span></h2>
                </div>
                <div class="lesson-body">
                    <div class="lesson-icon" title="Math Icon">🔢</div>
                    <span class="phase-tag">III. 虛擬搖桿與精細化控制</span>
                    <div class="core-content">
                        <strong>核心內容：</strong>
                        <ul>
                            <li>線性映射原理：將畫布 X/Y 像素範圍，轉換為速度/轉向數值範圍（0-255）。</li>
                            <li>差速數據計算：建立將 X/Y 座標轉換為速度/轉向指令 (CMD, F, V 等) 的 JS 邏輯。</li>
                            <li>實作將 X/Y 座標轉換為 API 數據的 JS 函式。</li>
                        </ul>
                    </div>
                    <button id="action-btn-C1_L6" class="action-btn bg-gray-400 text-white" disabled>
                        載入中...
                    </button>
                </div>
            </div>

            <div class="lesson-card" 
                 id="lesson-C1_L7" 
                 data-course-id="C1_L7" 
                 data-course-name="定時器與連續數據發送" 
                 data-course-price="1200"
                 data-classroom-url="https://classroom.google.com/c/ODM1OTE3OTYwMTkw?cjc=72uyaadl&lesson=L7">
                <div class="lesson-header">
                    <h2>第 7 課：定時器與連續數據發送 <span class="duration">(3H)</span></h2>
                </div>
                <div class="lesson-body">
                    <div class="lesson-icon" title="Timer Icon">⏱️</div>
                    <span class="phase-tag">III. 虛擬搖桿與精細化控制</span>
                    <div class="core-content">
                        <strong>核心內容：</strong>
                        <ul>
                            <li>介紹 `setInterval` 與 `requestAnimationFrame` 在即時控制中的作用。</li>
                            <li>設定 `setInterval` (如 50ms 間隔)，週期性呼叫搖桿數據發送程序。</li>
                            <li>整合搖桿、轉換邏輯與定時器，實現流暢、低延遲的 BLE 搖桿控制。</li>
                        </ul>
                    </div>
                    <button id="action-btn-C1_L7" class="action-btn bg-gray-400 text-white" disabled>
                        載入中...
                    </button>
                </div>
            </div>

            <div class="lesson-card" 
                 id="lesson-C1_L8" 
                 data-course-id="C1_L8" 
                 data-course-name="Wi-Fi (HTTP) 通訊與 Fetch API" 
                 data-course-price="1200"
                 data-classroom-url="https://classroom.google.com/c/ODM1OTE3OTYwMTkw?cjc=72uyaadl&lesson=L8">
                <div class="lesson-header">
                    <h2>第 8 課：Wi-Fi (HTTP) 通訊與 Fetch API <span class="duration">(3H)</span></h2>
                </div>
                <div class="lesson-body">
                    <div class="lesson-icon" title="WiFi Icon">📶</div>
                    <span class="phase-tag">IV. Wi-Fi 通訊與雙模式整合</span>
                    <div class="core-content">
                        <strong>核心內容：</strong>
                        <ul>
                            <li>介紹現代 JS 的 `fetch` 用於發送 HTTP 請求。</li>
                            <li>學習構造主控板要求的 HTTP GET 請求 URL（如 `http://[IP]/control?cmd=F&val=180`）。</li>
                            <li>實作 Wi-Fi 模式下的測試按鈕，發送 HTTP 請求控制主控板。</li>
                        </ul>
                    </div>
                    <button id="action-btn-C1_L8" class="action-btn bg-gray-400 text-white" disabled>
                        載入中...
                    </button>
                </div>
            </div>

            <div class="lesson-card" 
                 id="lesson-C1_L9" 
                 data-course-id="C1_L9" 
                 data-course-name="雙模式遙控器設計與狀態切換" 
                 data-course-price="1200"
                 data-classroom-url="https://classroom.google.com/c/ODM1OTE3OTYwMTkw?cjc=72uyaadl&lesson=L9">
                <div class="lesson-header">
                    <h2>第 9 課：雙模式遙控器設計與狀態切換 <span class="duration">(3H)</span></h2>
                </div>
                <div class="lesson-body">
                    <div class="lesson-icon" title="Toggle Icon">🔄</div>
                    <span class="phase-tag">IV. Wi-Fi 通訊與雙模式整合</span>
                    <div class="core-content">
                        <strong>核心內容：</strong>
                        <ul>
                            <li>設計一個可切換的界面，容納 BLE 連線和 Wi-Fi 設定 (IP 輸入)。</li>
                            <li>學習使用 JS 變數追蹤當前模式（BLE 或 Wi-Fi）。</li>
                            <li>實作根據當前模式，控制指令透過 BLE 或 Wi-Fi 發送的邏輯。</li>
                        </ul>
                    </div>
                    <button id="action-btn-C1_L9" class="action-btn bg-gray-400 text-white" disabled>
                        載入中...
                    </button>
                </div>
            </div>

            <div class="lesson-card" 
                 id="lesson-C1_L10" 
                 data-course-id="C1_L10" 
                 data-course-name="專案優化、錯誤處理與最終展示" 
                 data-course-price="1200"
                 data-classroom-url="https://classroom.google.com/c/ODM1OTE3OTYwMTkw?cjc=72uyaadl&lesson=L10">
                <div class="lesson-header">
                    <h2>第 10 課：專案優化、錯誤處理與最終展示 <span class="duration">(3H)</span></h2>
                </div>
                <div class="lesson-body">
                    <div class="lesson-icon" title="Final Project Icon">✅</div>
                    <span class="phase-tag">V. 綜合應用與除錯</span>
                    <div class="core-content">
                        <strong>核心內容：</strong>
                        <ul>
                            <li>錯誤處理：增加連線錯誤、Web BLE 不可用、`fetch` 失敗等錯誤提示。</li>
                            <li>界面優化：最終界面美化、搖桿參數微調、響應式優化。</li>
                            <li>專案總結：畢業作品展示與分享。</li>
                        </ul>
                    </div>
                    <button id="action-btn-C1_L10" class="action-btn bg-gray-400 text-white" disabled>
                        載入中...
                    </button>
                </div>
            </div>
            
        </div>
    </div>

    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js"; 
        //import { initializeApp } from "firebase/app";
        //import { getAnalytics } from "firebase/analytics";
        // TODO: Add SDKs for Firebase products that you want to use
        // https://firebase.google.com/docs/web/setup#available-libraries

        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyBv2fciGdUD4CifE1fH3hnzzamPdrvjjN8",
            authDomain: "onlinelearning-b5cfc.firebaseapp.com",
            projectId: "onlinelearning-b5cfc",
            storageBucket: "onlinelearning-b5cfc.firebasestorage.app",
            messagingSenderId: "505254683984",
            appId: "1:505254683984:web:031af498f936c0deedf855",
            measurementId: "G-0DNEBM6CG4"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
/*
        // 1. 匯入必要的 Firebase 函式
        // 🚨 建議改為官方穩定版 (例如 v10.x.x 或 v11.x.x)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js"; 
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, signOut, getRedirectResult } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-functions.js";
        //import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js"; 
        //import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithRedirect, signOut, getRedirectResult } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        //import { getFunctions, httpsCallable } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-functions.js";


        // 2. 您的 Firebase 配置 
        const firebaseConfig = {
            apiKey: "AIzaSyBv2fciGdUD4CifE1fH3hnzzamPdrvjjN8",
            authDomain: "onlinelearning-b5cfc.firebaseapp.com",
            projectId: "onlinelearning-b5cfc",
            storageBucket: "onlinelearning-b5cfc.firebasestorage.app",
            messagingSenderId: "505254683984",
            appId: "1:505254683984:web:9653dfa4eef54899cedf855",
            measurementId: "G-P5LQ23Y31Q"
        };

        // 3. 初始化 Firebase 服務
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
*/
        const functions = getFunctions(app, 'asia-east1'); 
        
        const checkAuthFunction = httpsCallable(functions, 'checkPaymentAuthorization');

        const CART_URL = 'cart.html'; 
        const AUTH_URL = 'auth.html'; 
        
        const bodyElement = document.body; 
        // 🚨 新增：取得載入提示區塊
        const loadingOverlay = document.getElementById('loading-overlay');

        // ===============================================
        // A. 購物車核心邏輯
        // ===============================================
        function addToCart(productId, productName, productPrice) {
            let cart = JSON.parse(localStorage.getItem('vibeCodingCart') || '{}');
            const priceNum = parseInt(productPrice, 10);
            
            if (!cart[productId]) {
                cart[productId] = { 
                    name: productName, 
                    price: priceNum, 
                    quantity: 1 
                };
                localStorage.setItem('vibeCodingCart', JSON.stringify(cart));
                alert(`「${productName}」已加入購物車！`);
            } else {
                 alert(`「${productName}」已在購物車中！`);
            }
            window.location.href = CART_URL; 
        }

        // ===============================================
        // B. 登入/登出邏輯 (使用 Redirect)
        // ===============================================        
        async function handleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                // 點擊登入後，先顯示載入提示
                loginBtn.disabled = true; 
                loadingOverlay.style.display = 'flex';
                await signInWithRedirect(auth, provider);
            } catch (error) {
                console.error("登入失敗:", error);
                loadingOverlay.style.display = 'none'; // 失敗時隱藏載入提示
                alert("登入流程啟動失敗，請稍後再試。");
            }
        }

        async function handleLogout() {
            await signOut(auth);
        }

        async function handleRedirectResult() {
            try {
                const result = await getRedirectResult(auth);
                if (result) {
                    console.log("登入成功 (Redirect Result):", result.user.displayName);
                }
            } catch (error) {
                console.error("登入失敗 (Redirect Error):", error);
                alert(`登入失敗：${error.message}。請嘗試重新登入。`);
            }
        }
        
        handleRedirectResult();


        // ===============================================
        // C. 動態按鈕狀態更新核心邏輯
        // ===============================================
        
        const lessonCards = document.querySelectorAll('.lesson-card');

        function updateCardAction(cardElement, status) {
            const btn = cardElement.querySelector('.action-btn');
            const courseId = cardElement.dataset.courseId;
            const courseName = cardElement.dataset.courseName;
            const coursePrice = cardElement.dataset.coursePrice;
            const classroomUrl = cardElement.dataset.classroomUrl;
            const priceText = `NT$ ${parseInt(coursePrice, 10).toLocaleString()}`; 

            btn.onclick = null; 
            btn.disabled = false;

            if (status === 'AUTHORIZED') {
                btn.textContent = '✅ 進入課程內容';
                btn.className = 'action-btn bg-blue-600 hover:bg-blue-700 text-white';
                btn.onclick = () => {
                    const redirectUrl = `${AUTH_URL}?url=${encodeURIComponent(classroomUrl)}`;
                    window.location.href = redirectUrl;
                };
            } else if (status === 'UNAUTHORIZED') {
                btn.textContent = `🛒 加入購物車 (${priceText})`;
                btn.className = 'action-btn bg-green-600 hover:bg-green-700 text-white';
                btn.onclick = () => {
                    addToCart(courseId, courseName, coursePrice); 
                };
            } else if (status === 'NOT_LOGGED_IN') {
                btn.textContent = `👤 登入後可購買 (${priceText})`;
                btn.className = 'action-btn bg-indigo-600 hover:bg-indigo-700 text-white';
                btn.onclick = handleLogin;
            } else if (status === 'LOADING') {
                btn.textContent = '權限檢查中...';
                btn.className = 'action-btn bg-gray-400 text-white';
                btn.disabled = true;
            } else if (status === 'ERROR') {
                btn.textContent = '錯誤: 點擊重新載入';
                btn.className = 'action-btn bg-red-600 hover:bg-red-700 text-white';
                btn.onclick = () => window.location.reload();
            }
        }

        async function checkLessonAuthorization(cardElement, user) {
            if (!user) return; 

            updateCardAction(cardElement, 'LOADING');

            const courseId = cardElement.dataset.courseId;
            const classroomUrl = cardElement.dataset.classroomUrl;

            try {
                const result = await checkAuthFunction({ 
                    courseId: courseId, 
                    targetUrl: encodeURIComponent(classroomUrl) 
                });

                const status = result.data.status; 
                updateCardAction(cardElement, status);

            } catch (error) {
                console.error(`課程 ${courseId} 授權檢查失敗:`, error);
                //updateCardAction(cardElement, 'UNAUTHORIZED');
                // 🚨 修正點：錯誤可能來自網路、Functions 錯誤，不應一律視為 UNAUTHORIZED
                if (error.code) { // 檢查 Firebase Functions 錯誤碼
                    updateCardAction(cardElement, 'ERROR');
                } else {
                    // 可能是網路錯誤，可以重試
                    updateCardAction(cardElement, 'ERROR'); 
                }
            }
        }

        // ----------------------------------------------------
        // D. 總體授權流程控制器
        // ----------------------------------------------------
        const userDisplay = document.getElementById('user-display');
        const loginBtn = document.getElementById('login-btn');
        onAuthStateChanged(auth, (user) => {
            // 💥 新增的診斷日誌 💥
            console.log("--- Firebase Auth State Changed ---");
            if (user) {
                console.log("用戶已登入 (User is logged in):", user.uid, user.displayName, user.email);
            } else {
                console.log("用戶未登入 (User is NOT logged in)");
            }
            console.log("----------------------------------");
            // 💥 結束 💥
            loginBtn.disabled = false; // 恢復按鈕

            if (user) {
                userDisplay.textContent = `您好, ${user.displayName || user.email}`;
                loginBtn.textContent = '登出';
                loginBtn.onclick = handleLogout;
                
                lessonCards.forEach(card => {
                    checkLessonAuthorization(card, user);
                });
            } else {
                userDisplay.textContent = '訪客模式';
                loginBtn.textContent = '登入';
                loginBtn.onclick = handleLogin;
                
                lessonCards.forEach(card => {
                    updateCardAction(card, 'NOT_LOGGED_IN');
                });
            }
            
            // 🚨 修正點 2: 狀態確認完畢後，隱藏載入提示，並顯示 body 內容
            loadingOverlay.style.display = 'none';
            bodyElement.style.display = 'block';
        });

    </script>
</body>
</html>